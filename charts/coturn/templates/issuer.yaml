{{- if and .Values.tls.enabled .Values.tls.certManager.enabled .Values.tls.certManager.issuer.create }}
apiVersion: cert-manager.io/v1
{{- if or (eq .Values.tls.certManager.issuer.kind "Issuer") (eq .Values.tls.certManager.issuer.kind "ClusterIssuer") }}
kind: {{ .Values.tls.certManager.issuer.kind }}
{{- else }}
{{- fail "Unexpected TLS issuer kind; must be either Issuer or ClusterIssuer" }}
{{- end }}

metadata:
  name: {{ .Values.tls.certManager.issuer.name }}
  {{- if eq .Values.tls.certManager.issuer.kind "Issuer" }}
  namespace: {{ .Release.Namespace }}
  {{- end }}
  labels:
    chart: {{ .Chart.Name}}-{{ .Chart.Version | replace "+" "_" }}
    release: {{ .Release.Name | quote }}
    heritage: {{ .Release.Service | quote }}

spec:
  acme:
    server: 'https://acme-v02.api.letsencrypt.org/directory'
    {{- if eq .Values.tls.certManager.issuer.certmasterEmail "" }}
    {{- fail "Let's Encrypt account email address is empty" }}
    {{- else }}
    email: {{ .Values.tls.certManager.issuer.certmasterEmail | quote }}
    {{- end }}
    privateKeySecretRef:
      name: coturn-letsencrypt-issuer-account-key
    solvers:
{{ toYaml .Values.tls.certManager.issuer.solverConfiguration | indent 6 }}
{{- end }}
