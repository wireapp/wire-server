# This job fails until the Cassandra created database is reachable. The Helmfile
# deployment can wait for it. This is used to start wire-server deployments only
# with a reachable database.
apiVersion: batch/v1
kind: Job
metadata:
  name: check-cluster-job
  namespace: {{ .Release.Namespace }}
spec:
  template:
    spec:
      containers:
      - name: cassandra
        image: cassandra:3.11
    {{- if not .Values.client_encryption_options.enabled }}
        command: ["cqlsh", "k8ssandra-cluster-datacenter-1-service"]
    {{- else }}
        command: ["cqlsh", "k8ssandra-cluster-datacenter-1-service", "--ssl"]
        env:
          - name: SSL_CERTFILE
            value:  "/certs/ca.pem"
        volumeMounts:
          - name: cassandra-cert
            mountPath: "/certs/ca.pem"
      volumes:
        - name: cassandra-cert
          secret:
            secretName: cassandra-client-ca
    {{- end }}
      restartPolicy: OnFailure
  # Default is 6 retries. 8 is a bit arbitrary, but should be sufficient for
  # low resource environments (e.g. Wire-in-a-box.)
  backoffLimit: 8
