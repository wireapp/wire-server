apiVersion: v1
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: nginz
data:
  nginx.conf: |2
    {{- include "nginz_nginx.conf" . | indent 4 }}
  upstreams.txt: "{{- include "nginz_upstreams.txt" . | trim }}"
  {{- if or (hasKey .Values.nginx_conf "deeplink") }}
  deeplink.json: |2
{{- include "nginz_deeplink.json" . | indent 4 }}
  deeplink.html: |2
{{- include "nginz_deeplink.html" . | indent 4 }}
  {{- end }}

  {{ printf "\n" }}

  {{- range $domain, $config := .Values.nginx_conf.multi_ingress_deeplink }}
  {{- $deeplink_json := printf "%s-deeplink.json" $domain }}
  {{- $deeplink_html := printf "%s-deeplink.html" $domain }}
  {{ $deeplink_json }}: |2
    {{- $deeplink := dict 
      "endpoints" (dict
        "backendURL" $config.endpoints.backendURL
        "backendWSURL" $config.endpoints.backendWSURL
        "blackListURL" $config.endpoints.blackListURL
        "teamsURL" $config.endpoints.teamsURL
        "accountsURL" $config.endpoints.accountsURL
        "websiteURL" $config.endpoints.websiteURL
      )
      "title" $config.title
    }}
    
    {{- if hasKey $config "apiProxy" }}
    {{- $_ := set $deeplink "apiProxy" (dict 
      "host" $config.apiProxy.host
      "port" $config.apiProxy.port
      "needsAuthentication" $config.apiProxy.needsAuthentication
    ) }}
    {{- end }}
    
    {{ toJson $deeplink | indent 4 }}
  {{ printf "\n" }}
  {{ $deeplink_html }}: |2
    <html>
      <head>
        <title>Deeplink for {{ $domain }}</title>
      </head>
      <body>
        <a href="wire://access/?config={{ $config.endpoints.backendURL }}/deeplink.json">Click here for access to {{ $domain }}</a>
      </body>
    </html>
  {{- end }}
  
{{ (.Files.Glob "static/conf/*").AsConfig | indent 2 }}
