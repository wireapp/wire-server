on:
  push:
    branches:
      - lwille/zauth-arm64

name: Build zAuth Rust binary for ARM64
jobs:
  build-macos-arm:
    runs-on: ubuntu-latest
    env:
      SDK_VERSION: 12.3
      TARGET: aarch64-apple-darwin
      OSXCROSS_TARGET: ${{ github.workspace }}/osxcross
      CARGO_HOME: ${{ github.workspace }}/.cargo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup osxcross
        uses: Timmmm/setup-osxcross@v2
        with:
          osx-version: ${{ env.SDK_VERSION }}

      - name: Locate osxcross toolchain
        id: locate
        run: |
          TOOLCHAIN_PATH=$(find /opt /usr/local $HOME $GITHUB_WORKSPACE -type f -name 'aarch64-apple-darwin*-clang' 2>/dev/null | head -n 1 || true)
          if [ -z "$TOOLCHAIN_PATH" ]; then
            echo "aarch64-apple-darwin clang not found"
            find /opt /usr/local -maxdepth 3 -type d -name "osxcross" 2>/dev/null || true
            exit 1
          fi
          TOOLCHAIN_DIR=$(dirname "$TOOLCHAIN_PATH")
          echo "found toolchain bin directory: $TOOLCHAIN_DIR"
          echo "toolchain=$TOOLCHAIN_DIR" >> $GITHUB_OUTPUT

      - name: Install Rust (with macOS ARM64 target)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          target: aarch64-apple-darwin

      - name: Verify target installed
        run: rustup target list --installed

      - name: Build zauth
        run: |
          cd libs/libzauth/libzauth-c
          export TOOLCHAIN=${{ steps.locate.outputs.toolchain }}
          export CC=$TOOLCHAIN/aarch64-apple-darwin-clang
          export CXX=$TOOLCHAIN/aarch64-apple-darwin-clang++
          export AR=$TOOLCHAIN/aarch64-apple-darwin-ar
          export SDKROOT=$(dirname $(dirname $TOOLCHAIN))/SDK/MacOSX${SDK_VERSION}.sdk
          export MACOSX_DEPLOYMENT_TARGET=11.0
          export CFLAGS="-isysroot $SDKROOT -arch arm64 -mmacosx-version-min=11.0"
          export LDFLAGS="-isysroot $SDKROOT -arch arm64"
          export PKG_CONFIG_ALLOW_CROSS=1
          export CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER=$CC
          echo "Using CC=$CC"
          ls -l $CC || (echo "clang not found at $CC" && exit 1)
          $CC --version || (echo "clang executable broken" && exit 1)
          cargo build --release --target aarch64-apple-darwin --verbose

      - name: List built binaries
        run: ls -lh libs/libzauth/libzauth-c/target/aarch64-apple-darwin/release

      - name: Upload zauth binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: zauth-macos-arm64
          path: libs/libzauth/libzauth-c/target/aarch64-apple-darwin/release/zauth
