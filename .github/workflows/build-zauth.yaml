on:
  push:
    branches:
      - lwille/zauth-arm64

name: Build zAuth Rust binary for ARM64
jobs:
  build-macos-arm:
    runs-on: ubuntu-latest
    env:
      SDK_VERSION: 15.5
      TARGET: aarch64-apple-darwin
      OSXCROSS_TARGET: ${{ github.workspace }}/osxcross
      CARGO_HOME: ${{ github.workspace }}/.cargo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup osxcross
        uses: Timmmm/setup-osxcross@v2
        with:
          osx-version: ${{ env.SDK_VERSION }}

      - name: Set compiler variables
        run: |
          export CC=$OSXCROSS_TARGET/bin/aarch64-apple-darwin24.5-clang
          export CXX=$OSXCROSS_TARGET/bin/aarch64-apple-darwin24.5-clang++
          export AR=$OSXCROSS_TARGET/bin/aarch64-apple-darwin24.5-ar
          export SDKROOT=$OSXCROSS_TARGET/SDK/MacOSX${SDK_VERSION}.sdk
          export MACOSX_DEPLOYMENT_TARGET=11.0
          echo "CC=$CC"
          $CC --version

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build zauth
        run: |
          cd libs/libzauth/libzauth-c
          export CC=$OSXCROSS_TARGET/bin/aarch64-apple-darwin24.5-clang
          export CXX=$OSXCROSS_TARGET/bin/aarch64-apple-darwin24.5-clang++
          export AR=$OSXCROSS_TARGET/bin/aarch64-apple-darwin24.5-ar
          export SDKROOT=$OSXCROSS_TARGET/SDK/MacOSX${SDK_VERSION}.sdk
          export MACOSX_DEPLOYMENT_TARGET=11.0
          export CFLAGS="-isysroot $SDKROOT -arch arm64 -mmacosx-version-min=11.0"
          export LDFLAGS="-isysroot $SDKROOT -arch arm64"
          export PKG_CONFIG_ALLOW_CROSS=1
          export OSXCROSS_NO_INCLUDE_PATHS=1
          export CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER=$CC
          cargo build --release --target aarch64-apple-darwin --verbose

      - name: List built binaries
        run: ls -lh libs/libzauth/libzauth-c/target/aarch64-apple-darwin/release

      - name: Upload zauth binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: zauth-macos-arm64
          path: libs/libzauth/libzauth-c/target/aarch64-apple-darwin/release/zauth
