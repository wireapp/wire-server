on:
  push:
    branches:
      - lwille/zauth-arm64

name: Build zAuth Rust binary for ARM64
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Set up osxcross toolchain
        uses: Timmmm/setup-osxcross@v2
        with:
          macos-sdk: "15.5"

      - name: Configure environment for macOS ARM cross-compiling
        run: |
          export TRIPLE="aarch64-apple-darwin24.5"
          export ARCHFLAG="-arch arm64"
          
          echo "CC=${TRIPLE}-clang" >> $GITHUB_ENV
          echo "CXX=${TRIPLE}-clang++" >> $GITHUB_ENV
          echo "AR=${TRIPLE}-ar" >> $GITHUB_ENV
          echo "TARGET=aarch64-apple-darwin" >> $GITHUB_ENV
          echo "CFLAGS=-isysroot /usr/local/osxcross/target/SDK/MacOSX15.5.sdk -mmacosx-version-min=11.0 ${ARCHFLAG}" >> $GITHUB_ENV
          echo "LDFLAGS=-isysroot /usr/local/osxcross/target/SDK/MacOSX15.5.sdk ${ARCHFLAG}" >> $GITHUB_ENV
          echo "RUSTFLAGS=-C linker=${TRIPLE}-clang" >> $GITHUB_ENV
          echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
          echo "OSXCROSS_NO_INCLUDE_PATHS=1" >> $GITHUB_ENV
          echo "SDKROOT=/usr/local/osxcross/target/SDK/MacOSX15.5.sdk" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "ac_cv_func_malloc_0_nonnull=yes" >> $GITHUB_ENV
          echo "ac_cv_func_realloc_0_nonnull=yes" >> $GITHUB_ENV

      - name: Verify compiler
        run: |
          which $CC
          $CC --version
          echo "int main() {return 0;}" | $CC -v $CFLAGS -x c -o /dev/null -

      - name: Build libzauth (Rust + C + libsodium-sys)
        run: |
          echo "Building for aarch64-apple-darwin..."
          make libzauth
        env:
          TARGET: aarch64-apple-darwin
          CC: ${{ env.CC }}
          CXX: ${{ env.CXX }}
          AR: ${{ env.AR }}
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LDFLAGS }}
          RUSTFLAGS: ${{ env.RUSTFLAGS }}
          MACOSX_DEPLOYMENT_TARGET: 11.0
          OSXCROSS_NO_INCLUDE_PATHS: 1
          SDKROOT: /usr/local/osxcross/target/SDK/MacOSX15.5.sdk
          PKG_CONFIG_ALLOW_CROSS: 1
          ac_cv_func_malloc_0_nonnull: yes
          ac_cv_func_realloc_0_nonnull: yes

      - name: Upload compiled artifact
        uses: actions/upload-artifact@v4
        with:
          name: libzauth-aarch64-apple-darwin
          path: |
            libs/libzauth/libzauth-c/target/aarch64-apple-darwin/release
