on:
  push:
    branches:
      - lwille/zauth-arm64

name: Build zAuth Rust binary for ARM64
jobs:
  build-macos-arm:
    runs-on: ubuntu-latest
    env:
      SDK_VERSION: 12.3
      TARGET: aarch64-apple-darwin
      OSXCROSS_TARGET: ${{ github.workspace }}/osxcross
      CARGO_HOME: ${{ github.workspace }}/.cargo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup osxcross
        uses: Timmmm/setup-osxcross@v2
        with:
          osx-version: ${{ env.SDK_VERSION }}

      - name: Find osxcross clang path
        run: |
          echo "Searching for aarch64-apple-darwin clang binaries..."
          find $HOME $GITHUB_WORKSPACE /usr/local -type f -name 'aarch64-apple-darwin*-clang' 2>/dev/null | tee clang_paths.txt

      - name: Locate osxcross toolchain
        id: locate
        run: |
          TOOLCHAIN_DIR=$(find $HOME $GITHUB_WORKSPACE -type f -name 'aarch64-apple-darwin*-clang' | head -n 1 | xargs dirname)
          echo "Found toolchain bin directory: $TOOLCHAIN_DIR"
          echo "toolchain=$TOOLCHAIN_DIR" >> $GITHUB_OUTPUT

      - name: Install Rust (with macOS ARM64 target)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          target: aarch64-apple-darwin

      - name: Verify target installed
        run: rustup target list --installed

      - name: Build zauth
        run: |
          cd libs/libzauth/libzauth-c
          export CC=${{ steps.locate.outputs.toolchain }}/aarch64-apple-darwin-clang
          export CXX=${{ steps.locate.outputs.toolchain }}/aarch64-apple-darwin-clang++
          export AR=${{ steps.locate.outputs.toolchain }}/aarch64-apple-darwin-ar
          export SDKROOT=$(dirname $(dirname ${{ steps.locate.outputs.toolchain }}))/SDK/MacOSX${SDK_VERSION}.sdk
          export MACOSX_DEPLOYMENT_TARGET=11.0
          export CFLAGS="-isysroot $SDKROOT -arch arm64 -mmacosx-version-min=11.0"
          export LDFLAGS="-isysroot $SDKROOT -arch arm64"
          export PKG_CONFIG_ALLOW_CROSS=1
          export CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER=$CC
          $CC --version || (echo "clang missing" && exit 1)
          cargo build --release --target aarch64-apple-darwin --verbose

      - name: List built binaries
        run: ls -lh libs/libzauth/libzauth-c/target/aarch64-apple-darwin/release

      - name: Upload zauth binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: zauth-macos-arm64
          path: libs/libzauth/libzauth-c/target/aarch64-apple-darwin/release/zauth
