<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>13. PR Guidelines &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="14. Internal processes" href="processes.html" />
    <link rel="prev" title="12. Linting" href="linting.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../index.html">
        <img src="../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/administrate/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../understand/index.html">Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Developers Notes</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="api-versioning.html">1. API versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="building.html">2. How to build wire-server</a></li>
<li class="toctree-l3"><a class="reference internal" href="cassandra-interaction.html">3. Writing code interacting with cassandra</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html">4. Changelog</a></li>
<li class="toctree-l3"><a class="reference internal" href="dependencies.html">5. Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="editor-setup.html">6. Editor setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="features.html">7. Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="federation-api-conventions.html">8. Federation API Conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="federation-design-aspects.html">9. Federation Design Aspects</a></li>
<li class="toctree-l3"><a class="reference internal" href="how-to.html">10. Developer how-to’s</a></li>
<li class="toctree-l3"><a class="reference internal" href="large-conversations.html">11. Refactoring galley to support large conversations</a></li>
<li class="toctree-l3"><a class="reference internal" href="linting.html">12. Linting</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">13. PR Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#changelog-entries">13.1. Changelog entries</a></li>
<li class="toctree-l4"><a class="reference internal" href="#schema-migrations">13.2. Schema migrations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-new-public-endpoints">13.3. Adding new public endpoints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-new-configuration-flags-in-wire-server">13.4. Adding new configuration flags in wire-server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#changes-to-developer-workflow">13.5. Changes to developer workflow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="processes.html">14. Internal processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="scim/storage.html">15. Storing SCIM-related data</a></li>
<li class="toctree-l3"><a class="reference internal" href="servant.html">16. Servant</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">17. Testing the wire-server Haskell code base</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrading.html">18. Upgrading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/index.html">Reference</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Notes for developers</a></li>
          <li class="breadcrumb-item"><a href="index.html">Developer</a></li>
      <li class="breadcrumb-item active"><span class="section-number">13. </span>PR Guidelines</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/developer/developer/pr-guidelines.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pr-guidelines">
<h1><span class="section-number">13. </span>PR Guidelines<a class="headerlink" href="#pr-guidelines" title="Permalink to this heading"></a></h1>
<p>This document outlines the steps that need to be taken before merging any PR. In most cases, the only required action is creating a changelog entry (see below). However, when a PR affects the database schema, or the API, or service configuration, extra steps are required, and those are detailed below.</p>
<p>The recommended way to use this document is to copy the relevant checklists below into the PR description, when appropriate, and make sure they are all checked before the PR is merged.</p>
<section id="changelog-entries">
<h2><span class="section-number">13.1. </span>Changelog entries<a class="headerlink" href="#changelog-entries" title="Permalink to this heading"></a></h2>
<p>Every PR should add a new file in the appropriate subdirectory of <code class="docutils literal notranslate"><span class="pre">changelog.d</span></code>, containing just the text of the corresponding changelog entry. There is no need to explicitly write a PR number, because the <code class="docutils literal notranslate"><span class="pre">mk-changelog.sh</span></code> script (used on release) will add it automatically at the end. The name of the file does not matter, but it should be unique to avoid unnecessary conflicts (e.g. use the branch name).</p>
<p>It is still possible to write the PR number manually if so desired, which is useful in case the entry is shared by multiple PRs, or if the PR is merged with a merge commit rather than by squashing. In that case, the script would leave the PR number reference intact, as long as it is at the very end of the entry, with no period afterwards, in brackets, and preceded by a <code class="docutils literal notranslate"><span class="pre">#</span></code> symbol (e.g. #2646).</p>
<p>As long as the PR is merged by squashing, it is also possible to use the pattern <code class="docutils literal notranslate"><span class="pre">##</span></code> to refer to the current PR number. This will be replaced throughout.</p>
<p>Multiline entries are supported, and are handled correctly by the script. Again, the PR reference should either be omitted or put at the very end. If multiple entries for a single PR are desired, there should be a different file for each of them.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">docs/legacy/developer/changelog.md</span></code> for more information.</p>
</section>
<section id="schema-migrations">
<h2><span class="section-number">13.2. </span>Schema migrations<a class="headerlink" href="#schema-migrations" title="Permalink to this heading"></a></h2>
<p>Don’t delete columns that are still used by versions that are deployed. If you delete columns then the old version will fail in the deployment process. Rather than deleting keep the unused columns around and comment them as being discontinued in the schema migration code.</p>
<p>If a cassandra schema migration has been added then add this to the checklist:</p>
<ul class="simple">
<li><p>[ ] Run <strong><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">git-add-cassandra-schema</span></code></strong> to update the cassandra schema documentation</p></li>
</ul>
<section id="incompatible-schema-migrations-and-data-migrations">
<h3><span class="section-number">13.2.1. </span>Incompatible schema migrations and data migrations<a class="headerlink" href="#incompatible-schema-migrations-and-data-migrations" title="Permalink to this heading"></a></h3>
<p>If the PR contains a cassandra <em>schema</em> migration which is backwards incompatible, a changelog entry should be added to the release notes. See <a class="reference external" href="https://github.com/wireapp/wire-server/blob/develop/docs/developer/cassandra-interaction.md#cassandra-schema-migrations">notes on Cassandra</a> for more details on how to implement such schema changes. A similar entry should be added if the PR contains a <em>data</em> migration.</p>
<ul class="simple">
<li><p>[ ] Add a changelog entry in <code class="docutils literal notranslate"><span class="pre">0-release-notes</span></code> detailing measures to be taken by instance operators</p></li>
</ul>
</section>
</section>
<section id="adding-new-public-endpoints">
<h2><span class="section-number">13.3. </span>Adding new public endpoints<a class="headerlink" href="#adding-new-public-endpoints" title="Permalink to this heading"></a></h2>
<p>When adding new endpoints in the Haskell code in wire-server, correct routing needs to be applied at the nginz level.</p>
<p>NB: The nginz paths are interpreted as <em>prefixes</em>.  If you add a new end-point that is identical to an existing one except for the path of the latter being a proper prefix of the former, and if the nginz configuration of the two paths should be the same, nothing needs to be done.  Exception: if you see a path like <code class="docutils literal notranslate"><span class="pre">/self$</span></code>, you know it doesn’t match <code class="docutils literal notranslate"><span class="pre">/self/sub/what</span></code>.</p>
<p>The following needs to be done, as part of a PR adding endpoints or changing endpoint paths.</p>
<ul class="simple">
<li><p>[ ] Update nginz config in helm: <code class="docutils literal notranslate"><span class="pre">charts/nginz/values.yaml</span></code></p></li>
<li><p>[ ] Update nginz config for the local integration tests: <code class="docutils literal notranslate"><span class="pre">services/nginz/integration-test/conf/nginz/nginx.conf</span></code></p></li>
</ul>
<section id="helm-configuration">
<h3><span class="section-number">13.3.1. </span>Helm configuration<a class="headerlink" href="#helm-configuration" title="Permalink to this heading"></a></h3>
<p>For internal endpoints for QA access on staging environments, copy a block with <code class="docutils literal notranslate"><span class="pre">/i/</span></code> containing</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">-</span> <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">some</span><span class="o">/</span><span class="n">path</span>
    <span class="n">envs</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">staging</span>
    <span class="n">disable_zauth</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">basic_auth</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<p>For customer support access to an internal endpoint, instead update code in <a class="reference external" href="https://github.com/wireapp/wire-server/tree/develop/tools/stern">stern</a> as part of your PR. There is no need to add that endpoint to nginz.</p>
</section>
<section id="demo-nginz-configuration">
<h3><span class="section-number">13.3.2. </span>Demo nginz configuration<a class="headerlink" href="#demo-nginz-configuration" title="Permalink to this heading"></a></h3>
<p>New entris should include <code class="docutils literal notranslate"><span class="pre">common_response_no_zauth.conf;</span></code> for public endpoints without authentication and <code class="docutils literal notranslate"><span class="pre">common_response_with_zauth.conf;</span></code> for regular (authenticated) endpoints. Browse the file to see examples.</p>
</section>
<section id="example">
<h3><span class="section-number">13.3.3. </span>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h3>
<p>If the following endpoints are added to galley:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">endpoint</span>
<span class="n">POST</span> <span class="o">/</span><span class="n">turtles</span>
<span class="n">PUT</span> <span class="o">/</span><span class="n">turtles</span><span class="o">/&lt;</span><span class="n">turtleId</span><span class="o">&gt;/</span><span class="n">name</span>
</pre></div>
</div>
<p>Add to <code class="docutils literal notranslate"><span class="pre">charts/nginz/values.yaml</span></code>, under the <code class="docutils literal notranslate"><span class="pre">galley</span></code> section:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">endpoint</span>
<span class="o">-</span> <span class="n">path</span><span class="p">:</span> <span class="o">^/</span><span class="n">turtles</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="adding-new-configuration-flags-in-wire-server">
<h2><span class="section-number">13.4. </span>Adding new configuration flags in wire-server<a class="headerlink" href="#adding-new-configuration-flags-in-wire-server" title="Permalink to this heading"></a></h2>
<p>If a PR adds new configuration options for say brig, the following files need to be edited:</p>
<ul class="simple">
<li><p>[ ] The parser under <code class="docutils literal notranslate"><span class="pre">services/brig/src/Brig/Options.hs</span></code></p></li>
<li><p>[ ] The integration test config: <code class="docutils literal notranslate"><span class="pre">services/brig/brig.integration.yaml</span></code></p></li>
<li><p>[ ] The charts: <code class="docutils literal notranslate"><span class="pre">charts/brig/templates/configmap.yaml</span></code></p></li>
<li><p>[ ] The default values: <code class="docutils literal notranslate"><span class="pre">charts/brig/values.yaml</span></code></p></li>
<li><p>[ ] The values files for CI: <code class="docutils literal notranslate"><span class="pre">hack/helm_vars/wire-server/values.yaml.gotmpl</span></code></p></li>
<li><p>[ ] The configuration docs: <code class="docutils literal notranslate"><span class="pre">docs/src/developer/reference/config-options.md</span></code></p></li>
</ul>
<p>If any new configuration value is required and has no default, then:</p>
<ul class="simple">
<li><p>[ ] Write a changelog entry in <code class="docutils literal notranslate"><span class="pre">0-release-notes</span></code> advertising the new configuration value</p></li>
<li><p>[ ] Update all the relevant environments</p></li>
</ul>
<p>For wire Cloud, look into all the relevant environments (look for <code class="docutils literal notranslate"><span class="pre">helm_vars/wire-server/values.yaml.gotmpl</span></code> files in cailleach). Ideally, these configuration updates should be merged <strong>before</strong> merging the corresponding wire-server PR.</p>
<section id="removing-configuration-flags">
<h3><span class="section-number">13.4.1. </span>Removing configuration flags<a class="headerlink" href="#removing-configuration-flags" title="Permalink to this heading"></a></h3>
<p>Remove them with the PR from wire-server <code class="docutils literal notranslate"><span class="pre">./charts</span></code> folder, as charts are linked to code and go hand-in hand. Possibly notify all operators (through <code class="docutils literal notranslate"><span class="pre">./changelog.d/0-release-notes/</span></code>) that some overrides may not have any effect anymore.</p>
</section>
<section id="renaming-configuration-flags">
<h3><span class="section-number">13.4.2. </span>Renaming configuration flags<a class="headerlink" href="#renaming-configuration-flags" title="Permalink to this heading"></a></h3>
<p>Avoid doing this, it’s usually viable to introduce an at-least-equally-good name and remove the old one, that admins can first add the new options, then uprade the software, then remove the old ones.</p>
<p>If you must, see Removing/adding sections above. But please note that all people who have an installation of wire also may have overridden any of the configuration option you may wish to change the name of. As this is not type checked, it’s very error prone and people may find themselves with default configuration values being used instead of their intended configuration settings. Guideline: only rename for good reasons, not for aesthetics; or be prepared to spend a significant amount on documenting and communication about this change.</p>
</section>
</section>
<section id="changes-to-developer-workflow">
<h2><span class="section-number">13.5. </span>Changes to developer workflow<a class="headerlink" href="#changes-to-developer-workflow" title="Permalink to this heading"></a></h2>
<p>If a PR changes development workflow or dependencies, they should be automated and documented under <code class="docutils literal notranslate"><span class="pre">docs/developer/</span></code>. All efforts should be taken to minimize development setup breakage or slowdown for co-workers.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="linting.html" class="btn btn-neutral float-left" title="12. Linting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="processes.html" class="btn btn-neutral float-right" title="14. Internal processes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>