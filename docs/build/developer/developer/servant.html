<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>16. Servant &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="17. Testing the wire-server Haskell code base" href="testing.html" />
    <link rel="prev" title="15. Storing SCIM-related data" href="scim/storage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../index.html">
        <img src="../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/administrate/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../understand/index.html">Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Developers Notes</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="api-versioning.html">1. API versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="building.html">2. How to build wire-server</a></li>
<li class="toctree-l3"><a class="reference internal" href="cassandra-interaction.html">3. Writing code interacting with cassandra</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html">4. Changelog</a></li>
<li class="toctree-l3"><a class="reference internal" href="dependencies.html">5. Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="editor-setup.html">6. Editor setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="features.html">7. Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="federation-api-conventions.html">8. Federation API Conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="federation-design-aspects.html">9. Federation Design Aspects</a></li>
<li class="toctree-l3"><a class="reference internal" href="how-to.html">10. Developer how-to’s</a></li>
<li class="toctree-l3"><a class="reference internal" href="large-conversations.html">11. Refactoring galley to support large conversations</a></li>
<li class="toctree-l3"><a class="reference internal" href="linting.html">12. Linting</a></li>
<li class="toctree-l3"><a class="reference internal" href="pr-guidelines.html">13. PR Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="processes.html">14. Internal processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="scim/storage.html">15. Storing SCIM-related data</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">16. Servant</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#combinators">16.1. Combinators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#named-and-internal-route-ids-in-swagger">16.2. <code class="docutils literal notranslate"><span class="pre">Named</span></code>, and internal route IDs in swagger</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-handling">16.3. Error handling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">17. Testing the wire-server Haskell code base</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrading.html">18. Upgrading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/index.html">Reference</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Notes for developers</a></li>
          <li class="breadcrumb-item"><a href="index.html">Developer</a></li>
      <li class="breadcrumb-item active"><span class="section-number">16. </span>Servant</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/developer/developer/servant.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="servant">
<h1><span class="section-number">16. </span>Servant<a class="headerlink" href="#servant" title="Permalink to this heading"></a></h1>
<p>We currently use Servant for the public (i.e. client-facing) API in brig, galley and spar, as well as for their federation (i.e. server-to-server) and internal API.</p>
<p>Client-facing APIs are defined in <code class="docutils literal notranslate"><span class="pre">Wire.API.Routes.Public.{Brig,Galley}</span></code>. Internal APIs are all over the place at the moment. Federation APIs are in <code class="docutils literal notranslate"><span class="pre">Wire.API.Federation.API.{Brig,Galley}</span></code>.</p>
<p>Our APIs are able to generate Swagger documentation semi-automatically using <code class="docutils literal notranslate"><span class="pre">servant-swagger2</span></code>. The <code class="docutils literal notranslate"><span class="pre">schema-profunctor</span></code> library (see <a class="reference external" href="https://github.com/wireapp/wire-server/blob/develop/libs/schema-profunctor/README.md"><code class="docutils literal notranslate"><span class="pre">README.md</span></code></a> in <code class="docutils literal notranslate"><span class="pre">libs/schema-profunctor</span></code>) is used to create “schemas” for the input and output types used in the Servant APIs. A schema contains all the information needed to serialise/deserialise JSON values, as well as the documentation and metadata needed to generate Swagger.</p>
<section id="combinators">
<h2><span class="section-number">16.1. </span>Combinators<a class="headerlink" href="#combinators" title="Permalink to this heading"></a></h2>
<p>We have employed a few custom combinators to try to keep HTTP concerns and vocabulary out of the API handlers that actually implement the functionality of the API.</p>
<section id="zauth">
<h3><span class="section-number">16.1.1. </span><code class="docutils literal notranslate"><span class="pre">ZAuth</span></code><a class="headerlink" href="#zauth" title="Permalink to this heading"></a></h3>
<p>This is a family of combinators to handle the headers that nginx adds to requests. We currently have:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ZUser</span></code>: extracts the <code class="docutils literal notranslate"><span class="pre">UserId</span></code> in the <code class="docutils literal notranslate"><span class="pre">Z-User</span></code> header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ZLocalUser</span></code>: same as <code class="docutils literal notranslate"><span class="pre">ZUser</span></code>, but as a <code class="docutils literal notranslate"><span class="pre">Local</span></code> object (i.e. qualified by the local domain); this is useful when writing federation-aware handlers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ZConn</span></code>: extracts the <code class="docutils literal notranslate"><span class="pre">ConnId</span></code> in the <code class="docutils literal notranslate"><span class="pre">Z-Connection</span></code> header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ZConversation</span></code>: extracts the <code class="docutils literal notranslate"><span class="pre">ConvId</span></code> in the <code class="docutils literal notranslate"><span class="pre">Z-Conversation</span></code> header.</p></li>
</ul>
</section>
<section id="multiverb">
<h3><span class="section-number">16.1.2. </span><code class="docutils literal notranslate"><span class="pre">MultiVerb</span></code><a class="headerlink" href="#multiverb" title="Permalink to this heading"></a></h3>
<p>This is an alternative to <code class="docutils literal notranslate"><span class="pre">UVerb</span></code>, designed to prevent any HTTP-specific information from leaking into the type of the handler. Use this for endpoints that can return multiple responses.</p>
</section>
<section id="canthrow">
<h3><span class="section-number">16.1.3. </span><code class="docutils literal notranslate"><span class="pre">CanThrow</span></code><a class="headerlink" href="#canthrow" title="Permalink to this heading"></a></h3>
<p>This can be used to add an error response to the Swagger documentation. In services that use polysemy for error handling (currently only Galley), it also adds a corresponding error effect to the type of the handler. The argument of <code class="docutils literal notranslate"><span class="pre">CanThrow</span></code> can be of a custom kind, usually a service-specific error kind (such as <code class="docutils literal notranslate"><span class="pre">GalleyError</span></code>, <code class="docutils literal notranslate"><span class="pre">BrigError</span></code>, etc…), but kind <code class="docutils literal notranslate"><span class="pre">*</span></code> can also be used.</p>
<p>Note that error types can also be turned into <code class="docutils literal notranslate"><span class="pre">MultiVerb</span></code> responses using the <code class="docutils literal notranslate"><span class="pre">ErrorResponse</span></code> combinator. This is useful for handlers that can return errors as part of their return type, instead of simply throwing them as IO exceptions or using polysemy. If an error is part of <code class="docutils literal notranslate"><span class="pre">MultiVerb</span></code>, there is no need to also report it with <code class="docutils literal notranslate"><span class="pre">CanThrow</span></code>.</p>
</section>
<section id="qualifiedcapture">
<h3><span class="section-number">16.1.4. </span><code class="docutils literal notranslate"><span class="pre">QualifiedCapture</span></code><a class="headerlink" href="#qualifiedcapture" title="Permalink to this heading"></a></h3>
<p>This is a capture combinator for a path that looks like <code class="docutils literal notranslate"><span class="pre">/:domain/:value</span></code>, where <code class="docutils literal notranslate"><span class="pre">value</span></code> is of some arbitrary type <code class="docutils literal notranslate"><span class="pre">a</span></code>. The value is returned as a value of type <code class="docutils literal notranslate"><span class="pre">Qualified</span> <span class="pre">a</span></code>, which can then be used in federation-aware endpoints.</p>
</section>
</section>
<section id="named-and-internal-route-ids-in-swagger">
<span id="named-and-internal-route-ids"></span><h2><span class="section-number">16.2. </span><code class="docutils literal notranslate"><span class="pre">Named</span></code>, and internal route IDs in swagger<a class="headerlink" href="#named-and-internal-route-ids-in-swagger" title="Permalink to this heading"></a></h2>
<p>There is also a combinator <code class="docutils literal notranslate"><span class="pre">Named</span></code> that allows developers to jump back
and forth between the swagger docs (see <a class="reference internal" href="../../understand/api-client-perspective/swagger.html#swagger-api-docs"><span class="std std-ref">Swagger API documentation</span></a>) and
source code: from the swagger docs, copy the <em>internal route ID</em> and
full-text-search it in <code class="docutils literal notranslate"><span class="pre">wire-server/{libs,services}</span></code>.  That will give
you both the routing table type and the handler.</p>
<p>Route internal IDs need to instantiate the <code class="docutils literal notranslate"><span class="pre">Renderable</span></code> class in order
to be inserted into the swagger docs.  The instance should satisfy the
property that the ID, as rendered can be copied and fed to grep to
find its occurrances behind <code class="docutils literal notranslate"><span class="pre">Named</span></code>s in the source code.</p>
<p>The initial reason to introduce <code class="docutils literal notranslate"><span class="pre">Named</span></code> was increased type safety: if
two handlers have the same type, they can have be <code class="docutils literal notranslate"><span class="pre">Named</span></code> differently
and thus confusing them will be caught by the type checker.</p>
</section>
<section id="error-handling">
<h2><span class="section-number">16.3. </span>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this heading"></a></h2>
<p>Several layers of error handling are involved when serving a request. A handler in service code (e.g. Brig or Galley) can:</p>
<ol class="arabic simple">
<li><p>return a value on the <code class="docutils literal notranslate"><span class="pre">Right</span></code>;</p></li>
<li><p>return a value on the <code class="docutils literal notranslate"><span class="pre">Left</span></code>;</p></li>
<li><p>throw an <code class="docutils literal notranslate"><span class="pre">IO</span></code> exception.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">Handler</span> <span class="pre">→</span> <span class="pre">Servant.Handler</span></code> function, together with Servant’s internal response creation logic, will, respectively:</p>
<ol class="arabic simple">
<li><p>produce a normal response;</p></li>
<li><p>produce an error response, possibly logging the error;</p></li>
<li><p>(ignore any <code class="docutils literal notranslate"><span class="pre">IO</span></code> exceptions, and let them bubble up).</p></li>
</ol>
<p>Finally, the error-catching middleware <code class="docutils literal notranslate"><span class="pre">catchErrors</span></code> in <code class="docutils literal notranslate"><span class="pre">Network.Wai.Utilities.Server</span></code> will:</p>
<ol class="arabic simple">
<li><p>let normal responses through;</p></li>
<li><p>depending on the status code:</p>
<ul class="simple">
<li><p>if &lt; 500, let the error through;</p></li>
<li><p>if &gt;= 500, wrap the error response in a JSON error object (if it is not already
one), and log it at error level.</p></li>
</ul>
</li>
<li><p>catch the exception, turn it into a JSON error object, and log it. The
log level depends on the status code (error for 5xx, debug otherwise).</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="scim/storage.html" class="btn btn-neutral float-left" title="15. Storing SCIM-related data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="testing.html" class="btn btn-neutral float-right" title="17. Testing the wire-server Haskell code base" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>