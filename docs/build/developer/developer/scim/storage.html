<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>15. Storing SCIM-related data &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="16. Servant" href="../servant.html" />
    <link rel="prev" title="14. Internal processes" href="../processes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../../index.html">
        <img src="../../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/administrate/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../understand/index.html">Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Developers Notes</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../api-versioning.html">1. API versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../building.html">2. How to build wire-server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cassandra-interaction.html">3. Writing code interacting with cassandra</a></li>
<li class="toctree-l3"><a class="reference internal" href="../changelog.html">4. Changelog</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dependencies.html">5. Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../editor-setup.html">6. Editor setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../features.html">7. Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../federation-api-conventions.html">8. Federation API Conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../federation-design-aspects.html">9. Federation Design Aspects</a></li>
<li class="toctree-l3"><a class="reference internal" href="../how-to.html">10. Developer how-to’s</a></li>
<li class="toctree-l3"><a class="reference internal" href="../large-conversations.html">11. Refactoring galley to support large conversations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../linting.html">12. Linting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pr-guidelines.html">13. PR Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../processes.html">14. Internal processes</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">15. Storing SCIM-related data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#storing-user-data-devscimstorageusers">15.1. Storing user data {#DevScimStorageUsers}</a></li>
<li class="toctree-l4"><a class="reference internal" href="#storing-scim-tokens-devscimstoragetokens">15.2. Storing SCIM tokens {#DevScimStorageTokens}</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../servant.html">16. Servant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../testing.html">17. Testing the wire-server Haskell code base</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrading.html">18. Upgrading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Notes for developers</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Developer</a></li>
      <li class="breadcrumb-item active"><span class="section-number">15. </span>Storing SCIM-related data</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/developer/developer/scim/storage.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="storing-scim-related-data">
<h1><span class="section-number">15. </span>Storing SCIM-related data<a class="headerlink" href="#storing-scim-related-data" title="Permalink to this heading"></a></h1>
<p>Reference: {#DevScimStorage}</p>
<p><em>Author: Artyom Kazak, Matthias Fischmann</em></p>
<hr class="docutils" />
<section id="storing-user-data-devscimstorageusers">
<h2><span class="section-number">15.1. </span>Storing user data {#DevScimStorageUsers}<a class="headerlink" href="#storing-user-data-devscimstorageusers" title="Permalink to this heading"></a></h2>
<p>SCIM user data is validated by the spar service and stored as brig users.  All fields that wire doesn’t care about are silently dropped.  <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/scim/v2/Users</span></code> will trigger a lookup in brig, and the data thus obtained is synthesized back into a SCIM record.</p>
<p>Time stamps <code class="docutils literal notranslate"><span class="pre">created_at</span></code> and <code class="docutils literal notranslate"><span class="pre">last_updated_at</span></code> for the SCIM metadata are stored in <code class="docutils literal notranslate"><span class="pre">spar.scim_user_times</span></code>.  The are kept in sync with the users that are otherwise stored in brig.  (Rationale: we briefly considered using <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">writetime(*)</span> <span class="pre">from</span> <span class="pre">brig.user</span></code> for last update and <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">writetime(activated)</span> <span class="pre">from</span> <span class="pre">brig.user</span></code> for creation, but this has a drawback: we don’t have the time stamps when storing the record, so the <code class="docutils literal notranslate"><span class="pre">POST</span></code> handler would need to do a database write and a consecutive lookup, or an <code class="docutils literal notranslate"><span class="pre">insert</span> <span class="pre">if</span> <span class="pre">not</span> <span class="pre">exists</span></code>.)</p>
<p>Users created by SCIM set the <code class="docutils literal notranslate"><span class="pre">ManagedBy</span></code> field in brig to <code class="docutils literal notranslate"><span class="pre">ManagedByScim</span></code>.  This <em>should</em> lead to brig disallowing certain update operations (since the single source of truth should be the SCIM peer that has created and is updating the user), but we never got around to implementing that (as of Wed 15 Jul 2020 10:59:11 AM CEST).  See also {&#64;SparBrainDump} (grep for <code class="docutils literal notranslate"><span class="pre">ManagedBy</span></code>).</p>
</section>
<section id="storing-scim-tokens-devscimstoragetokens">
<h2><span class="section-number">15.2. </span>Storing SCIM tokens {#DevScimStorageTokens}<a class="headerlink" href="#storing-scim-tokens-devscimstoragetokens" title="Permalink to this heading"></a></h2>
<p><a class="reference internal" href="../../reference/provisioning/scim-token.html"><span class="std std-doc">SCIM tokens</span></a> are stored in two tables in Spar:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">team_provisioning_by_token</span></code> for <code class="docutils literal notranslate"><span class="pre">token</span> <span class="pre">-&gt;</span> <span class="pre">token</span> <span class="pre">info</span></code> lookups; used to perform authentication.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">team_provisioning_by_team</span></code> for <code class="docutils literal notranslate"><span class="pre">team</span> <span class="pre">-&gt;</span> <span class="pre">[token</span> <span class="pre">info]</span></code> and <code class="docutils literal notranslate"><span class="pre">(team,</span> <span class="pre">token</span> <span class="pre">ID)</span> <span class="pre">-&gt;</span> <span class="pre">token</span> <span class="pre">info</span></code> lookups; used to display tokens in team settings, and to decide which tokens should be deleted when the whole team is deleted.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../processes.html" class="btn btn-neutral float-left" title="14. Internal processes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../servant.html" class="btn btn-neutral float-right" title="16. Servant" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>