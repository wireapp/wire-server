<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2. How to build wire-server &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3. Writing code interacting with cassandra" href="cassandra-interaction.html" />
    <link rel="prev" title="1. API versioning" href="api-versioning.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../index.html">
        <img src="../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/administrate/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../understand/index.html">Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Developers Notes</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="api-versioning.html">1. API versioning</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">2. How to build wire-server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting">2.1. Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-run-integration-tests">2.2. How to run integration tests</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="cassandra-interaction.html">3. Writing code interacting with cassandra</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html">4. Changelog</a></li>
<li class="toctree-l3"><a class="reference internal" href="dependencies.html">5. Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="editor-setup.html">6. Editor setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="features.html">7. Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="federation-api-conventions.html">8. Federation API Conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="federation-design-aspects.html">9. Federation Design Aspects</a></li>
<li class="toctree-l3"><a class="reference internal" href="how-to.html">10. Developer how-to’s</a></li>
<li class="toctree-l3"><a class="reference internal" href="large-conversations.html">11. Refactoring galley to support large conversations</a></li>
<li class="toctree-l3"><a class="reference internal" href="linting.html">12. Linting</a></li>
<li class="toctree-l3"><a class="reference internal" href="pr-guidelines.html">13. PR Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="processes.html">14. Internal processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="scim/storage.html">15. Storing SCIM-related data</a></li>
<li class="toctree-l3"><a class="reference internal" href="servant.html">16. Servant</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">17. Testing the wire-server Haskell code base</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrading.html">18. Upgrading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/index.html">Reference</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Notes for developers</a></li>
          <li class="breadcrumb-item"><a href="index.html">Developer</a></li>
      <li class="breadcrumb-item active"><span class="section-number">2. </span>How to build wire-server</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/developer/developer/building.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-build-wire-server">
<h1><span class="section-number">2. </span>How to build wire-server<a class="headerlink" href="#how-to-build-wire-server" title="Permalink to this heading"></a></h1>
<p>As a prerequisiste install the <a class="reference external" href="https://nixos.org/">nix package manager</a> and <a class="reference external" href="https://direnv.net/">direnv</a>. Follow <a class="reference external" href="https://wire-server.cachix.org">these instructions</a> to setup the Nix cache which will save you many hours of building.</p>
<p>All following commands expect that you’ve entered the nix-provided build-environment by running <code class="docutils literal notranslate"><span class="pre">direnv</span> <span class="pre">allow</span></code>.</p>
<ol class="arabic">
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">cabal.project.local</span></code>. This file is not included in wire-server because it disables optimization.</p>
<p>make cabal.project.local</p>
<p>This should be re-run whenver a new local cabal package is added to the cabal project.</p>
</li>
</ol>
<p>Then the following Makefile targets can be used to compile and test wire-server locally:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># to compile all binaries to ./dist run
make

# to build and install all of galley&#39;s executables
make c package=galley

# also run galley&#39;s unit tests
make c package=galley test=1
</pre></div>
</div>
<section id="troubleshooting">
<h2><span class="section-number">2.1. </span>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading"></a></h2>
<section id="if-the-pr-doesn-t-pass-the-ci-read-check-marks-on-github">
<h3><span class="section-number">2.1.1. </span>If the PR doesn’t pass the CI (read check marks on github)<a class="headerlink" href="#if-the-pr-doesn-t-pass-the-ci-read-check-marks-on-github" title="Permalink to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">sanitize</span><span class="o">-</span><span class="n">pr</span>
</pre></div>
</div>
</section>
<section id="linker-errors-while-compiling">
<h3><span class="section-number">2.1.2. </span>Linker errors while compiling<a class="headerlink" href="#linker-errors-while-compiling" title="Permalink to this heading"></a></h3>
<p>Linker errors can occur if the nix-provided build environment (see <code class="docutils literal notranslate"><span class="pre">nix/</span></code> directory) changes. Since cabal is not aware of the changed environment the cached build artifacts in <code class="docutils literal notranslate"><span class="pre">./dist-newstyle</span></code> and <code class="docutils literal notranslate"><span class="pre">~/.cabal/store/</span></code> from previous builds may be invalid causing the linker errors.</p>
<p>Haskell Language Server stores its build artifacts in <code class="docutils literal notranslate"><span class="pre">~/.cache/hie-bios</span></code> (equivalent to the <code class="docutils literal notranslate"><span class="pre">./dist-newstyle</span></code> directory) which become invalid for the same reason.</p>
<p>The easiest course of action is to to remove these directories via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">full</span><span class="o">-</span><span class="n">clean</span>
</pre></div>
</div>
</section>
<section id="cabal-can-t-read-index-did-you-call-checkforupdates">
<h3><span class="section-number">2.1.3. </span>Cabal can’t read index (Did you call checkForUpdates?)<a class="headerlink" href="#cabal-can-t-read-index-did-you-call-checkforupdates" title="Permalink to this heading"></a></h3>
<p>Sometimes abording cabal mid-update can corrupt its index. Deleting <code class="docutils literal notranslate"><span class="pre">~/.cabal/packages/hackage.haskell.org</span></code> will usually do the trick.</p>
<p>As a side-note: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">c</span></code> doesn’t run <code class="docutils literal notranslate"><span class="pre">cabal</span> <span class="pre">update</span></code>, but <code class="docutils literal notranslate"><span class="pre">make</span></code> does, so keep that in mind.</p>
</section>
</section>
<section id="how-to-run-integration-tests">
<h2><span class="section-number">2.2. </span>How to run integration tests<a class="headerlink" href="#how-to-run-integration-tests" title="Permalink to this heading"></a></h2>
<p>Integration tests require all of the haskell services (brig, galley, cannon, gundeck, proxy, cargohold, spar) to be correctly configured and running, before being able to execute e.g. the <code class="docutils literal notranslate"><span class="pre">brig-integration</span></code> binary. The test for brig also starts nginz, so make sure it has been built before.
These services require most of the deployment dependencies as seen in the architecture diagram to also be available:</p>
<ul class="simple">
<li><p>Required internal dependencies:</p>
<ul>
<li><p>cassandra (with the correct schema)</p></li>
<li><p>elasticsearch (with the correct schema)</p></li>
<li><p>redis</p></li>
</ul>
</li>
<li><p>Required external dependencies are the following configured AWS services (or “fake” replacements providing the same API):</p>
<ul>
<li><p>SES</p></li>
<li><p>SQS</p></li>
<li><p>SNS</p></li>
<li><p>S3</p></li>
<li><p>DynamoDB</p></li>
</ul>
</li>
<li><p>Required additional software:</p>
<ul>
<li><p>netcat (in order to allow the services being tested to talk to the dependencies above)</p></li>
</ul>
</li>
</ul>
<p>Setting up these real, but in-memory internal and “fake” external dependencies is done easiest using <a class="reference external" href="https://docs.docker.com/compose/install/"><code class="docutils literal notranslate"><span class="pre">docker-compose</span></code></a>. Run the following in a separate terminal (it will block that terminal, C-c to shut all these docker images down again):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">deploy</span><span class="o">/</span><span class="n">dockerephemeral</span><span class="o">/</span><span class="n">run</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>After all containers are up you can use these Makefile targets to run the tests locally:</p>
<ol class="arabic">
<li><p>Build and run all integration tests</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>ci
</pre></div>
</div>
</li>
<li><p>Build and run integration tests for a service (say galley)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>ci<span class="w"> </span><span class="nv">package</span><span class="o">=</span>galley
</pre></div>
</div>
</li>
<li><p>Run integration tests written using <code class="docutils literal notranslate"><span class="pre">tasty</span></code> for a service (say galley) that match a pattern</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">TASTY_PATTERN</span><span class="o">=</span><span class="s2">&quot;/MLS/&quot;</span><span class="w"> </span>make<span class="w"> </span>ci<span class="w"> </span><span class="nv">package</span><span class="o">=</span>galley
</pre></div>
</div>
<p>For more details on pattern formats, see tasty docs: https://github.com/UnkindPartition/tasty#patterns</p>
</li>
<li><p>Run integration tests written using <code class="docutils literal notranslate"><span class="pre">hspec</span></code> for a service (say spar) that match a pattern</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">HSPEC_MATCH</span><span class="o">=</span><span class="s1">&#39;Scim&#39;</span><span class="w"> </span>make<span class="w"> </span>ci<span class="w"> </span><span class="nv">package</span><span class="o">=</span>spar
</pre></div>
</div>
<p>For more details on match formats, see hspec docs: https://hspec.github.io/match.html</p>
</li>
<li><p>Run integration tests without any parallelism</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">TASTY_NUM_THREADS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>make<span class="w"> </span>ci<span class="w"> </span><span class="nv">package</span><span class="o">=</span>brig
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">TASTY_NUM_THREADS</span></code> can also be set to other values, it defaults to number of cores available.</p>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="api-versioning.html" class="btn btn-neutral float-left" title="1. API versioning" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cassandra-interaction.html" class="btn btn-neutral float-right" title="3. Writing code interacting with cassandra" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>