<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. Federation API &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4. Federated API calls by client API end-point (generated)" href="fedcalls.html" />
    <link rel="prev" title="2. Backend to backend communication" href="backend-communication.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../index.html">
        <img src="../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/administrate/index.html">Administration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview.html">Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../single-sign-on/index.html">Single Sign-On and User Provisioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../restund.html">Audio/video calling, restund servers (TURN/STUN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sft.html">Conference Calling 2.0 (aka SFT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sft.html#federated-conference-calling">Federated Conference Calling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../minio.html">Minio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helm.html">Helm</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Federation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="architecture.html">1. Federation Achitecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="backend-communication.html">2. Backend to backend communication</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3. Federation API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#qualified-identifiers-and-names">3.1. Qualified Identifiers and Names</a></li>
<li class="toctree-l4"><a class="reference internal" href="#federated-requests">3.2. Federated requests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#list-of-federation-apis-exposed-by-components">3.3. List of Federation APIs exposed by Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-end-to-end-flows">3.4. Example End-to-End Flows</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ownership">3.5. Ownership</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="fedcalls.html">4. Federated API calls by client API end-point (generated)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../associate/index.html">Connecting Wire Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-client-perspective/index.html">Client API documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crypto-libs.html">Crypto libraries and sources of randomness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../block-user-creation.html">Block personal user creation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../classified-domains.html">Classified Domains</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configure-federation.html">Federation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../legalhold.html">Installing and setting up Legal Hold</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mls.html">Messaging Layer Security (MLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../searchability.html">User Searchability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../team-feature-settings.html">Server and team feature settings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developers Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Reference</a></li>
          <li class="breadcrumb-item"><a href="index.html">Wire Federation</a></li>
      <li class="breadcrumb-item active"><span class="section-number">3. </span>Federation API</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/understand/federation/api.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="federation-api">
<span id="id1"></span><h1><span class="section-number">3. </span>Federation API<a class="headerlink" href="#federation-api" title="Permalink to this heading"></a></h1>
<section id="qualified-identifiers-and-names">
<span id="id2"></span><h2><span class="section-number">3.1. </span>Qualified Identifiers and Names<a class="headerlink" href="#qualified-identifiers-and-names" title="Permalink to this heading"></a></h2>
<p>The federated architecture is reflected in the structure of the various
identifiers and names used in the API. Identifiers, such as user ids, are unique
within the context of a backend. They are made unique within the context of all
federating backend by combining them with the <a class="reference internal" href="architecture.html#glossary-backend-domain"><span class="std std-ref">backend domain</span></a>.</p>
<p>For example a user with user id <code class="docutils literal notranslate"><span class="pre">d389b370-5f7d-4efd-9f9a-8d525540ad93</span></code> on
backend <code class="docutils literal notranslate"><span class="pre">b.example.com</span></code> has the <em>qualified user id</em>
<code class="docutils literal notranslate"><span class="pre">d389b370-5f7d-4efd-9f9a-8d525540ad93&#64;b.example.com</span></code>. In API request bodies
qualified identities are encoded as objects, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;d389b370-5f7d-4efd-9f9a-8d525540ad93&quot;</span><span class="p">,</span>
      <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="s2">&quot;b.example.com&quot;</span>
  <span class="p">}</span>
  <span class="o">...</span>
<span class="p">}</span>

</pre></div>
</div>
<p>In API path segments qualified identities are encoded with the domain first, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">connections</span><span class="o">/</span><span class="n">b</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">d389b370</span><span class="o">-</span><span class="mi">5</span><span class="n">f7d</span><span class="o">-</span><span class="mi">4</span><span class="n">efd</span><span class="o">-</span><span class="mi">9</span><span class="n">f9a</span><span class="o">-</span><span class="mi">8</span><span class="n">d525540ad93</span>
</pre></div>
</div>
<p>to send a connection request to a user.</p>
<p>Any identifier on a backend can be qualified:</p>
<ul class="simple">
<li><p>conversation ids</p></li>
<li><p>team ids</p></li>
<li><p>client ids</p></li>
<li><p>user ids</p></li>
<li><p>user handles, e.g. local handle <code class="docutils literal notranslate"><span class="pre">&#64;alice</span></code> is displayed as <code class="docutils literal notranslate"><span class="pre">&#64;alice&#64;b.example.com</span></code> in federating users’ devices</p></li>
</ul>
<p>User profile names (e.g. “Alice”) which are not unique on the user’s backend,
can be changed by the user at any time and are not qualified.</p>
</section>
<section id="federated-requests">
<span id="api-between-federators"></span><h2><span class="section-number">3.2. </span>Federated requests<a class="headerlink" href="#federated-requests" title="Permalink to this heading"></a></h2>
<p>Every federated API request is made by a service component (e.g. brig, galley,
cargohold) in one backend and responded to by a service component in the other
backend. The <em>Federators</em> of the backends are relaying the request between the
components across backends . The components talk to each other via the
<em>Federator</em> in the originating domain and <em>Federator Ingress</em> in the receiving
domain (for details see <a class="reference internal" href="backend-communication.html#backend-to-backend-communication"><span class="std std-ref">Backend to backend communication</span></a>).</p>
<figure class="align-default" id="id10">
<a class="reference internal image-reference" href="../../_images/federation-apis-flow.png"><img alt="../../_images/federation-apis-flow.png" src="../../_images/federation-apis-flow.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Federators relaying a request between components. See <a class="reference internal" href="backend-communication.html#federation-back2back-example"><span class="std std-ref">Example</span></a> to see the discovery, authentication and authorization steps that are omitted from this figure.</span><a class="headerlink" href="#id10" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<section id="api-from-components-to-federator">
<h3><span class="section-number">3.2.1. </span>API From Components to Federator<a class="headerlink" href="#api-from-components-to-federator" title="Permalink to this heading"></a></h3>
<p>When making the call to the <em>Federator</em>, the components use HTTP2. They call the
Federator’s <code class="docutils literal notranslate"><span class="pre">Outward</span></code> service, which accepts <code class="docutils literal notranslate"><span class="pre">POST</span></code> requests with path
<code class="docutils literal notranslate"><span class="pre">/rpc/:domain/:component/:rpc</span></code>. Such a request will be forwarded to the remote
Federator with the given <a class="reference internal" href="architecture.html#backend-domains"><span class="std std-ref">backend domain</span></a>, and converted
to the appropriate request of its <code class="docutils literal notranslate"><span class="pre">Inward</span></code> service.</p>
</section>
<section id="id3">
<h3><span class="section-number">3.2.2. </span>API between Federators<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h3>
<p>The layer between <em>Federator</em> acts as an envelope for communication
between other components of wire server. The <em>Inward</em> service of
<em>Federator</em> is an HTTP2 server which is responsible for accepting
external requests coming from other backends, and forwarding them to the
appropriate component (currently Brig or Galley).</p>
<p><em>Federator</em> inspects the header of an incoming requests, performs
discovery and authentication, as described in
<a class="reference internal" href="backend-communication.html#backend-to-backend-communication"><span class="std std-ref">Backend to backend communication</span></a>, then
forwards the request as-is by repackaging its body into an HTTP request
for the target component.</p>
<p>The <em>Inward</em> service accepts only <code class="docutils literal notranslate"><span class="pre">POST</span></code> requests with a path of the
form <code class="docutils literal notranslate"><span class="pre">/federation/:component/:rpc</span></code>, where <code class="docutils literal notranslate"><span class="pre">:component</span></code> is the lowercase
name of the target component (i.e. <code class="docutils literal notranslate"><span class="pre">brig</span></code> or <code class="docutils literal notranslate"><span class="pre">galley</span></code>), and <code class="docutils literal notranslate"><span class="pre">:rpc</span></code> is
the name of the federation RPC to invoke. The arguments of the RPC are
contained the body, which is assumed to be of content type
<code class="docutils literal notranslate"><span class="pre">application/json</span></code>.</p>
<p>See <a class="reference internal" href="#api-from-federator-to-components"><span class="std std-ref">API From Federator to Components</span></a> for more details on RPCs and their paths.</p>
</section>
<section id="api-from-federator-to-components">
<span id="id4"></span><span id="id5"></span><h3><span class="section-number">3.2.3. </span>API From Federator to Components<a class="headerlink" href="#api-from-federator-to-components" title="Permalink to this heading"></a></h3>
<p>The components expose a REST API over HTTP to be consumed by the
<em>Federator</em>. All the paths start with <code class="docutils literal notranslate"><span class="pre">/federation</span></code>. When a <em>Federator</em>
receives a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request to <code class="docutils literal notranslate"><span class="pre">/federation/brig/get-user-by-handle</span></code>, it
connects to a local Brig and forwards the request to it after changing
its path to <code class="docutils literal notranslate"><span class="pre">/federation/get-user-by-handle</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">/federation</span></code> prefix is kept in the path to allow the component to
distinguish federated requests from requests by clients or other local
components.</p>
<p>If this request succeeds, the response is directly used as a response
for the original call to the <code class="docutils literal notranslate"><span class="pre">Inward</span></code> service. Otherwise, a response
with a <code class="docutils literal notranslate"><span class="pre">5xx</span></code> status code is returned, with a body containing a
description of the error that has occurred.</p>
<p>Note that the name of the RPC (<code class="docutils literal notranslate"><span class="pre">get-user-by-handle</span></code> in the above
example) is required to be a single path segment consisting of only
ASCII characters within a restricted set. This prevents path-traversal
attacks such as attempting to access <code class="docutils literal notranslate"><span class="pre">/federation/../users/by-handle</span></code>.</p>
</section>
</section>
<section id="list-of-federation-apis-exposed-by-components">
<span id="api-endpoints"></span><h2><span class="section-number">3.3. </span>List of Federation APIs exposed by Components<a class="headerlink" href="#list-of-federation-apis-exposed-by-components" title="Permalink to this heading"></a></h2>
<p>Each component of the backend provides an API towards the <em>Federator</em>
for access by other backends.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This reflects status of API endpoints as of 2023-01-10. For latest APIs please
refer to the corresponding source code linked in the individual section.</p>
</div>
<section id="brig">
<span id="id6"></span><h3><span class="section-number">3.3.1. </span>Brig<a class="headerlink" href="#brig" title="Permalink to this heading"></a></h3>
<p>In its current state, the primary purpose of the Brig API is to allow
users of remote backends to create conversations with the local users of
the backend.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get-user-by-handle</span></code>: Given a handle, return the user profile
corresponding to that handle.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get-users-by-ids</span></code>: Given a list of user ids, return the list of
corresponding user profiles.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">claim-prekey</span></code>: Given a user id and a client id, return a Proteus
pre-key belonging to that user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">claim-prekey-bundle</span></code>: Given a user id, return a prekey for each of
the user’s clients.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">claim-multi-prekey-bundle</span></code>: Given a list of user ids, return
prekeys of their respective clients.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">search-users</span></code>: Given a term, search the user database for matches
w.r.t. that term.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get-user-clients</span></code>: Given a list of user ids, return the lists of
clients of each of the users.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get-user-clients</span></code>: Given a list of user ids, return a list of all their clients with public information</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">send-connection-action</span></code>: Make and also respond to user connection requests</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on-user-deleted-connections</span></code>: Notify users that are connected to remote user about that user’s deletion</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get-mls-clients</span></code>: Request all <a class="reference internal" href="../mls.html#mls-message-layer-security"><span class="std std-ref">MLS</span></a>-capable clients for a given user</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">claim-key-packages</span></code>: Claim a previously-uploaded KeyPackage of a remote user. User for adding users to MLS conversations.</p></li>
</ul>
<p>See <a class="reference external" href="https://github.com/wireapp/wire-server/blob/master/libs/wire-api-federation/src/Wire/API/Federation/API/Brig.hs">the brig source
code</a>
for the current list of federated endpoints of <em>Brig</em>, as well as
their precise inputs and outputs.</p>
</section>
<section id="galley">
<span id="id7"></span><h3><span class="section-number">3.3.2. </span>Galley<a class="headerlink" href="#galley" title="Permalink to this heading"></a></h3>
<p>Each backend keeps a record of the conversations that each of its
members is a part of. The purpose of the Galley API is to allow backends
to synchronize the state of the conversations of their members.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get-conversations</span></code>: Given a qualified user id and a list of
conversation ids, return the details of the conversations. This
allows a remote backend to query conversation metadata of their
local user from this backend. To avoid metadata leaks, the backend
will check that the domain of the given user corresponds to the
domain of the backend sending the request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get-sub-conversation</span></code>: Get a MLS subconversation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">leave-conversation</span></code>: Given a remote user and a conversation id,
remove the the remote user from the (local) conversation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mls-welcome</span></code>: Send MLS welcome message to a new user owned by the called backend</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on-client-removed</span></code>: Inform called backend that a client of a user has been deleted</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on-conversation-created</span></code>: Given a name and a list of conversation
members, create a conversation locally. This is used to inform
another backend of a new conversation that involves their local
user(s).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on-conversation-updated</span></code>: Given a qualified user id and a qualified
conversation id, update the conversation details locally with the
other data provided. This is used to alert remote backend of updates
in the conversation metadata of conversations in which at least one
of their local users is involved.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on-message-sent</span></code>: Given a remote message and a conversation id,
propagate a message to local users. This is used whenever there is a
remote user in a conversation (see end-to-end flows).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on-mls-message-sent</span></code>: Receive a MLS message that originates in the calling backend</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on-new-remote-conversation</span></code>: Inform the called backend about a conversation that exists on the calling backend. This request is made before the first time the backend might learn about this conversation, e.g. when its first user is added to the conversation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">update-typing-indicator</span></code>: Used by the calling backend (that does not own the conversation ) to inform the backend about a change of the typing indicator status of one of its users</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on-typing-indicator-updated</span></code>: Used by the calling backend (that owns a conversation) to inform the called backend about a change of the typing indicator status of remote user</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on-user-deleted-conversations</span></code>: When a user on calling backend this request is made for all conversations on the called backend was part of</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">query-group-info</span></code>: Query the MLS public group state</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">send-message</span></code>: Given a sender and a raw message request, send a
message to a conversation owned by another backend. This is used
when the user sending a message is not on the same backend as the
conversation the message is sent in.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">send-mls-commit-bundle</span></code>: Send a MLS commit bundle to backend that owns the conversation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">send-mls-message</span></code>: Send MLS message to backend that owns the conversation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">update-conversation</span></code>: Calling backend requests a conversation action on the called backend which owns the conversation</p></li>
</ul>
<p>See <a class="reference external" href="https://github.com/wireapp/wire-server/blob/master/libs/wire-api-federation/src/Wire/API/Federation/API/Galley.hs">the galley source
code</a>
for the current list of federated endpoints of <em>Galley</em>, as well as
their precise inputs and outputs.</p>
</section>
<section id="cargohold">
<span id="end-to-end-flows"></span><h3><span class="section-number">3.3.3. </span>Cargohold<a class="headerlink" href="#cargohold" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get-asset</span></code>: Check if asset owned by called backend is available to calling backend</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stream-asset</span></code>: Stream asset owned by the called backend</p></li>
</ul>
<p>See <a class="reference external" href="https://github.com/wireapp/wire-server/blob/master/libs/wire-api-federation/src/Wire/API/Federation/API/Cargohold.hs">the cargohold source
code</a>
for the current list of federated endpoints of the <em>Cargohold</em>, as well as
their precise inputs and outputs.</p>
</section>
</section>
<section id="example-end-to-end-flows">
<h2><span class="section-number">3.4. </span>Example End-to-End Flows<a class="headerlink" href="#example-end-to-end-flows" title="Permalink to this heading"></a></h2>
<p>In the following the interactions between <em>Federator</em> and <em>Federation Ingress</em>
components of the backends involved are omitted for simplicity. Also the backend
domain and infrastructure domain are assumed the same.</p>
<p>Additionally we assume that the backend domain and the infrastructure domain of
the respective backends involved are the same and each domain identifies
a distinct backend.</p>
<section id="user-discovery">
<span id="id8"></span><h3><span class="section-number">3.4.1. </span>User Discovery<a class="headerlink" href="#user-discovery" title="Permalink to this heading"></a></h3>
<p>In this flow, the user <em>Alice</em> at <em>a.example.com</em> tries to search for user
<em>Bob</em> at <em>b.example.com</em>.</p>
<ol class="arabic simple">
<li><p>User <em>Alice</em> enters the qualified user name of the target
user <em>Bob</em> : <code class="docutils literal notranslate"><span class="pre">&#64;bob&#64;b.example.com</span></code> into the search field of their Wire client.</p></li>
<li><p>The client issues a query to <code class="docutils literal notranslate"><span class="pre">/search/contacts</span></code> of the Brig
searching for <em>Bob</em> at <em>b.example.com</em>.</p></li>
<li><p>The Brig in <em>Alice</em>’s backend asks its local <em>Federator</em> to query the
<code class="docutils literal notranslate"><span class="pre">search-users</span></code> endpoint in <em>Bob</em>’s backend.</p></li>
<li><p><em>Alice</em>’s <em>Federator</em> queries <em>Bob</em>’s Brig via <em>Bob</em>’s <em>Federation
Ingress</em> and <em>Federator</em> as requested.</p></li>
<li><p><em>Bob</em>’s Brig replies with <em>Bob</em>’s user name and qualified handle, the
response goes through <em>Bob</em>’s <em>Federator</em> and <em>Federation Ingress</em>,
as well as <em>Alice</em>’s <em>Federator</em> before it reaches <em>A</em>’s Brig.</p></li>
<li><p><em>Alice</em>’s Brig forwards that information to <em>A</em>’s client.</p></li>
</ol>
</section>
<section id="conversation-establishment">
<span id="id9"></span><h3><span class="section-number">3.4.2. </span>Conversation Establishment<a class="headerlink" href="#conversation-establishment" title="Permalink to this heading"></a></h3>
<p>After having discovered user <em>Bob</em> at <em>b.example.com</em>, user <em>Alice</em> at
<em>a.example.com</em> wants to establish a conversation with <em>Bob</em>.</p>
<ol class="arabic simple">
<li><p>From the search results of a
<a class="reference internal" href="#user-discovery"><span class="std std-ref">user discovery</span></a>
process, <em>Alice</em> chooses to create a conversation with <em>Bob</em>.</p></li>
<li><p><em>Alice</em>’s client issues a <code class="docutils literal notranslate"><span class="pre">/users/b.example.com/&lt;bobs-user-id&gt;/prekeys</span></code> query to
<em>Alice</em>’s Brig.</p></li>
<li><p><em>Alice</em>’s Brig asks its <em>Federator</em> to query the <code class="docutils literal notranslate"><span class="pre">claim-prekey-bundle</span></code>
endpoint of <em>Bob</em>’s backend using <em>Bob</em>’s user id.</p></li>
<li><p><em>Bob</em>’s <em>Federation Ingress</em> forwards the query to the <em>Federator</em>,
who in turn forwards it to the local Brig.</p></li>
<li><p><em>Bob</em>’s Brig replies with a prekey bundle for each of <em>Bob</em>’s clients,
which is forwarded to <em>Alice</em>’s Brig via <em>Bob</em>’s <em>Federator</em> and
<em>Federation Ingress</em>, as well as <em>Alice</em>’s <em>Federator</em>.</p></li>
<li><p><em>Alice</em>’s Brig forwards that information to <em>A</em>’s client.</p></li>
<li><p><em>Alice</em>’s client queries the <code class="docutils literal notranslate"><span class="pre">/conversations</span></code> endpoint of its Galley
using <em>Bob</em>’s user id.</p></li>
<li><p><em>Alice</em>’s Galley creates the conversation locally and queries the
<code class="docutils literal notranslate"><span class="pre">on-conversation-created</span></code> endpoint of <em>Bob</em>’s Galley (again via its
local <em>Federator</em>, as well as <em>Bob</em>’s <em>Federation Ingress</em> and
<em>Federator</em>) to inform it about the new conversation, including the
conversation metadata in the request.</p></li>
<li><p><em>Bob</em>’s Galley registers the conversation locally and confirms the
query.</p></li>
<li><p><em>Bob</em>’s Galley notifies <em>Bob</em>’s client of the creation of the
conversation.</p></li>
</ol>
</section>
<section id="message-sending">
<span id="message-sending-a"></span><h3><span class="section-number">3.4.3. </span>Message Sending<a class="headerlink" href="#message-sending" title="Permalink to this heading"></a></h3>
<p>Having established a conversation with user <em>Bob</em> at <em>b.example.com</em>, user
<em>Alice</em> at <em>a.example.com</em> wants to send a message to user <em>Bob</em>.</p>
<ol class="arabic simple">
<li><p>In a conversation <em>&lt;conv-id-1&gt;&#64;a.example.com</em> on <em>Alice</em>’s backend with
users <em>Alice</em> and <em>Bob</em>, <em>Alice</em> sends a message
by using the <code class="docutils literal notranslate"><span class="pre">/conversations/a.example.com/&lt;conv-id-1&gt;/proteus/messages</span></code>
endpoint on <em>Alice</em>’s Galley.</p></li>
<li><p><em>Alice</em>’s Galley checks if <em>A</em> included all necessary user devices in
their request. For that it makes a <code class="docutils literal notranslate"><span class="pre">get-user-clients</span></code> request to
<em>Bob</em>’s Galley. <em>Alice</em>’s Galley checks that the returned list of
clients matches the list of clients the message was encrypted for.</p></li>
<li><p><em>Alice</em>’s Galley sends the message to all clients in the conversation
that are part of <em>Alice</em>’s backend.</p></li>
<li><p><em>Alice</em>’s Galley queries the <code class="docutils literal notranslate"><span class="pre">on-message-sent</span></code> endpoint on <em>Bob</em>’s
Galley via its <em>Federator</em> and <em>Bob</em>’s <em>Federation Ingress</em> and
<em>Federator</em>.</p></li>
<li><p><em>Bob</em>’s Galley will propagate the message to all local clients
involved in the conversation.</p></li>
</ol>
</section>
</section>
<section id="ownership">
<h2><span class="section-number">3.5. </span>Ownership<a class="headerlink" href="#ownership" title="Permalink to this heading"></a></h2>
<p>Wire uses the concept of <strong>ownership</strong> as a guiding principle in the design of
Federation. Every resource, e.g. user, conversation, asset, is <strong>owned</strong> by the
backend on which it was <em>created</em>.</p>
<p>A backend that owns a resource is the source of truth for it. For example, for
users this means that information about user <em>Alice</em> which is owned by backend
<em>A</em> is stored only on backend <em>A</em>. If any federating backend needs information
about the user <em>Alice</em>, e.g. the profile information, it needs to request that
information from <em>A</em>.</p>
<p>In some cases backends locally store partial information of resources they don’t
own. For example a backend stores a reference to any remotely-owned conversation
any of its users is participating in. However, to get the full list of all
participants of a remote conversation, the owning backend needs to be queried.</p>
<p>Ownership is reflected in the naming convention of federation RPCs. Any rpc
named with prefix <code class="docutils literal notranslate"><span class="pre">on-</span></code> is always invoked by the backend that owns the resource
to inform federating backends. For example, if a user leaves a remote
conversation its backend would call the <code class="docutils literal notranslate"><span class="pre">leave-conversation</span></code> rpc on the remote
conversation. The remote backend would remove the user and inform all other
federating backends that participate in that conversation of this change by
calling their <code class="docutils literal notranslate"><span class="pre">on-conversation-updated</span></code> rpc.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="backend-communication.html" class="btn btn-neutral float-left" title="2. Backend to backend communication" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fedcalls.html" class="btn btn-neutral float-right" title="4. Federated API calls by client API end-point (generated)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>