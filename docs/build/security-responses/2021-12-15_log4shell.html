<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2021-12 - log4shell &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Releases" href="../changelog/index.html" />
    <link rel="prev" title="2022-02 - CVE-2021-44521 (Cassandra “user defined functions”)" href="2022-02-21_cve-2021-44521.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../index.html">
        <img src="../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Security responses</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="2023-01-19_html_injection.html">2023-01-19 - Security Advisory: HTML Injection in wire.com</a></li>
<li class="toctree-l2"><a class="reference internal" href="2023-01-04_website_outage.html">2023-01-04 - Outage of wire.com caused by a DoS attack</a></li>
<li class="toctree-l2"><a class="reference internal" href="2022-11-01_openssl.html">2022-11-01 - High Severity Vulnerability in OpenSSL</a></li>
<li class="toctree-l2"><a class="reference internal" href="2022-05-23_website_outage.html">2022-05-23 - wire.com website outage</a></li>
<li class="toctree-l2"><a class="reference internal" href="2022-02-21_cve-2021-44521.html">2022-02 - CVE-2021-44521 (Cassandra “user defined functions”)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2021-12 - log4shell</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#elasticsearch">Elasticsearch</a></li>
<li class="toctree-l3"><a class="reference internal" href="#disable-log4jlookups">Disable log4jLookups:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#further-information">Further information</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/administrate/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../understand/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developers Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Security responses</a></li>
      <li class="breadcrumb-item active">2021-12 - log4shell</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/security-responses/2021-12-15_log4shell.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="log4shell">
<h1>2021-12 - log4shell<a class="headerlink" href="#log4shell" title="Permalink to this heading"></a></h1>
<p>Last updated: 2021-12-15</p>
<p>This page concerns ON-PREMISE (i.e. self-hosted) installations of wire-server as documented in <a class="reference external" href="https://docs.wire.com">https://docs.wire.com</a> and its possible vulnerability to “log4shell” / CVE-2021-44228 and CVE-2021-45046.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>The “log4shell” vulnerability (<a class="reference external" href="https://www.cve.org/CVERecord?id=CVE-2021-44228">CVE-2021-44228</a> and <a class="reference external" href="https://www.cve.org/CVERecord?id=CVE-2021-45046">CVE-2021-45046</a>) concerns a logging library “log4j” used in Java or JVM software components.</p>
<ul>
<li><p>Wire-server’s source code is not written in a JVM language (it’s written mostly in Haskell), and as such, is not vulnerable.</p></li>
<li><p>Wire-server makes use of Cassandra, which is running on the JVM, however as of version 2.1 no longer makes use of log4j (it uses logback). Since the start of Wire’s on-premise product, we have used Cassandra versions &gt; 3 (currently 3.11), which is not vulnerable.</p></li>
<li><p>Wire-server makes use of <strong>Elasticsearch</strong>, which <strong>does use log4j. See the section below for details</strong>.</p></li>
<li><p>All other components Wire-server’s on-premise current and near-time-future product relies on are not based on the JVM and as such are not vulnerable:</p>
<blockquote>
<div><ul class="simple">
<li><p>Calling restund/SFT servers: written in C</p></li>
<li><p>Minio: written in Go</p></li>
<li><p>Redis: written in C</p></li>
<li><p>Nginx: written in C</p></li>
<li><p>Wire-Server: written in Haskell</p></li>
<li><p>Wire-Frontend (webapp, team settings): written in Javascript / NodeJS</p></li>
<li><p>Fake-aws components: based on localstack written in python or for SQS written in ruby</p></li>
<li><p>fake-aws-dynamodb: this component is JVM based and was used in the past on on-premise installations, but should not be in use anymore these days. If it is still in use in your environment, please stop using it: all recent versions of wire-server since June 2021 will not make use of that component anymore. Even if still in use, it does not store or log any user-provided data nor is it internet-facing and as such should pose little to no risk.</p></li>
<li><p>Upcoming releases may have wire-server-metrics: prometheus (Ruby), node-exporter (Golang) and Grafana (Golang)</p></li>
<li><p>Upcoming releases may have: Logging/Kibana: fluent-bit (C), Kibana (JavaScript), ElasticSearch (covered in section below)</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<section id="elasticsearch">
<h2>Elasticsearch<a class="headerlink" href="#elasticsearch" title="Permalink to this heading"></a></h2>
<p>Wire uses Elasticsearch for for storing indexes used when searching for users in Wire.</p>
<p>Elasticsearch clusters are not directly user-facing or internet-facing and it is therefore not immediately possible to inject problematic exploit strings into elasticsearch’s own logging (i.e. elasticsearch stores user-provided data, but doesn’t itself log this data).</p>
<p><em>Example: A Wire user display name will be stored inside elasticsearch, but not logged by elasticsearch (elasticsearch logs mostly contain information about connectivity to other elasticsearch processes)</em></p>
<p>Hypothetically, the log4shell exploit could be combined with another exploit which would allow an attacker to get Elasticsearch to log some of the data stored inside its cluster. As elasticsearch is not internet-facing, this doesn’t look easy to exploit.</p>
<p>In addition as per Elastics’s <a class="reference external" href="https://discuss.elastic.co/t/apache-log4j2-remote-code-execution-rce-vulnerability-cve-2021-44228-esa-2021-31/291476">own information on the matter</a></p>
<blockquote>
<div><p>“Elasticsearch 6 and 7 are not susceptible to remote code execution with this vulnerability due to our use of the Java Security Manager. Investigation into Elasticsearch 5 is ongoing. Elasticsearch running on JDK8 or below is susceptible to an information leak via DNS which is fixable by the JVM property identified below. The JVM option identified below is effective for Elasticsearch versions 5.5+, 6.5+, and 7+”</p>
</div></blockquote>
<p>The JVM property referred to is  <code class="docutils literal notranslate"><span class="pre">-Dlog4j2.formatMsgNoLookups=true</span></code></p>
<p><a class="reference external" href="https://discuss.elastic.co/t/apache-log4j2-remote-code-execution-rce-vulnerability-cve-2021-44228-esa-2021-31/291476">Update 15th December about CVE-2021-45046 from Elasitic</a>:</p>
<blockquote>
<div><p>“Update 15 December: A further vulnerability (CVE-2021-45046) was disclosed on December 14th after it was found that the fix to address CVE-2021-44228 in Apache Log4j 2.15.0 was incomplete in certain non-default configurations. Our guidance for Elasticsearch […] are unchanged by this new vulnerability”</p>
</div></blockquote>
<p>Wire on-premise installations contain a version of Elasticsearch between [<code class="docutils literal notranslate"><span class="pre">6.6.0</span></code> and <code class="docutils literal notranslate"><span class="pre">6.8.18</span></code>] at the time of writing.</p>
<p><strong>As such, while ElasticSearch is affected, it is A. only susceptible to an information leak, not to remote code execution and B. not easily exploitable due to the way Wire uses ElasticSearch.</strong></p>
<p>Still, if you’d like to avoid even the potential information leak problem:</p>
</section>
<section id="disable-log4jlookups">
<h2>Disable log4jLookups:<a class="headerlink" href="#disable-log4jlookups" title="Permalink to this heading"></a></h2>
<p>If you have followed our official documentation on <a class="reference external" href="https://docs.wire.com">https://docs.wire.com</a>, then Elasticsearch on premise was set up using <a class="reference external" href="https://github.com/wireapp/wire-server-deploy">wire-server-deploy</a>  using the <code class="docutils literal notranslate"><span class="pre">./ansible/elasticsearch.yml</span></code> playbook, which installs a vulnerable Log4J <code class="docutils literal notranslate"><span class="pre">2.11.1</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">find</span> <span class="o">/</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">log4j</span>
<span class="o">./</span><span class="n">etc</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">HOSTNAME</span><span class="o">/</span><span class="n">log4j2</span><span class="o">.</span><span class="n">properties</span>
<span class="o">./</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">log4j</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">2.11.1</span><span class="o">.</span><span class="n">jar</span>
<span class="o">./</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">log4j</span><span class="o">-</span><span class="mf">1.2</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="mf">2.11.1</span><span class="o">.</span><span class="n">jar</span>
<span class="o">./</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">log4j</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="mf">2.11.1</span><span class="o">.</span><span class="n">jar</span>
</pre></div>
</div>
<p>The BSI <a class="reference external" href="https://www.bsi.bund.de/SharedDocs/Cybersicherheitswarnungen/DE/2021/2021-549032-10F2.pdf?__blob=publicationFile&amp;amp;v=3">recommends</a> to mitigate setting the <code class="docutils literal notranslate"><span class="pre">log4j2.formatMsgNoLookups</span></code> to True in the JVM options. Elastic <a class="reference external" href="https://discuss.elastic.co/t/apache-log4j2-remote-code-execution-rce-vulnerability-cve-2021-44228-esa-2021-31/291476">recommends</a> the same mitigation.</p>
<p>You can do this in the concrete Wire on-premise case using:</p>
<p>First, ssh to all your elasticsearch machines and do the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>find<span class="w"> </span>/etc/elasticsearch<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>jvm.options

<span class="c1"># set this variable with the filepath found from above, usually something like</span>
<span class="c1"># /etc/elasticsearch/&lt;hostname&gt;/jvm.options</span>
<span class="nv">JVM_OPTIONS_FILE</span><span class="o">=</span>

<span class="c1"># run the following to add the mitigation log4j flag (command is idempotent)</span>
grep<span class="w">  </span><span class="s2">&quot;\-Dlog4j2.formatMsgNoLookups=True&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$JVM_OPTIONS_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;-Dlog4j2.formatMsgNoLookups=True&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$JVM_OPTIONS_FILE</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Next, restart your cluster using instructions provided in <a class="reference internal" href="../how-to/administrate/elasticsearch.html#restart-elasticsearch"><span class="std std-ref">How to rolling-restart an elasticsearch cluster</span></a>.</p>
</section>
<section id="further-information">
<h2>Further information<a class="headerlink" href="#further-information" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>A mitigation for this with fresh on-premise installations is introduced in <a class="reference external" href="https://github.com/wireapp/wire-server-deploy/pull/526">https://github.com/wireapp/wire-server-deploy/pull/526</a></p></li>
<li><p>We have of course fully applied the above counter measures to our cloud offering. We have no evidence that this vulnerability was used to launch an attack before this. Any hypothetical undetected attack would have required additional security vulnerabilities to be successful.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="2022-02-21_cve-2021-44521.html" class="btn btn-neutral float-left" title="2022-02 - CVE-2021-44521 (Cassandra “user defined functions”)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../changelog/index.html" class="btn btn-neutral float-right" title="Releases" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>