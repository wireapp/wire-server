<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minio &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Operational procedures" href="operations.html" />
    <link rel="prev" title="General - Linux" href="general-linux.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../index.html">
        <img src="../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/index.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Administration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup-disaster-recovery.html">Backup and disaster recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="cassandra.html">Cassandra</a></li>
<li class="toctree-l2"><a class="reference internal" href="elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="etcd.html">Etcd</a></li>
<li class="toctree-l2"><a class="reference internal" href="general-linux.html">General - Linux</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Minio</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#should-you-be-using-minio">Should you be using minio?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-interaction-with-minio">Setting up interaction with Minio</a></li>
<li class="toctree-l3"><a class="reference internal" href="#minio-maintenance">Minio maintenance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rotate-root-credentials">Rotate root credentials</a></li>
<li class="toctree-l3"><a class="reference internal" href="#check-the-health-of-a-minio-node">Check the health of a MinIO node</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="operations.html">Operational procedures</a></li>
<li class="toctree-l2"><a class="reference internal" href="restund.html">Restund (TURN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html">Investigative tasks (e.g. searching for users as server admin)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../understand/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developers Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Administration</a></li>
      <li class="breadcrumb-item active">Minio</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/how-to/administrate/minio.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="minio">
<h1>Minio<a class="headerlink" href="#minio" title="Permalink to this heading"></a></h1>
<p>This section is about <strong>how to perform a specific task</strong>. If you want to <strong>understand how a certain component works, please see</strong> <a class="reference internal" href="../../understand/index.html#understand"><span class="std std-ref">Reference</span></a></p>
<p>The rest of the page assumes you installed using the ansible playbooks from <a class="reference external" href="https://github.com/wireapp/wire-server-deploy/tree/master/ansible">wire-server-deploy</a></p>
<p>For any command below, first ssh into the server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">&lt;</span><span class="n">name</span> <span class="ow">or</span> <span class="n">IP</span> <span class="n">of</span> <span class="n">the</span> <span class="n">VM</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This section only covers the bare minimum, for more information, see the <a class="reference external" href="https://docs.min.io/">minio documentation</a></p>
<section id="should-you-be-using-minio">
<h2>Should you be using minio?<a class="headerlink" href="#should-you-be-using-minio" title="Permalink to this heading"></a></h2>
<p>Minio can be used to emulate an S3-compatible setup. When a native S3-like
storage provider is already present in your network or cloud provider, we
advise using that instead.</p>
</section>
<section id="setting-up-interaction-with-minio">
<h2>Setting up interaction with Minio<a class="headerlink" href="#setting-up-interaction-with-minio" title="Permalink to this heading"></a></h2>
<p>Minio can be installed on your servers using our provided ansible playbooks.
The ansible playbook will also install the minio client and configure it to
talk to the minio server running on the same node as it was installed.  For the
client-perspective, it does not matter to which server it is talking; all
actions will propagate around the cluster. One could for example configure
minio to run behind a loadbalancer like HAProxy, and configure the Minio client
to point to this loadbalancer instead.</p>
<p>Our ansible playbooks will also configure the minio client and adds the locally
reachable API under the <code class="docutils literal notranslate"><span class="pre">local</span></code> alias:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="n">config</span> <span class="n">host</span> <span class="nb">list</span>
</pre></div>
</div>
<p>If it is not there, it can be added manually as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="n">config</span> <span class="n">host</span> <span class="n">add</span> <span class="n">local</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">9000</span> <span class="o">&lt;</span><span class="n">YOUR</span><span class="o">-</span><span class="n">ACCESS</span><span class="o">-</span><span class="n">KEY</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">YOUR</span><span class="o">-</span><span class="n">SECRET</span><span class="o">-</span><span class="n">KEY</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The status of the cluster can be requested by contacting any of the servers. In
our case we will contact the locally running server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="n">admin</span> <span class="n">info</span> <span class="n">local</span>
</pre></div>
</div>
</section>
<section id="minio-maintenance">
<h2>Minio maintenance<a class="headerlink" href="#minio-maintenance" title="Permalink to this heading"></a></h2>
<p>There will be times where one wants to take a minio server down for
maintenance. One might want to apply security patches, or want to take out a
broken disk and replace it with a fixed one.  Minio will not tell you the
health status of disks. You should have separate alerting and monitoring in
place to keep track of hardware health. For example, one could look at
S.M.A.R.T. values that the disks produce with Prometheus <a class="reference external" href="https://github.com/prometheus-community/node-exporter-textfile-collector-scripts/blob/master/smartmon.sh">node_exporter</a></p>
<p>Special care has to be taken when restarting Minio nodes, but it should be safe
to do so.  Minio can operate in read-write mode with (N/2) + 1 instances
available in the cluster and it can operate in read-only mode with N/2 nodes
available in the cluster.  To ensure normal functioning of the cluster without
downtime, we advice taking down servers and setting them up again one by one.</p>
<p>Note that stopping a server might potentially disrupt any API call that is
being made to Minio. If someone is writing to a bucket, and this API call
is being served by the server we are restarting, then this API call will be
interrupted and the user must retry.  When you shut down a node, one should
take precautions that subsequent API calls are sent to other nodes in the
cluster.</p>
<p>To stop a server, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">minio</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>Writes that happen during the server being down will not be synced to the
server that is offline. It is important that once you bring the server back
online that you heal it. This will redistribute that data and parity
information such that the files that were written during the downtime are
redundantly stored again.  If one does not heal a server after being down, and continues
to restart servers, then data might end up not being redundantly stored and will but
unrecoverable in case of disk loss. It
is thus recommended to heal an instance immediately once it is back up; before attemtping to
restart any other instances.</p>
<p>Now that the server is offline, perform any maintenance that you want to do.
Afterwards, restart it with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">minio</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>Now check:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="n">admin</span> <span class="n">info</span> <span class="n">local</span>
</pre></div>
</div>
<p>to see if the cluster is healthy.</p>
<p>Now that the server is back online, it has missed writes that have happened whilst
it was offline. Because of this we must heal the cluster now
A heal of the cluster is performed as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="n">admin</span> <span class="n">heal</span> <span class="o">-</span><span class="n">r</span> <span class="n">local</span>
</pre></div>
</div>
<p>Which will show a result page that looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>◑  bunny
   0/0 objects; 0 B in 2s
   ┌────────┬───┬─────────────────────┐
   │ Green  │ 2 │  66.7% ████████     │
   │ Yellow │ 1 │  33.3% ████         │
   │ Red    │ 0 │   0.0%              │
   │ Grey   │ 0 │   0.0%              │
   └────────┴───┴─────────────────────┘
</pre></div>
</div>
<p>green - all good
yellow - healed partially
red - quorum missing
grey - more than quorum number shards are gone, means the object for some reason is not recoverable</p>
<p>When there are any yellow items, it usually means that not all servers have seen
the node come up properly again. Running the heal command with the <code class="docutils literal notranslate"><span class="pre">--json</span></code> option
will give you more verbose and precise information why the heal only happened partially.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;after&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;online&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;offline&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;missing&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;corrupted&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;drives&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">         </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;endpoint&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://10.0.0.42:9091/var/lib/minio-server1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;state&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;offline&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;uuid&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">         </span><span class="p">},</span>
<span class="w">         </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;uuid&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;endpoint&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/lib/minio-server1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;state&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ok&quot;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;color&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;yellow&quot;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In our case, we see that the reason for the partial recovery was that
one the server was still considered offline. Rerunning the command yielded
a Green heal.</p>
<p>On a routine restart of the system, such a heal procedure should not take very
long, as there is already some data on the disk from before you shut the server
down. If you replaced an unhealthy disk during the downtime, healing
might take a bit longer, as there is no local data to recover from.</p>
<p>After the server has successfully been healed, you can continue restarting the
next server.  Repeat this process until all servers have been restarted and are
healthy.</p>
<p>Note that there are other reasons but servers restarts that can cause nodes to
become out of sync.  For example, if there is a network failure that causes
some of the nodes to not be reachable, writes will be less durable too. It is
thus important to have good monitoring in place and respond accordingly.  Minio
itself will auto-heal the cluster every month if the administrator doesn’t
trigger a heal themselves.</p>
</section>
<section id="rotate-root-credentials">
<h2>Rotate root credentials<a class="headerlink" href="#rotate-root-credentials" title="Permalink to this heading"></a></h2>
<p>In order to change the root credentials, one needs to restart minio once but
set with the old and the new credentials at the same time.
If you installed minio with the Ansible, the <a class="reference external" href="https://github.com/wireapp/ansible-minio">role</a>
takes care of this. Just change the inventory accordingly and re-apply the
role.</p>
<p>For more information, please refer to the <em>Credentials</em> section in the <a class="reference external" href="https://docs.min.io/docs/minio-server-configuration-guide.html">official documentation</a>.</p>
</section>
<section id="check-the-health-of-a-minio-node">
<span id="id1"></span><h2>Check the health of a MinIO node<a class="headerlink" href="#check-the-health-of-a-minio-node" title="Permalink to this heading"></a></h2>
<p>This is the procedure to check a minio node’s health</p>
<p>First log into the minio server</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>&lt;ip<span class="w"> </span>of<span class="w"> </span>minio<span class="w"> </span>node&gt;
</pre></div>
</div>
<p>There, run the following commands:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>env<span class="w"> </span><span class="k">$(</span>sudo<span class="w"> </span>grep<span class="w"> </span>KEY<span class="w"> </span>/etc/default/minio-server1<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="k">)</span><span class="w"> </span>bash
<span class="nb">export</span><span class="w"> </span><span class="nv">MC_HOST_local</span><span class="o">=</span><span class="s2">&quot;http://</span><span class="nv">$MINIO_ACCESS_KEY</span><span class="s2">:</span><span class="nv">$MINIO_SECRET_KEY</span><span class="s2">@127.0.0.1:9000&quot;</span>
mc<span class="w"> </span>admin<span class="w"> </span>info<span class="w"> </span><span class="nb">local</span>
</pre></div>
</div>
<p>You should see a result similar to this:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>*<span class="w">  </span><span class="m">192</span>.168.0.12:9092
Uptime:<span class="w"> </span><span class="m">2</span><span class="w"> </span>months
Version:<span class="w"> </span><span class="m">2020</span>-10-28T08:16:50Z
Network:<span class="w"> </span><span class="m">6</span>/6<span class="w"> </span>OK
Drives:<span class="w"> </span><span class="m">1</span>/1<span class="w"> </span>OK

*<span class="w">  </span><span class="m">192</span>.168.0.22:9000
Uptime:<span class="w"> </span><span class="m">2</span><span class="w"> </span>months
Version:<span class="w"> </span><span class="m">2020</span>-10-28T08:16:50Z
Network:<span class="w"> </span><span class="m">6</span>/6<span class="w"> </span>OK
Drives:<span class="w"> </span><span class="m">1</span>/1<span class="w"> </span>OK

*<span class="w">  </span><span class="m">192</span>.168.0.22:9092
Uptime:<span class="w"> </span><span class="m">2</span><span class="w"> </span>months
Version:<span class="w"> </span><span class="m">2020</span>-10-28T08:16:50Z
Network:<span class="w"> </span><span class="m">6</span>/6<span class="w"> </span>OK
Drives:<span class="w"> </span><span class="m">1</span>/1<span class="w"> </span>OK

*<span class="w">  </span><span class="m">192</span>.168.0.32:9000
Uptime:<span class="w"> </span><span class="m">2</span><span class="w"> </span>months
Version:<span class="w"> </span><span class="m">2020</span>-10-28T08:16:50Z
Network:<span class="w"> </span><span class="m">6</span>/6<span class="w"> </span>OK
Drives:<span class="w"> </span><span class="m">1</span>/1<span class="w"> </span>OK

*<span class="w">  </span><span class="m">192</span>.168.0.32:9092
Uptime:<span class="w"> </span><span class="m">2</span><span class="w"> </span>months
Version:<span class="w"> </span><span class="m">2020</span>-10-28T08:16:50Z
Network:<span class="w"> </span><span class="m">6</span>/6<span class="w"> </span>OK
Drives:<span class="w"> </span><span class="m">1</span>/1<span class="w"> </span>OK

*<span class="w">  </span><span class="m">192</span>.168.0.12:9000
Uptime:<span class="w"> </span><span class="m">2</span><span class="w"> </span>months
Version:<span class="w"> </span><span class="m">2020</span>-10-28T08:16:50Z
Network:<span class="w"> </span><span class="m">6</span>/6<span class="w"> </span>OK
Drives:<span class="w"> </span><span class="m">1</span>/1<span class="w"> </span>OK
</pre></div>
</div>
<p>Make sure you see <code class="docutils literal notranslate"><span class="pre">Network:</span> <span class="pre">6/6</span> <span class="pre">OK</span></code>.</p>
<p>Reboot the machine with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>reboot
</pre></div>
</div>
<p>Then wait at least a minute.</p>
<p>If you go to ssh in, and get ‘Connection refused’, it just means you need to wait a bit longer.</p>
<p>Tip: You can automatically ask SSH to attempt to connect until it is succesful, by using the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;ConnectionAttempts 3600&#39;</span><span class="w"> </span>&lt;ip<span class="w"> </span>of<span class="w"> </span>minio<span class="w"> </span>node&gt;<span class="w"> </span><span class="nb">exit</span>
</pre></div>
</div>
<p>Log into minio ( repeat the steps above ), and check again.</p>
<p>You should see a very low uptime value on two hosts now.</p>
<p>This is because we install minio ‘twice’ on each host.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="general-linux.html" class="btn btn-neutral float-left" title="General - Linux" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="operations.html" class="btn btn-neutral float-right" title="Operational procedures" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>