<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Investigative tasks (e.g. searching for users as server admin) &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Reference" href="../../understand/index.html" />
    <link rel="prev" title="Restund (TURN)" href="restund.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../index.html">
        <img src="../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/index.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Administration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup-disaster-recovery.html">Backup and disaster recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="cassandra.html">Cassandra</a></li>
<li class="toctree-l2"><a class="reference internal" href="elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="etcd.html">Etcd</a></li>
<li class="toctree-l2"><a class="reference internal" href="general-linux.html">General - Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="minio.html">Minio</a></li>
<li class="toctree-l2"><a class="reference internal" href="operations.html">Operational procedures</a></li>
<li class="toctree-l2"><a class="reference internal" href="restund.html">Restund (TURN)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Investigative tasks (e.g. searching for users as server admin)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#manually-searching-for-users-in-cassandra">Manually searching for users in cassandra</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deleting-a-user-which-is-not-a-team-user">Deleting a user which is not a team user</a></li>
<li class="toctree-l3"><a class="reference internal" href="#searching-and-deleting-users-with-no-team">Searching and deleting users with no team</a></li>
<li class="toctree-l3"><a class="reference internal" href="#manual-search-on-elasticsearch-via-brig-recommended">Manual search on elasticsearch (via brig, recommended)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-manually-search-for-a-user-on-elasticsearh-directly-not-recommended">How to manually search for a user on elasticsearh directly (not recommended)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-manually-delete-a-user-from-elasticsearch-only">How to manually delete a user from elasticsearch only</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mass-invite-users-to-a-team">Mass-invite users to a team</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-obtain-logs-from-an-android-client-to-investigate-issues">How to obtain logs from an Android client to investigate issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-obtain-logs-from-an-ios-client-to-investigate-issues">How to obtain logs from an iOS client to investigate issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-retrieve-metric-values-manually">How to retrieve metric values manually</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reset-session-cookies">Reset session cookies</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#reset-cookies-of-all-users">Reset cookies of all users</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reset-cookies-for-a-defined-list-of-users">Reset cookies for a defined list of users</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#identify-sso-users">Identify all users using SSO</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-team-using-the-scim-api">Create a team using the SCIM API</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../understand/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developers Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Administration</a></li>
      <li class="breadcrumb-item active">Investigative tasks (e.g. searching for users as server admin)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/how-to/administrate/users.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="investigative-tasks-e-g-searching-for-users-as-server-admin">
<span id="investigative-tasks"></span><h1>Investigative tasks (e.g. searching for users as server admin)<a class="headerlink" href="#investigative-tasks-e-g-searching-for-users-as-server-admin" title="Permalink to this heading"></a></h1>
<p>This page requires that you have root access to the machines where kubernetes runs on, or have kubernetes permissions allowing you to port-forward arbitrary pods and services.</p>
<p>If you have the <code class="docutils literal notranslate"><span class="pre">backoffice</span></code> pod installed, see also the <a class="reference external" href="https://github.com/wireapp/wire-server/tree/develop/charts/backoffice">backoffice README</a>.</p>
<p>If you don’t have <code class="docutils literal notranslate"><span class="pre">backoffice</span></code>, see below for some options:</p>
<section id="manually-searching-for-users-in-cassandra">
<h2>Manually searching for users in cassandra<a class="headerlink" href="#manually-searching-for-users-in-cassandra" title="Permalink to this heading"></a></h2>
<p>Terminal one:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>port-forward<span class="w"> </span>svc/brig<span class="w"> </span><span class="m">9999</span>:8080
</pre></div>
</div>
<p>Terminal two: Search for your user by email:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">EMAIL</span><span class="o">=</span>user@example.com
curl<span class="w"> </span>-v<span class="w"> </span>-G<span class="w"> </span>localhost:9999/i/users<span class="w"> </span>--data-urlencode<span class="w"> </span><span class="nv">email</span><span class="o">=</span><span class="nv">$EMAIL</span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span>
<span class="c1"># or, for nicer formatting</span>
curl<span class="w"> </span>-v<span class="w"> </span>-G<span class="w"> </span>localhost:9999/i/users<span class="w"> </span>--data-urlencode<span class="w"> </span><span class="nv">email</span><span class="o">=</span><span class="nv">$EMAIL</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>json_pp
</pre></div>
</div>
<p>You can also search by <code class="docutils literal notranslate"><span class="pre">handle</span></code> (unique username) or by phone:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">HANDLE</span><span class="o">=</span>user123
curl<span class="w"> </span>-v<span class="w"> </span>-G<span class="w"> </span>localhost:9999/i/users<span class="w"> </span>--data-urlencode<span class="w"> </span><span class="nv">handles</span><span class="o">=</span><span class="nv">$HANDLE</span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span>

<span class="nv">PHONE</span><span class="o">=</span>+490000000000000<span class="w"> </span><span class="c1"># phone numbers must have the +country prefix and no spaces</span>
curl<span class="w"> </span>-v<span class="w"> </span>-G<span class="w"> </span>localhost:9999/i/users<span class="w"> </span>--data-urlencode<span class="w"> </span><span class="nv">phone</span><span class="o">=</span><span class="nv">$PHONE</span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span>
</pre></div>
</div>
<p>Which should give you output like:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;managed_by&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;wire&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;assets&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">         </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;key&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3-2-a749af8d-a17b-4445-b360-46c93fc41bc6&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;size&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;preview&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;image&quot;</span>
<span class="w">         </span><span class="p">},</span>
<span class="w">         </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;size&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;complete&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;image&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;key&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3-2-6cac6b57-9972-4aba-acbb-f078bc538b54&quot;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;picture&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;accent_id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;status&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;active&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;somename&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;email&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;9122e5de-b4fb-40fa-99ad-1b5d7d07bae5&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;locale&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;en&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;handle&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user123&quot;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The interesting part is the <code class="docutils literal notranslate"><span class="pre">id</span></code> (in the example case <code class="docutils literal notranslate"><span class="pre">9122e5de-b4fb-40fa-99ad-1b5d7d07bae5</span></code>):</p>
</section>
<section id="deleting-a-user-which-is-not-a-team-user">
<span id="user-deletion"></span><h2>Deleting a user which is not a team user<a class="headerlink" href="#deleting-a-user-which-is-not-a-team-user" title="Permalink to this heading"></a></h2>
<p>The following will completely delete a user, its conversations, assets, etc. The only thing remaining will be an entry in cassandra indicating that this user existed in the past (only the UUID remains, all other attributes like name etc are purged)</p>
<p>You can now delete that user by double-checking that the user you wish to delete is really the correct user:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># replace the id with the id of the user you want to delete</span>
curl<span class="w"> </span>-v<span class="w"> </span>localhost:9999/i/users/9122e5de-b4fb-40fa-99ad-1b5d7d07bae5<span class="w"> </span>-XDELETE
</pre></div>
</div>
<p>Afterwards, the previous command (to search for a user in cassandra) should return an empty list (<code class="docutils literal notranslate"><span class="pre">[]</span></code>).</p>
<p>When done, on terminal 1, ctrl+c to cancel the port-forwarding.</p>
</section>
<section id="searching-and-deleting-users-with-no-team">
<h2>Searching and deleting users with no team<a class="headerlink" href="#searching-and-deleting-users-with-no-team" title="Permalink to this heading"></a></h2>
<p>If you require users to be part of a team, or for some other reason you need to delete all users who are not part of a team, you need to first find all such users, and then delete them.</p>
<p>To find users that are not part of a team, first you need to connect via SSH to the machine where cassandra is running, and then run the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cqlsh<span class="w"> </span><span class="m">9042</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;select team, handle, id from brig.user&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;^\s+null&quot;</span>
</pre></div>
</div>
<p>This will give you a list of handles and IDs with no team associated:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>null<span class="w"> </span><span class="p">|</span><span class="w">       </span>null<span class="w"> </span><span class="p">|</span><span class="w"> </span>bc22119f-ce11-4402-aa70-307a58fb22ec
null<span class="w"> </span><span class="p">|</span><span class="w">        </span>tom<span class="w"> </span><span class="p">|</span><span class="w"> </span>8ecee3d0-47a4-43ff-977b-40a4fc350fed
null<span class="w"> </span><span class="p">|</span><span class="w">      </span>alice<span class="w"> </span><span class="p">|</span><span class="w"> </span>2a4c3468-c1e6-422f-bc4d-4aeff47941ac
null<span class="w"> </span><span class="p">|</span><span class="w">       </span>null<span class="w"> </span><span class="p">|</span><span class="w"> </span>1b5ca44a-aeb4-4a68-861b-48612438c4cc
null<span class="w"> </span><span class="p">|</span><span class="w">        </span>bob<span class="w"> </span><span class="p">|</span><span class="w"> </span>701b4eab-6df2-476d-a818-90dc93e8446e
</pre></div>
</div>
<p>You can then <a class="reference internal" href="#user-deletion"><span class="std std-ref">delete each user with these instructions</span></a>.</p>
</section>
<section id="manual-search-on-elasticsearch-via-brig-recommended">
<h2>Manual search on elasticsearch (via brig, recommended)<a class="headerlink" href="#manual-search-on-elasticsearch-via-brig-recommended" title="Permalink to this heading"></a></h2>
<p>This should only be necessary in the case of some (suspected) data inconsistency between cassandra and elasticsearch.</p>
<p>Terminal one:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>port-forward<span class="w"> </span>svc/brig<span class="w"> </span><span class="m">9999</span>:8080
</pre></div>
</div>
<p>Terminal two: Search for your user by name or handle or a prefix of that handle or name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">NAMEORPREFIX</span><span class="o">=</span>test7
<span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span>/proc/sys/kernel/random/uuid<span class="k">)</span>
curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Z-User:</span><span class="nv">$UUID</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;http://localhost:9999/search/contacts?q=</span><span class="nv">$NAMEORPREFIX</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span>
<span class="c1"># or, for pretty output:</span>
curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Z-User:</span><span class="nv">$UUID</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;http://localhost:9999/search/contacts?q=</span><span class="nv">$NAMEORPREFIX</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>json_pp
</pre></div>
</div>
<p>If no match is found, expect a query like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;took&quot;</span><span class="p">:</span><span class="mi">91</span><span class="p">,</span><span class="nt">&quot;found&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;documents&quot;</span><span class="p">:[],</span><span class="nt">&quot;returned&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
</pre></div>
</div>
<p>If matches are found, the result should look like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;found&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;documents&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dbdbf370-48b3-4e1e-b377-76d7d4cbb4f2&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Test&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;handle&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test7&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;accent_id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">7</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Test&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;accent_id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;handle&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test7476&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a93240b0-ba89-441e-b8ee-ff4403808f93&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">],</span>
<span class="w">   </span><span class="nt">&quot;returned&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;took&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">4</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="how-to-manually-search-for-a-user-on-elasticsearh-directly-not-recommended">
<h2>How to manually search for a user on elasticsearh directly (not recommended)<a class="headerlink" href="#how-to-manually-search-for-a-user-on-elasticsearh-directly-not-recommended" title="Permalink to this heading"></a></h2>
<p>First, ssh to an elasticsearch instance.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>&lt;ip<span class="w"> </span>of<span class="w"> </span>elasticsearch<span class="w"> </span>instance&gt;
</pre></div>
</div>
<p>Then run the following:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">PREFIX</span><span class="o">=</span>...
curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;http://localhost:9200/directory/_search?q=</span><span class="nv">$PREFIX</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>json_pp
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">id</span></code> (UUID) returned can be used when deleting (see below).</p>
</section>
<section id="how-to-manually-delete-a-user-from-elasticsearch-only">
<h2>How to manually delete a user from elasticsearch only<a class="headerlink" href="#how-to-manually-delete-a-user-from-elasticsearch-only" title="Permalink to this heading"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is NOT RECOMMENDED. Be sure you know what you’re doing. This only deletes the user from elasticsearch, but not from cassandra. Any change of e.g. the username or displayname of that user means this user will re-appear in the elasticsearch database. Instead, either fully delete a user: <a class="reference internal" href="#user-deletion"><span class="std std-ref">Deleting a user which is not a team user</span></a> or make use of the internal GET/PUT <code class="docutils literal notranslate"><span class="pre">/i/searchable</span></code> endpoint on brig to make this user prefix-unsearchable.</p>
</div>
<p>If, despite the warning, you wish to continue?</p>
<p>First, ssh to an elasticsearch instance:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>&lt;ip<span class="w"> </span>of<span class="w"> </span>elasticsearch<span class="w"> </span>instance&gt;
</pre></div>
</div>
<p>Next, check that the user exists:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UUID</span><span class="o">=</span>...
curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;http://localhost:9200/directory/user/</span><span class="nv">$UUID</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>json_pp
</pre></div>
</div>
<p>That should return a <code class="docutils literal notranslate"><span class="pre">&quot;found&quot;:</span> <span class="pre">true</span></code>, like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;_type&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;_version&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1575998428262000</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;_id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b3e9e445-fb02-47f3-bac0-63f5f680d258&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;found&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;_index&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;directory&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;_source&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;normalized&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Mr Test&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;handle&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test12345&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b3e9e445-fb02-47f3-bac0-63f5f680d258&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Mr Test&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;accent_id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then delete it:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UUID</span><span class="o">=</span>...
curl<span class="w"> </span>-s<span class="w"> </span>-XDELETE<span class="w"> </span><span class="s2">&quot;http://localhost:9200/directory/user/</span><span class="nv">$UUID</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>json_pp
</pre></div>
</div>
</section>
<section id="mass-invite-users-to-a-team">
<h2>Mass-invite users to a team<a class="headerlink" href="#mass-invite-users-to-a-team" title="Permalink to this heading"></a></h2>
<p>If you need to invite members to a specific given team, you can use the <code class="docutils literal notranslate"><span class="pre">create_team_members.sh</span></code> Bash script, located <a class="reference external" href="https://github.com/wireapp/wire-server/blob/develop/hack/bin/create_team_members.sh">here</a>.</p>
<p>This script does not create users or causes them to join a team by itself, instead, it sends invites to potential users via email, and when users accept the invitation, they create their account, set their password, and are added to the team as team members.</p>
<p>Input is a <a class="reference external" href="https://en.wikipedia.org/wiki/Comma-separated_values">CSV file</a>, in comma-separated format, in the form <code class="docutils literal notranslate"><span class="pre">'Email,Suggested</span> <span class="pre">User</span> <span class="pre">Name'</span></code>.</p>
<p>You also need to specify the inviting admin user, the team, the URI for the Brig (<a class="reference external" href="https://docs.wire.com/understand/federation/api.html?highlight=brig">API</a>) service (Host), and finally the input (CSV) file containing the users to invite.</p>
<p>The exact format for the parameters passed to the script is <a class="reference external" href="https://github.com/wireapp/wire-server/blob/develop/hack/bin/create_team_members.sh#L17">as follows</a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-a</span> <span class="pre">&lt;admin</span> <span class="pre">uuid&gt;</span></code>: <a class="reference external" href="https://docs.wire.com/understand/federation/api.html?highlight=user%20id#qualified-identifiers-and-names">User ID</a> in <a class="reference external" href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID format</a> of the inviting admin. For example <code class="docutils literal notranslate"><span class="pre">9122e5de-b4fb-40fa-99ad-1b5d7d07bae5</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">&lt;team</span> <span class="pre">uuid&gt;</span></code>: ID of the inviting team, same format.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-h</span> <span class="pre">&lt;host&gt;</span></code>: Base URI of brig’s internal endpoint.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-c</span> <span class="pre">&lt;input</span> <span class="pre">file&gt;</span></code>: file containing info on the invitees in format ‘Email,UserName’.</p></li>
</ul>
<p>For example, one such execution of the script could look like:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sh<span class="w"> </span>create_team_members.sh<span class="w"> </span>-a<span class="w"> </span>9122e5de-b4fb-40fa-99ad-1b5d7d07bae5<span class="w"> </span>-t<span class="w"> </span>123e4567-e89b-12d3-a456-426614174000<span class="w"> </span>-h<span class="w"> </span>http://localhost:9999<span class="w"> </span>-c<span class="w"> </span>users_to_invite.csv
</pre></div>
</div>
<p>Note: the ‘<a class="reference external" href="http://localhost:9999">http://localhost:9999</a>’ implies you are running the ‘kubectl port-forward’ given at the top of this document
.
Once the script is run, invitations will be sent to each user in the file every second until all invitations have been sent.</p>
<p>If you have a lot of invitations to send and this is too slow, you can speed things up by commenting <a class="reference external" href="https://github.com/wireapp/wire-server/blob/develop/hack/bin/create_team_members.sh#L91">this line</a>.</p>
</section>
<section id="how-to-obtain-logs-from-an-android-client-to-investigate-issues">
<h2>How to obtain logs from an Android client to investigate issues<a class="headerlink" href="#how-to-obtain-logs-from-an-android-client-to-investigate-issues" title="Permalink to this heading"></a></h2>
<p>Wire clients communicate with Wire servers (backend).</p>
<p>Sometimes to investigate server issues, you (or the Wire team) will need client information, in the form of client logs.</p>
<p>In order to obtain client logs on the Android Wire client, follow this procedure:</p>
<ul class="simple">
<li><p>Open the Wire app (client) on your Android device</p></li>
<li><p>Click on the round user icon in the top left of the screen, leading to your user Profile.</p></li>
<li><p>Click on “Settings” at the bottom of the screen</p></li>
<li><p>Click on “Advanced” in the menu</p></li>
<li><p>Check/activate “Collect usage data”</p></li>
<li><p>Now go back to using your client normally, so usage data is generated. If you have been asked to follow a specific testing regime, or log a specific problem, this is the time to do so.</p></li>
<li><p>Once enough usage data is generated, go back to the “Advanced” screen (User profile &gt; Settings &gt; Advanced)</p></li>
<li><p>Click on “Create debug report”</p></li>
<li><p>A menu will open allowing you to share the debug report, you can now save it or send it via email/any other means to the Wire team.</p></li>
</ul>
</section>
<section id="how-to-obtain-logs-from-an-ios-client-to-investigate-issues">
<h2>How to obtain logs from an iOS client to investigate issues<a class="headerlink" href="#how-to-obtain-logs-from-an-ios-client-to-investigate-issues" title="Permalink to this heading"></a></h2>
<p>Wire clients communicate with Wire servers (backend).</p>
<p>Sometimes to investigate server issues, you (or the Wire team) will need client information, in the form of client logs.</p>
<p>In order to obtain client logs on the iOS Wire client, follow this procedure:</p>
<ul class="simple">
<li><p>Open the Wire app (client) on your iOS device</p></li>
<li><p>Click on the round user icon in the top left of the screen, leading to your user Profile.</p></li>
<li><p>Click on “Settings” at the bottom of the screen</p></li>
<li><p>Click on “Advanced” in the menu</p></li>
<li><p>Check/activate “Collect usage data”</p></li>
<li><p>Now go back to using your client normally, so usage data is generated. If you have been asked to follow a specific testing regime, or log a specific problem, this is the time to do so.</p></li>
<li><p>Once enough usage data is generated, go back to the “Advanced” screen (User profile &gt; Settings &gt; Advanced)</p></li>
<li><p>Click on “Send report to wire”</p></li>
<li><p>A menu will open to share the debug report via email, allowing you to send it to the Wire team.</p></li>
</ul>
</section>
<section id="how-to-retrieve-metric-values-manually">
<h2>How to retrieve metric values manually<a class="headerlink" href="#how-to-retrieve-metric-values-manually" title="Permalink to this heading"></a></h2>
<p>Metric values are sets of data points about services, such as status and other measures, that can be retrieved at specific endpoints, typically by a monitoring system (such as Prometheus) for monitoring, diagnosis and graphing.</p>
<p>Sometimes, you will want to manually obtain this data that is normally automatically grabbed by Prometheus.</p>
<p>Some of the pods allow you to grab metrics by accessing their <code class="docutils literal notranslate"><span class="pre">/i/metrics</span></code> endpoint, in particular:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">brig</span></code>: User management API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cannon</span></code>: WebSockets API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cargohold</span></code>: Assets storage API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">galley</span></code>: Conversations and Teams API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gundeck</span></code>: Push Notifications API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spar</span></code>: Single-Sign-ON and SCIM</p></li>
</ul>
<p>For more details on the various services/pods, you can check out <a class="reference internal" href="../../understand/overview.html#overview"><span class="std std-ref">this link</span></a>.</p>
<p>Before you can grab metrics from a pod, you need to find its IP address. You do this by running the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>d<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-owide
</pre></div>
</div>
<p>(this presumes you are already in your normal Wire environment, which you obtain by running <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">./bin/offline-env.sh</span></code>)</p>
<p>Which will give you an output that looks something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>demo@Ubuntu-1804-bionic-64-minimal:~/Wire-Server$ d kubectl get pods -owide
NAME                               READY   STATUS      RESTARTS   AGE     IP              NODE        NOMINATED NODE   READINESS GATES
account-pages-784f9b547c-cp444     1/1     Running     0          6d23h   10.233.113.5    kubenode3   &lt;none&gt;           &lt;none&gt;
brig-746ddc55fd-6pltz              1/1     Running     0          6d23h   10.233.110.11   kubenode2   &lt;none&gt;           &lt;none&gt;
brig-746ddc55fd-d59dw              1/1     Running     0          6d4h    10.233.110.23   kubenode2   &lt;none&gt;           &lt;none&gt;
brig-746ddc55fd-zp7jl              1/1     Running     0          6d23h   10.233.113.10   kubenode3   &lt;none&gt;           &lt;none&gt;
brig-index-migrate-data-45rm7      0/1     Completed   0          6d23h   10.233.110.9    kubenode2   &lt;none&gt;           &lt;none&gt;
cannon-0                           1/1     Running     0          3h1m    10.233.119.41   kubenode1   &lt;none&gt;           &lt;none&gt;
cannon-1                           1/1     Running     0          3h1m    10.233.113.47   kubenode3   &lt;none&gt;           &lt;none&gt;
cannon-2                           1/1     Running     0          3h1m    10.233.110.51   kubenode2   &lt;none&gt;           &lt;none&gt;
cargohold-65bff97fc6-8b9ls         1/1     Running     0          6d4h    10.233.113.20   kubenode3   &lt;none&gt;           &lt;none&gt;
cargohold-65bff97fc6-bkx6x         1/1     Running     0          6d23h   10.233.113.4    kubenode3   &lt;none&gt;           &lt;none&gt;
cargohold-65bff97fc6-tz8fh         1/1     Running     0          6d23h   10.233.110.5    kubenode2   &lt;none&gt;           &lt;none&gt;
cassandra-migrations-bjsdz         0/1     Completed   0          6d23h   10.233.110.3    kubenode2   &lt;none&gt;           &lt;none&gt;
demo-smtp-784ddf6989-vmj7t         1/1     Running     0          6d23h   10.233.113.2    kubenode3   &lt;none&gt;           &lt;none&gt;
elasticsearch-index-create-7r8g4   0/1     Completed   0          6d23h   10.233.110.4    kubenode2   &lt;none&gt;           &lt;none&gt;
fake-aws-sns-6c7c4b7479-wfp82      2/2     Running     0          6d4h    10.233.110.27   kubenode2   &lt;none&gt;           &lt;none&gt;
fake-aws-sqs-59fbfbcbd4-n4c5z      2/2     Running     0          6d23h   10.233.110.2    kubenode2   &lt;none&gt;           &lt;none&gt;
galley-7c89c44f7b-nm2rr            1/1     Running     0          6d23h   10.233.110.8    kubenode2   &lt;none&gt;           &lt;none&gt;
galley-7c89c44f7b-tdxz4            1/1     Running     0          6d23h   10.233.113.6    kubenode3   &lt;none&gt;           &lt;none&gt;
galley-7c89c44f7b-tr8pm            1/1     Running     0          6d4h    10.233.110.29   kubenode2   &lt;none&gt;           &lt;none&gt;
galley-migrate-data-g66rz          0/1     Completed   0          6d23h   10.233.110.13   kubenode2   &lt;none&gt;           &lt;none&gt;
gundeck-7fd75c7c5f-jb8xq           1/1     Running     0          6d23h   10.233.110.6    kubenode2   &lt;none&gt;           &lt;none&gt;
gundeck-7fd75c7c5f-lbth9           1/1     Running     0          6d23h   10.233.113.8    kubenode3   &lt;none&gt;           &lt;none&gt;
gundeck-7fd75c7c5f-wvcw6           1/1     Running     0          6d4h    10.233.113.23   kubenode3   &lt;none&gt;           &lt;none&gt;
nginz-5cdd8b588b-dbn86             2/2     Running     16         6d23h   10.233.113.11   kubenode3   &lt;none&gt;           &lt;none&gt;
nginz-5cdd8b588b-gk6rw             2/2     Running     14         6d23h   10.233.110.12   kubenode2   &lt;none&gt;           &lt;none&gt;
nginz-5cdd8b588b-jvznt             2/2     Running     11         6d4h    10.233.113.21   kubenode3   &lt;none&gt;           &lt;none&gt;
reaper-6957694667-s5vz5            1/1     Running     0          6d4h    10.233.110.26   kubenode2   &lt;none&gt;           &lt;none&gt;
redis-ephemeral-master-0           1/1     Running     0          6d23h   10.233.113.3    kubenode3   &lt;none&gt;           &lt;none&gt;
spar-56d77f85f6-bw55q              1/1     Running     0          6d23h   10.233.113.9    kubenode3   &lt;none&gt;           &lt;none&gt;
spar-56d77f85f6-mczzd              1/1     Running     0          6d4h    10.233.110.28   kubenode2   &lt;none&gt;           &lt;none&gt;
spar-56d77f85f6-vvvfq              1/1     Running     0          6d23h   10.233.110.7    kubenode2   &lt;none&gt;           &lt;none&gt;
spar-migrate-data-ts4sx            0/1     Completed   0          6d23h   10.233.110.14   kubenode2   &lt;none&gt;           &lt;none&gt;
team-settings-fbbb899c-qxx7m       1/1     Running     0          6d4h    10.233.110.24   kubenode2   &lt;none&gt;           &lt;none&gt;
webapp-d97869795-grnft             1/1     Running     0          6d4h    10.233.110.25   kubenode2   &lt;none&gt;           &lt;none&gt;
</pre></div>
</div>
<p>Here presuming we need to get metrics from <code class="docutils literal notranslate"><span class="pre">gundeck</span></code>, we can see the IP of one of the gundeck pods is <code class="docutils literal notranslate"><span class="pre">10.233.110.6</span></code>.</p>
<p>We can therefore connect to node <code class="docutils literal notranslate"><span class="pre">kubenode2</span></code> on which this pod runs with <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">kubenode2.your-domain.com</span></code>, and run the following:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span><span class="m">10</span>.233.110.6:8080/i/metrics
</pre></div>
</div>
<p>Alternatively, if you don’t want to, or can’t for some reason, connect to kubenode2, you can use port redirect instead:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allow Gundeck to be reached via the port 7777</span>
kubectl<span class="w"> </span>--kubeconfig<span class="w"> </span>kubeconfig.dec<span class="w"> </span>-n<span class="w"> </span>wire<span class="w"> </span>port-forward<span class="w"> </span>service/gundeck<span class="w"> </span><span class="m">7777</span>:8080
<span class="c1"># Reach Gundeck directly at port 7777 using curl, output resulting data to stdout/terminal</span>
curl<span class="w"> </span>-v<span class="w"> </span>http://127.0.0.1:7777/i/metrics
</pre></div>
</div>
<p>Output will look something like this (truncated):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># HELP gc_seconds_wall Wall clock time spent on last GC</span>
<span class="c1"># TYPE gc_seconds_wall gauge</span>
gc_seconds_wall<span class="w"> </span><span class="m">5481304</span>.0
<span class="c1"># HELP gc_seconds_cpu CPU time spent on last GC</span>
<span class="c1"># TYPE gc_seconds_cpu gauge</span>
gc_seconds_cpu<span class="w"> </span><span class="m">5479828</span>.0
<span class="c1"># HELP gc_bytes_used_current Number of bytes in active use as of the last GC</span>
<span class="c1"># TYPE gc_bytes_used_current gauge</span>
gc_bytes_used_current<span class="w"> </span><span class="m">1535232</span>.0
<span class="c1"># HELP gc_bytes_used_max Maximum amount of memory living on the heap after the last major GC</span>
<span class="c1"># TYPE gc_bytes_used_max gauge</span>
gc_bytes_used_max<span class="w"> </span><span class="m">2685312</span>.0
<span class="c1"># HELP gc_bytes_allocated_total Bytes allocated since the start of the server</span>
<span class="c1"># TYPE gc_bytes_allocated_total gauge</span>
gc_bytes_allocated_total<span class="w"> </span><span class="m">4</span>.949156056e9
</pre></div>
</div>
<p>This example is for Gundeck, but you can also get metrics for other services. All k8s services are listed at <a class="reference internal" href="../../understand/overview.html#overview"><span class="std std-ref">this link</span></a>.</p>
<p>This is an example adapted for Cannon:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>--kubeconfig<span class="w"> </span>kubeconfig.dec<span class="w"> </span>-n<span class="w"> </span>wire<span class="w"> </span>port-forward<span class="w"> </span>service/cannon<span class="w"> </span><span class="m">7777</span>:8080
curl<span class="w"> </span>-v<span class="w"> </span>http://127.0.0.1:7777/i/metrics
</pre></div>
</div>
<p>In the output of this command, <code class="docutils literal notranslate"><span class="pre">net_websocket_clients</span></code> is roughly the number of connected clients.</p>
</section>
<section id="reset-session-cookies">
<span id="id1"></span><h2>Reset session cookies<a class="headerlink" href="#reset-session-cookies" title="Permalink to this heading"></a></h2>
<p>Remove session cookies on your system to force users to login again within the next 15 minutes (or whenever they come back online):</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This will cause interruptions to ongoing calls and should be timed properly.</p>
</div>
<section id="reset-cookies-of-all-users">
<h3>Reset cookies of all users<a class="headerlink" href="#reset-cookies-of-all-users" title="Permalink to this heading"></a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>&lt;name<span class="w"> </span>or<span class="w"> </span>IP<span class="w"> </span>of<span class="w"> </span>brig-cassandra&gt;
<span class="c1"># from the ssh session</span>
cqlsh
<span class="c1"># from the cqlsh shell</span>
truncate<span class="w"> </span>brig.user_cookies<span class="p">;</span>
</pre></div>
</div>
</section>
<section id="reset-cookies-for-a-defined-list-of-users">
<h3>Reset cookies for a defined list of users<a class="headerlink" href="#reset-cookies-for-a-defined-list-of-users" title="Permalink to this heading"></a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>&lt;name<span class="w"> </span>or<span class="w"> </span>IP<span class="w"> </span>of<span class="w"> </span>brig-cassandra&gt;
<span class="c1"># within the ssh session</span>
cqlsh
<span class="c1"># within the cqlsh shell: delete all users by userId</span>
delete<span class="w"> </span>from<span class="w"> </span>brig.user_cookies<span class="w"> </span>where<span class="w"> </span>user<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">(</span>c0d64244-8ab4-11ec-8fda-37788be3a4e2,<span class="w"> </span>...<span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
<p>(Keep reading if you want to find out which users on your system are using SSO.)</p>
</section>
</section>
<section id="identify-sso-users">
<span id="identify-all-users-using-sso"></span><h2>Identify all users using SSO<a class="headerlink" href="#identify-sso-users" title="Permalink to this heading"></a></h2>
<p>Collect all teams configured with an IdP:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>&lt;name<span class="w"> </span>or<span class="w"> </span>IP<span class="w"> </span>of<span class="w"> </span>spar-cassandra&gt;
<span class="c1"># within the ssh session start cqlsh</span>
cqlsh
<span class="c1"># within the cqlsh shell export all teams with idp</span>
copy<span class="w"> </span>spar.idp<span class="w"> </span><span class="o">(</span>team<span class="o">)</span><span class="w"> </span>TO<span class="w"> </span><span class="s1">&#39;teams_with_idp.csv&#39;</span><span class="w"> </span>with<span class="w"> </span><span class="nv">header</span><span class="o">=</span>false<span class="p">;</span>
</pre></div>
</div>
<p>Close the session and proceed locally:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># download csv file</span>
scp<span class="w"> </span>&lt;name<span class="w"> </span>or<span class="w"> </span>IP<span class="w"> </span>of<span class="w"> </span>spar-cassandra&gt;:teams_with_idp.csv<span class="w"> </span>.
<span class="c1"># convert to a single line, comma separated list</span>
tr<span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span>&lt;<span class="w"> </span>teams_with_idp.csv<span class="p">;</span><span class="w"> </span><span class="nb">echo</span>
</pre></div>
</div>
<p>And use this list to get all team members in these teams:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>&lt;name<span class="w"> </span>or<span class="w"> </span>IP<span class="w"> </span>of<span class="w"> </span>galley-cassandra&gt;
<span class="c1"># within the ssh session start cqlsh</span>
cqlsh
<span class="c1"># within the cqlsh shell select all members of previous identified teams</span>
<span class="c1"># &lt;output of tr&gt; should look like this: f2207d98-8ab3-11ec-b689-07fc1fd409c9, ...</span>
<span class="k">select</span><span class="w"> </span>user<span class="w"> </span>from<span class="w"> </span>galley.team_member<span class="w"> </span>where<span class="w"> </span>team<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">(</span>&lt;output<span class="w"> </span>of<span class="w"> </span>tr&gt;<span class="o">)</span><span class="p">;</span>
<span class="c1"># alternatively, export the list of all users (for filterling locally in eg. excel)</span>
copy<span class="w"> </span>galley.team_member<span class="w"> </span><span class="o">(</span>user,<span class="w"> </span>team,<span class="w"> </span>sso_id<span class="o">)</span><span class="w"> </span>TO<span class="w"> </span><span class="s1">&#39;users_with_idp.csv&#39;</span><span class="w"> </span>with<span class="w"> </span><span class="nv">header</span><span class="o">=</span>true<span class="p">;</span>
</pre></div>
</div>
<p>Close the session and proceed locally to generate the list of all users from teams with IdP:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># download csv file</span>
scp<span class="w"> </span>&lt;name<span class="w"> </span>or<span class="w"> </span>IP<span class="w"> </span>of<span class="w"> </span>brig-cassandra&gt;:users_with_idp.csv<span class="w"> </span>.
<span class="c1"># convert to a single line, comma separated list</span>
tr<span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span>&lt;<span class="w"> </span>users_with_idp.csv<span class="p">;</span><span class="w"> </span><span class="nb">echo</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Don’t forget to dellete the created csv files after you have downloaded/processed them.</p>
</div>
</section>
<section id="create-a-team-using-the-scim-api">
<h2>Create a team using the SCIM API<a class="headerlink" href="#create-a-team-using-the-scim-api" title="Permalink to this heading"></a></h2>
<p>If you need to create a team manually, maybe because team creation was blocked in the “teams” interface, follow this procedure:</p>
<p>First download or locate this bash script: <code class="docutils literal notranslate"><span class="pre">wire-server/hack/bin/create_test_team_scim.sh</span> <span class="pre">&lt;https://github.com/wireapp/wire-server/blob/develop/hack/bin/create_test_team_scim.sh&gt;</span></code></p>
<p>Then, run it the following way:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./create_test_team_scim.sh<span class="w"> </span>-h<span class="w"> </span>&lt;brig<span class="w"> </span>host&gt;<span class="w"> </span>-s<span class="w"> </span>&lt;spar<span class="w"> </span>host&gt;
</pre></div>
</div>
<p>Where:</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">-h</span> <span class="pre">&lt;brig</span> <span class="pre">host&gt;</span></code>, replace <code class="docutils literal notranslate"><span class="pre">&lt;brig</span> <span class="pre">host&gt;</span></code> with the base URL for your brig host (for example: <code class="docutils literal notranslate"><span class="pre">https://brig-host.your-domain.com</span></code>, defaults to <code class="docutils literal notranslate"><span class="pre">http://localhost:8082</span></code>)</p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">&lt;spar</span> <span class="pre">host&gt;</span></code>, replace <code class="docutils literal notranslate"><span class="pre">&lt;spar</span> <span class="pre">host&gt;</span></code> with the base URL for your spar host (for example: <code class="docutils literal notranslate"><span class="pre">https://spar-host.your-domain.com</span></code>, defaults to <code class="docutils literal notranslate"><span class="pre">http://localhost:8088</span></code>)</p></li>
</ul>
<p>You might also need to edit the admin email and admin passwords at lines <code class="docutils literal notranslate"><span class="pre">48</span></code> and <code class="docutils literal notranslate"><span class="pre">49</span></code> of the script.</p>
<p>To learn more about the different pods and how to identify them, see <code class="docutils literal notranslate"><span class="pre">this</span> <span class="pre">page&lt;https://docs.wire.com/understand/overview.html#focus-on-pods&gt;</span></code>.</p>
<p>You can list your pods with <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pods</span> <span class="pre">--namespace</span> <span class="pre">wire</span></code>.</p>
<p>Alternatively, you can run the series of commands manually with <code class="docutils literal notranslate"><span class="pre">curl</span></code>, like this:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-i<span class="w"> </span>-s<span class="w"> </span>--show-error<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-XPOST<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BRIG_HOST</span><span class="s2">/i/users&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-H<span class="s1">&#39;Content-type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-d<span class="s1">&#39;{&quot;email&quot;:&quot;$ADMIN_EMAIL&quot;,&quot;password&quot;:&quot;$ADMIN_PASSWORD&quot;,&quot;name&quot;:&quot;$NAME_OF_TEAM&quot;,&quot;team&quot;:{&quot;name&quot;:&quot;$NAME_OF_TEAM&quot;,&quot;icon&quot;:&quot;default&quot;}}&#39;</span>
</pre></div>
</div>
<p>Where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$BRIG_HOST</span></code> is the base URL for your brig host</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$ADMIN_EMAIL</span></code> is the email for the admin account for the new team</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$ADMIN_PASSWORD</span></code> is the password for the admin account for the new team</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$NAME_OF_TEAM</span></code> is the name of the team newly created</p></li>
</ul>
<p>Out of the result of this command, you will be able to extract an <code class="docutils literal notranslate"><span class="pre">Admin</span> <span class="pre">UUID</span></code>, and a <code class="docutils literal notranslate"><span class="pre">Team</span> <span class="pre">UUID</span></code>, which you will need later.</p>
<p>Then run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--header<span class="w"> </span><span class="s1">&#39;Accept: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;email&quot;:&quot;$ADMIN_EMAIL&quot;,&quot;password&quot;:&quot;$ADMIN_PASSWORD&quot;}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="nv">$BRIG_HOST</span>/login<span class="s1">&#39;?persist=false&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span>.access_token
</pre></div>
</div>
<p>Where the values to replace are the same as the command above.</p>
<p>This command should output an access token, take note of it.</p>
<p>Then run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="se">\</span>
<span class="w">                </span>--header<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$ACCESS_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                </span>--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/json;charset=utf-8&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                </span>--header<span class="w"> </span><span class="s1">&#39;Z-User: &#39;</span><span class="s2">&quot;</span><span class="nv">$ADMIN_UUID</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                </span>-d<span class="w"> </span><span class="s1">&#39;{ &quot;description&quot;: &quot;test &#39;</span><span class="s2">&quot;`date`&quot;</span><span class="s1">&#39;&quot;, &quot;password&quot;: &quot;&#39;</span><span class="s2">&quot;</span><span class="nv">$ADMIN_PASSWORD</span><span class="s2">&quot;</span><span class="s1">&#39;&quot; }&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                </span><span class="nv">$SPAR_HOST</span>/scim/auth-tokens
</pre></div>
</div>
<p>Where the values to replace are the same as the first command, plus <code class="docutils literal notranslate"><span class="pre">$ACCESS_TOKEN</span></code> is access token you just took note of in the previous command.</p>
<p>Out of the JSON  output of this command, you should be able to extract:</p>
<ul class="simple">
<li><p>A SCIM token (<code class="docutils literal notranslate"><span class="pre">token</span></code> value in the JSON).</p></li>
<li><p>A SCIM token ID (<code class="docutils literal notranslate"><span class="pre">id</span></code> value in the <code class="docutils literal notranslate"><span class="pre">info</span></code> value in the JSON)</p></li>
</ul>
<p>Equiped with those tokens, we move on to the next script, <code class="docutils literal notranslate"><span class="pre">wire-server/hack/bin/create_team.sh</span> <span class="pre">&lt;https://github.com/wireapp/wire-server/blob/develop/hack/bin/create_team.sh&gt;</span></code></p>
<p>This script can be run the following way:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./create_team.sh<span class="w"> </span>-h<span class="w"> </span>&lt;host&gt;<span class="w"> </span>-o<span class="w"> </span>&lt;owner<span class="w"> </span>name&gt;<span class="w"> </span>-e<span class="w"> </span>&lt;owner<span class="w"> </span>email&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;owner<span class="w"> </span>password&gt;<span class="w"> </span>-v<span class="w"> </span>&lt;email<span class="w"> </span>code&gt;<span class="w"> </span>-t<span class="w"> </span>&lt;team<span class="w"> </span>name&gt;<span class="w"> </span>-c<span class="w"> </span>&lt;team<span class="w"> </span>currency&gt;
</pre></div>
</div>
<p>Where:</p>
<ul class="simple">
<li><p>-h &lt;host&gt;: Base URI of brig. default: <code class="docutils literal notranslate"><span class="pre">http://localhost:8080</span></code></p></li>
<li><p>-o &lt;owner_name&gt;: user display name of the owner of the team to be created.  default: “owner name n/a”</p></li>
<li><p>-e &lt;owner_email&gt;: email address of the owner of the team to be created.  default: “owner email n/a”</p></li>
<li><p>-p &lt;owner_password&gt;: owner password.  default: “owner pass n/a”</p></li>
<li><p>-v &lt;email_code&gt;: validation code received by email after running the previous script/commands.  default: “email code n/a”</p></li>
<li><p>-t &lt;team_name&gt;: default: “team name n/a”</p></li>
<li><p>-c &lt;team_currency&gt;: default: “USD”</p></li>
</ul>
<p>Alternatively, you can manually run the command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-i<span class="w"> </span>-s<span class="w"> </span>--show-error<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-XPOST<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BRIG_HOST</span><span class="s2">/register&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="s1">&#39;Content-type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-d<span class="s1">&#39;{&quot;name&quot;:&quot;$OWNER_NAME&quot;,&quot;email&quot;:&quot;$OWNER_EMAIL&quot;,&quot;password&quot;:&quot;$OWNER_PASSWORD&quot;,&quot;email_code&quot;:&quot;$EMAIL_CODE&quot;,&quot;team&quot;:{&quot;currency&quot;:&quot;$TEAM_CURRENCY&quot;,&quot;icon&quot;:&quot;default&quot;,&quot;name&quot;:&quot;$TEAM_NAME&quot;}}&#39;</span>
</pre></div>
</div>
<p>Where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$BRIG_HOST</span></code> is the base URL for your brig service</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$OWNER_NAME</span></code> is the name of the of the team to be created</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$OWNER_PASSWORD</span></code> is the password of the owner of the team to be created</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$EMAIL_CODE</span></code> is the validation code received by email after running the previous script/command</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$TEAM_CURRENCY</span></code> is the currency of the team</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$TEAM_NAME</span></code> is the name of the team</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="restund.html" class="btn btn-neutral float-left" title="Restund (TURN)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../understand/index.html" class="btn btn-neutral float-right" title="Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>