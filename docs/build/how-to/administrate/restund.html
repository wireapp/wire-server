<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restund (TURN) &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Investigative tasks (e.g. searching for users as server admin)" href="users.html" />
    <link rel="prev" title="Operational procedures" href="operations.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../index.html">
        <img src="../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/index.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Administration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup-disaster-recovery.html">Backup and disaster recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="cassandra.html">Cassandra</a></li>
<li class="toctree-l2"><a class="reference internal" href="elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="etcd.html">Etcd</a></li>
<li class="toctree-l2"><a class="reference internal" href="general-linux.html">General - Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="minio.html">Minio</a></li>
<li class="toctree-l2"><a class="reference internal" href="operations.html">Operational procedures</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Restund (TURN)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#wire-server-configuration">Wire-Server Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#static-list">Static List</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dns-srv-records">DNS SRV Records</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-see-how-many-people-are-currently-connected-to-the-restund-server">How to see how many people are currently connected to the restund server</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-restart-restund-with-downtime">How to restart restund (with downtime)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rebooting-a-restund-node">Rebooting a Restund node</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-restart-restund-without-having-downtime">How to restart restund without having downtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-renew-a-certificate-for-restund">How to renew a certificate for restund</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-check-which-restund-turn-servers-will-be-used-by-clients">How to check which restund/TURN servers will be used by clients</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="users.html">Investigative tasks (e.g. searching for users as server admin)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../understand/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developers Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Administration</a></li>
      <li class="breadcrumb-item active">Restund (TURN)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/how-to/administrate/restund.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="restund-turn">
<h1>Restund (TURN)<a class="headerlink" href="#restund-turn" title="Permalink to this heading"></a></h1>
<p>This section is about <strong>how to perform a specific task</strong>. If you want to <strong>understand how a certain component works, please see</strong> <a class="reference internal" href="../../understand/index.html#understand"><span class="std std-ref">Reference</span></a></p>
<p>The rest of the page assumes you installed using the ansible playbooks from <a class="reference external" href="https://github.com/wireapp/wire-server-deploy/tree/master/ansible">wire-server-deploy</a></p>
<p>For any command below, first ssh into the server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">&lt;</span><span class="n">name</span> <span class="ow">or</span> <span class="n">IP</span> <span class="n">of</span> <span class="n">the</span> <span class="n">VM</span><span class="o">&gt;</span>
</pre></div>
</div>
<section id="wire-server-configuration">
<span id="allocations"></span><h2>Wire-Server Configuration<a class="headerlink" href="#wire-server-configuration" title="Permalink to this heading"></a></h2>
<p>The wire-server can either serve a static list of TURN servers to the clients or
it can discovery them using DNS SRV Records.</p>
<section id="static-list">
<h3>Static List<a class="headerlink" href="#static-list" title="Permalink to this heading"></a></h3>
<p>To configure a static list of TURN servers to use, override
<code class="docutils literal notranslate"><span class="pre">values/wire-server/values.yaml</span></code> like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># (...)</span>

<span class="nt">brig</span><span class="p">:</span>
<span class="c1"># (...)</span>
<span class="w">  </span><span class="nt">turnStatic</span><span class="p">:</span>
<span class="w">    </span><span class="nt">v1</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># v1 entries can be ignored and are not in use anymore since end of 2018.</span>
<span class="w">    </span><span class="nt">v2</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server1.example.com:3478</span><span class="w"> </span><span class="c1"># server 1 UDP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server1.example.com:3478?transport=tcp</span><span class="w"> </span><span class="c1"># server 1 TCP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turns:server1.example.com:5478?transport=tcp</span><span class="w"> </span><span class="c1"># server 1 TLS</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server2.example.com:3478</span><span class="w"> </span><span class="c1"># server 2 UDP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server2.example.com:3478?transport=tcp</span><span class="w"> </span><span class="c1"># server 2 TCP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turns:server2.example.com:5478?transport=tcp</span><span class="w"> </span><span class="c1"># server 2 TLS</span>
<span class="w">  </span><span class="nt">turn</span><span class="p">:</span>
<span class="w">    </span><span class="nt">serversSource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">files</span>
</pre></div>
</div>
</section>
<section id="dns-srv-records">
<h3>DNS SRV Records<a class="headerlink" href="#dns-srv-records" title="Permalink to this heading"></a></h3>
<p>To configure wire-server to use DNS SRV records in order to discover TURN
servers, override <code class="docutils literal notranslate"><span class="pre">values/wire-server/values.yaml</span></code> like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># (...)</span>

<span class="nt">brig</span><span class="p">:</span>
<span class="c1"># (...)</span>
<span class="w">  </span><span class="nt">turn</span><span class="p">:</span>
<span class="w">    </span><span class="nt">serversSource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dns</span>
<span class="w">    </span><span class="nt">baseDomain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod.example.com</span>
<span class="w">    </span><span class="nt">discoveryIntervalSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
<p>When configured like this, the wire-server would look for these 3 SRV records
every 10 seconds:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">_turn._udp.prod.example.com</span></code> will be used to discover UDP hostnames and port for all the
turn servers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_turn._tcp.prod.example.com</span></code> will be used to discover the TCP hostnames and port for all
the turn servers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_turns._tcp.prod.example.com</span></code> will be used to discover the TLS hostnames and port for
all the turn servers.</p></li>
</ol>
<p>Entries with weight 0 will be ignored. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dig</span> <span class="o">+</span><span class="n">retries</span><span class="o">=</span><span class="mi">3</span> <span class="o">+</span><span class="n">short</span> <span class="n">SRV</span> <span class="n">_turn</span><span class="o">.</span><span class="n">_udp</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="mi">0</span> <span class="mi">0</span> <span class="mi">3478</span> <span class="n">turn36</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="mi">0</span> <span class="mi">10</span> <span class="mi">3478</span> <span class="n">turn34</span><span class="o">..</span><span class="n">prod</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="mi">0</span> <span class="mi">10</span> <span class="mi">3478</span> <span class="n">turn35</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>At least one of these 3 lookups must succeed for the wire-server to be able to
respond correctly when <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/calls/config/v2</span></code> is called. All successful
responses are served in the result.</p>
<p>In addition, if there are any clients using the legacy endpoint, <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/calls/config</span></code>, (all versions of all mobile apps since 2018 no longer use this) they will be served by the servers listed in the
<code class="docutils literal notranslate"><span class="pre">_turn._udp.prod.example.com</span></code> SRV record. This endpoint, however, will not
serve the domain names received inside the SRV record, instead it will serve the
first <code class="docutils literal notranslate"><span class="pre">A</span></code> record that is associated with each domain name in the SRV record.</p>
</section>
</section>
<section id="how-to-see-how-many-people-are-currently-connected-to-the-restund-server">
<h2>How to see how many people are currently connected to the restund server<a class="headerlink" href="#how-to-see-how-many-people-are-currently-connected-to-the-restund-server" title="Permalink to this heading"></a></h2>
<p>You can see the count of currently ongoing calls (also called “allocations”):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span>turnstats<span class="w"> </span><span class="p">|</span><span class="w"> </span>nc<span class="w"> </span>-u<span class="w"> </span><span class="m">127</span>.0.0.1<span class="w"> </span><span class="m">33000</span><span class="w"> </span>-q1<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>allocs_cur<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f2
</pre></div>
</div>
</section>
<section id="how-to-restart-restund-with-downtime">
<h2>How to restart restund (with downtime)<a class="headerlink" href="#how-to-restart-restund-with-downtime" title="Permalink to this heading"></a></h2>
<p>With downtime, it’s very easy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">restund</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Restarting <code class="docutils literal notranslate"><span class="pre">restund</span></code> means any user that is currently connected to it (i.e. having a call) will lose its audio/video connection. If you wish to have no downtime, check the next section*</p>
</div>
</section>
<section id="rebooting-a-restund-node">
<span id="id1"></span><h2>Rebooting a Restund node<a class="headerlink" href="#rebooting-a-restund-node" title="Permalink to this heading"></a></h2>
<p>If you want to reboot a restund node, you need to make sure the other restund nodes in the cluster are running, so that services are not interrupted by the reboot.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This procedure as described here will cause downtime, even if a second restund server is up; and kill any ongoing audio/video calls. The sections further up describe a downtime and a no-downtime procedure.</p>
</div>
<p>Presuming your two restund nodes are called:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">restund-1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">restund-2</span></code></p></li>
</ul>
<p>To prepare for a reboot of <code class="docutils literal notranslate"><span class="pre">restund-1</span></code>, log into the other restund server (<code class="docutils literal notranslate"><span class="pre">restund-2</span></code>, for example here), and make sure the docker service is running.</p>
<p>List the running containers, to ensure restund is running, by executing:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>-t<span class="w"> </span>&lt;ip<span class="w"> </span>of<span class="w"> </span>restund-2&gt;<span class="w"> </span>sudo<span class="w"> </span>docker<span class="w"> </span>container<span class="w"> </span>ls
</pre></div>
</div>
<p>You should see the following in the results:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>CONTAINER<span class="w"> </span>ID<span class="w">         </span>IMAGE<span class="w">                                </span>COMMAND<span class="w">         </span>STATUS<span class="w">        </span>PORTS<span class="w">    </span>NAMES
&lt;random<span class="w"> </span>hash&gt;<span class="w">        </span>quay.io/wire/restund:v0.4.16b1.0.53<span class="w">  </span><span class="m">22</span><span class="w"> </span>seconds<span class="w"> </span>ago<span class="w">  </span>Up<span class="w"> </span><span class="m">18</span><span class="w"> </span>seconds<span class="w">          </span>restund
</pre></div>
</div>
<p>Make sure you see this restund container, and it is running (“Up”).</p>
<p>If it is not, you need to do troubleshooting work, if it is running, you can move forward and reboot restund-1.</p>
<p>Now log into the restund server you wish to reboot (<code class="docutils literal notranslate"><span class="pre">restund-1</span></code> in this example), and reboot it</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>-t<span class="w"> </span>&lt;ip<span class="w"> </span>of<span class="w"> </span>restund-1&gt;<span class="w"> </span>sudo<span class="w"> </span>reboot
</pre></div>
</div>
<p>Wait at least a minute for the machine to restart, you can use this command to automatically retry SSH access until it is succesful:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;ConnectionAttempts 3600&#39;</span><span class="w"> </span>&lt;ip<span class="w"> </span>of<span class="w"> </span>restund-1<span class="w"> </span>node&gt;<span class="w"> </span><span class="nb">exit</span>
</pre></div>
</div>
<p>Then log into the restund server (<code class="docutils literal notranslate"><span class="pre">restund-1</span></code>, in this example), and make sure the docker service is running:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>-t<span class="w"> </span>&lt;ip<span class="w"> </span>of<span class="w"> </span>restund-1&gt;<span class="w"> </span>sudo<span class="w"> </span>docker<span class="w"> </span>container<span class="w"> </span>ls
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>CONTAINER<span class="w"> </span>ID<span class="w">         </span>IMAGE<span class="w">                                </span>COMMAND<span class="w">         </span>STATUS<span class="w">        </span>PORTS<span class="w">    </span>NAMES
&lt;random<span class="w"> </span>hash&gt;<span class="w">        </span>quay.io/wire/restund:v0.4.16b1.0.53<span class="w">  </span><span class="m">22</span><span class="w"> </span>seconds<span class="w"> </span>ago<span class="w">  </span>Up<span class="w"> </span><span class="m">18</span><span class="w"> </span>seconds<span class="w">          </span>restund
</pre></div>
</div>
<p>Here again, make sure you see a restund container, and it is running (“Up”).</p>
<p>If it is, you have succesfully reboot the restund server, and can if you need to apply the same procedure to the other restund servers in your cluster.</p>
</section>
<section id="how-to-restart-restund-without-having-downtime">
<h2>How to restart restund without having downtime<a class="headerlink" href="#how-to-restart-restund-without-having-downtime" title="Permalink to this heading"></a></h2>
<p>For maintenance you may need to restart a restund server.</p>
<ol class="arabic simple">
<li><p>Remove that restund server you want to restart from the list of advertised nodes, by taking it out of the turn server list that brig advertises:</p></li>
</ol>
<p>Go to the place where you store kubernetes configuration for your wire-server installation. This might be a directory on your admin laptop, or a directory on the kubernetes machine.</p>
<p>If your override configuration (<code class="docutils literal notranslate"><span class="pre">values/wire-server/values.yaml</span></code>) looks like the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># (...)</span>

<span class="nt">brig</span><span class="p">:</span>
<span class="c1"># (...)</span>
<span class="w">  </span><span class="nt">turnStatic</span><span class="p">:</span>
<span class="w">    </span><span class="nt">v1</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># v1 entries can be ignored and are not in use anymore since end of 2018.</span>
<span class="w">    </span><span class="nt">v2</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server1.example.com:3478</span><span class="w"> </span><span class="c1"># server 1 UDP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server1.example.com:3478?transport=tcp</span><span class="w"> </span><span class="c1"># server 1 TCP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turns:server1.example.com:5478?transport=tcp</span><span class="w"> </span><span class="c1"># server 1 TLS</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server2.example.com:3478</span><span class="w"> </span><span class="c1"># server 2 UDP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server2.example.com:3478?transport=tcp</span><span class="w"> </span><span class="c1"># server 2 TCP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turns:server2.example.com:5478?transport=tcp</span><span class="w"> </span><span class="c1"># server 2 TLS</span>
</pre></div>
</div>
<p>And you want to remove server 1, then change the configuration to read</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">turnStatic</span><span class="p">:</span>
<span class="w">  </span><span class="nt">v2</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server2.example.com:3478</span><span class="w"> </span><span class="c1"># server 2 UDP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server2.example.com:3478?transport=tcp</span><span class="w"> </span><span class="c1"># server 2 TCP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turns:server2.example.com:5478?transport=tcp</span><span class="w"> </span><span class="c1"># server 2 TLS</span>
</pre></div>
</div>
<p>(or comment out lines by adding a <code class="docutils literal notranslate"><span class="pre">#</span></code> in front of the respective line)</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">turnStatic</span><span class="p">:</span>
<span class="w">  </span><span class="nt">v2</span><span class="p">:</span>
<span class="w">  </span><span class="c1">#- turn:server1.example.com:3478 # server 1 UDP</span>
<span class="w">  </span><span class="c1">#- turn:server1.example.com:3478?transport=tcp # server 1 TCP</span>
<span class="w">  </span><span class="c1">#- turns:server1.example.com:5478?transport=tcp # server 1 TLS</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server2.example.com:3478</span><span class="w"> </span><span class="c1"># server 2 UDP</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turn:server2.example.com:3478?transport=tcp</span><span class="w"> </span><span class="c1"># server 2 TCP</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turns:server2.example.com:5478?transport=tcp</span><span class="w"> </span><span class="c1"># server 2 TLS</span>
</pre></div>
</div>
<p>Next, apply these changes to configuration with <code class="docutils literal notranslate"><span class="pre">./bin/prod-setup.sh</span></code></p>
<p>You then need to restart the <code class="docutils literal notranslate"><span class="pre">brig</span></code> pods if your code is older than September 2019 (otherwise brig will restart itself automatically):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>brig
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Wait for traffic to drain. This can take up to 12 hours after the configuration change. Wait until current allocations (people connected to the restund server) return 0. See <a class="reference internal" href="#allocations"><span class="std std-ref">Wire-Server Configuration</span></a>.</p></li>
<li><p>It’s now safe to <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">stop</span> <span class="pre">restund</span></code>, and take any necessary actions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">restund</span></code> and then add the restund server back to configuration of advertised nodes (see step 1, put the server back).</p></li>
</ol>
</section>
<section id="how-to-renew-a-certificate-for-restund">
<h2>How to renew a certificate for restund<a class="headerlink" href="#how-to-renew-a-certificate-for-restund" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Replace the certificate file on the server (under <code class="docutils literal notranslate"><span class="pre">/etc/restund/restund.pem</span></code> usually), either with ansible or manually. Ensure the new certificate file is a concatenation of your whole certificate chain <em>and</em> the private key:</p></li>
</ol>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Restart restund (see sections above)</p></li>
</ol>
</section>
<section id="how-to-check-which-restund-turn-servers-will-be-used-by-clients">
<h2>How to check which restund/TURN servers will be used by clients<a class="headerlink" href="#how-to-check-which-restund-turn-servers-will-be-used-by-clients" title="Permalink to this heading"></a></h2>
<p>The list of turn servers contacted by clients <em>should</em> match what you added to your <code class="docutils literal notranslate"><span class="pre">turnStatic</span></code> configuration. But if you’d like to double-check, here’s how:</p>
<p>Terminal one:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>port-forward<span class="w"> </span>svc/brig<span class="w"> </span><span class="m">9999</span>:8080
</pre></div>
</div>
<p>Terminal two:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span>/proc/sys/kernel/random/uuid<span class="k">)</span>
curl<span class="w"> </span>-s<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Z-User:</span><span class="nv">$UUID</span><span class="s2">&quot;</span><span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Z-Connection:anything&quot;</span><span class="w"> </span><span class="s2">&quot;http://localhost:9999/calls/config/v2&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>json_pp
</pre></div>
</div>
<p>May return something like:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;ice_servers&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;credential&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ASyFLXqbmg8fuK4chJG3S1Qg4L/nnhpkN0/UctdtTFbGW1AcuuAaOqUMDhm9V2w7zKHY6PPMqjhwKZ2neSE78g==&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;urls&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;turn:turn1.example.com:3478&quot;</span>
<span class="w">         </span><span class="p">],</span>
<span class="w">         </span><span class="nt">&quot;username&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d=1582157904.v=1.k=0.t=s.r=mbzovplogqxbasbf&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;credential&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ZsxEtGWbpUZ3QWxPZtbX6g53HXu6PWfhhUfGNqRBJjrsly5w9IPAsuAWLEOP7fsoSXF13mgSPROXxMYAB/fQ6g==&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;urls&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;turn:turn1.example.com:3478?transport=tcp&quot;</span>
<span class="w">         </span><span class="p">],</span>
<span class="w">         </span><span class="nt">&quot;username&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d=1582157904.v=1.k=0.t=s.r=jsafnwtgqhfqjvco&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;credential&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ZsxEtGWbpUZ3QWxPZtbX6g53HXu6PWfhhUfGNqRBJjrsly5w9IPAsuAWLEOP7fsoSXF13mgSPROXxMYAB/fQ6g==&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;urls&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;turns:turn1.example.com:5349?transport=tcp&quot;</span>
<span class="w">         </span><span class="p">],</span>
<span class="w">         </span><span class="nt">&quot;username&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d=1582157904.v=1.k=0.t=s.r=jsafnwtgqhfqjvco&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">],</span>
<span class="w">   </span><span class="nt">&quot;ttl&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the above case, there is a single server configured to use UDP on port 3478, plain TCP on port 3478, and TLS over TCP on port 5349. The ordering of the list is random and will change on every request made with curl.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="operations.html" class="btn btn-neutral float-left" title="Operational procedures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="users.html" class="btn btn-neutral float-right" title="Investigative tasks (e.g. searching for users as server admin)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>