<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to renew certificates on kubernetes 1.14.x &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Restarting a machine in a Kubernetes cluster" href="../restart-machines/index.html" />
    <link rel="prev" title="Certificate renewal" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../../../index.html">
        <img src="../../../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/index.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Administration</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Kubernetes</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Certificate renewal</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">How to renew certificates on kubernetes 1.14.x</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../restart-machines/index.html">How to restart a machine that is part of a Kubernetes cluster?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrade-cluster/index.html">Upgrading a Kubernetes cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrade-cluster/index.html#troubleshooting-problems-arising-after-kubernetes-cluster-upgrades">Troubleshooting problems arising after kubernetes cluster upgrades</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../backup-disaster-recovery.html">Backup and disaster recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cassandra.html">Cassandra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../elasticsearch.html">Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etcd.html">Etcd</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../general-linux.html">General - Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../minio.html">Minio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations.html">Operational procedures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../restund.html">Restund (TURN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../users.html">Investigative tasks (e.g. searching for users as server admin)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../understand/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer/index.html">Developers Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Administration</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Kubernetes</a></li>
          <li class="breadcrumb-item"><a href="index.html">Certificate renewal</a></li>
      <li class="breadcrumb-item active">How to renew certificates on kubernetes 1.14.x</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/how-to/administrate/kubernetes/certificate-renewal/scenario-1_k8s-v1.14-kubespray.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-renew-certificates-on-kubernetes-1-14-x">
<h1>How to renew certificates on kubernetes 1.14.x<a class="headerlink" href="#how-to-renew-certificates-on-kubernetes-1-14-x" title="Permalink to this heading"></a></h1>
<p>Kubernetes-internal certificates by default (see assumptions) expire after one year. Without renewal, your installation will cease to function.
This page explains how to renew certificates.</p>
<section id="assumptions">
<h2>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Kubernetes version 1.14.x</p></li>
<li><p>installed with the help of <a class="reference external" href="https://github.com/kubernetes-sigs/kubespray">Kubespray</a></p>
<ul>
<li><p>This page was tested using kubespray release 2.10 branch from 2019-05-20, i.e. commit <code class="docutils literal notranslate"><span class="pre">e2f5a9748e4dbfe2fdba7931198b0b5f1f4bdc7e</span></code>.</p></li>
</ul>
</li>
<li><p>setup: 3 scheduled nodes, each hosting master (control plane) +
worker (kubelet) + etcd (cluster state, key-value database)</p></li>
</ul>
<p><em>NOTE: due to Kubernetes being installed with Kubespray, the Kubernetes
CAs (expire after 10yr) as well as certificates involved in etcd
communication (expire after 100yr) are not required to be renewed (any
time soon).</em></p>
<p><strong>Official documentation:</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://v1-14.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/">Certificate Management with kubeadm (v1.14)</a></p></li>
<li><p><a class="reference external" href="https://v1-14.docs.kubernetes.io/docs/setup/best-practices/certificates/">PKI certificates and requirements (v1.14)</a></p></li>
</ul>
</section>
<section id="high-level-description">
<h2>High-level description<a class="headerlink" href="#high-level-description" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>verify current expiration date</p></li>
<li><p>issue new certificates</p></li>
<li><p>generate new client configuration (aka kubeconfig file)</p></li>
<li><p>restart control plane</p></li>
<li><p>drain node - restart kubelet - uncordon node again</p></li>
<li><p>repeat 3-5 on all other nodes</p></li>
</ol>
</section>
<section id="step-by-step-instructions">
<h2>Step-by-step instructions<a class="headerlink" href="#step-by-step-instructions" title="Permalink to this heading"></a></h2>
<p><em>Please note, that the following instructions may require privileged
execution. So, either switch to a privileged user or prepend following
statements with ``sudo``. In any case, it is most likely that every
newly created file has to be owned by ``root``, depending on kow
Kubernetes was installed.</em></p>
<ol class="arabic simple">
<li><p>Verify current expiration date on each node</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">K8S_CERT_DIR</span><span class="o">=</span>/etc/kubernetes/pki
<span class="nb">export</span><span class="w"> </span><span class="nv">ETCD_CERT_DIR</span><span class="o">=</span>/etc/ssl/etcd/ssl
<span class="nb">export</span><span class="w"> </span><span class="nv">KUBELET_CERT_DIR</span><span class="o">=</span>/var/lib/kubelet/pki


<span class="k">for</span><span class="w"> </span>crt<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">K8S_CERT_DIR</span><span class="si">}</span>/*.crt<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">expirationDate</span><span class="o">=</span><span class="k">$(</span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-text<span class="w"> </span>-in<span class="w"> </span><span class="si">${</span><span class="nv">crt</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>After<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/^[[:space:]]*//&#39;</span><span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="si">${</span><span class="nv">crt</span><span class="si">}</span><span class="k">)</span><span class="s2"> -- </span><span class="si">${</span><span class="nv">expirationDate</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">done</span>


<span class="k">for</span><span class="w"> </span>crt<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>ls<span class="w"> </span><span class="si">${</span><span class="nv">ETCD_CERT_DIR</span><span class="si">}</span>/*.pem<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">&#39;key&#39;</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">expirationDate</span><span class="o">=</span><span class="k">$(</span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-text<span class="w"> </span>-in<span class="w"> </span><span class="si">${</span><span class="nv">crt</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>After<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/^[[:space:]]*//&#39;</span><span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="si">${</span><span class="nv">crt</span><span class="si">}</span><span class="k">)</span><span class="s2"> -- </span><span class="si">${</span><span class="nv">expirationDate</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">done</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;kubelet-client-current.pem -- </span><span class="k">$(</span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-text<span class="w"> </span>-in<span class="w"> </span><span class="si">${</span><span class="nv">KUBELET_CERT_DIR</span><span class="si">}</span>/kubelet-client-current.pem<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>After<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/^[[:space:]]*//&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;kubelet.crt -- </span><span class="k">$(</span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-text<span class="w"> </span>-in<span class="w"> </span><span class="si">${</span><span class="nv">KUBELET_CERT_DIR</span><span class="si">}</span>/kubelet.crt<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>After<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/^[[:space:]]*//&#39;</span><span class="k">)</span><span class="s2">&quot;</span>


<span class="c1"># MASTER: api-server cert</span>
<span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>localhost:6443<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Not
<span class="c1"># MASTER: controller-manager cert</span>
<span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>localhost:10257<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Not
<span class="c1"># MASTER: scheduler cert</span>
<span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>localhost:10259<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Not

<span class="c1"># WORKER: kubelet cert</span>
<span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>localhost:10250<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Not
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Allocate a terminal session on one node and backup existing
certificates &amp; configurations</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/etc/kubernetes

cp<span class="w"> </span>-r<span class="w"> </span>./ssl<span class="w"> </span>./ssl.bkp

cp<span class="w"> </span>admin.conf<span class="w"> </span>admin.conf.bkp
cp<span class="w"> </span>controller-manager.conf<span class="w"> </span>controller-manager.conf.bkp
cp<span class="w"> </span>scheduler.conf<span class="w"> </span>scheduler.conf.bkp
cp<span class="w"> </span>kubelet.conf<span class="w"> </span>kubelet.conf.bkp
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Renew certificates on that very node</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm<span class="w"> </span>alpha<span class="w"> </span>certs<span class="w"> </span>renew<span class="w"> </span>apiserver
kubeadm<span class="w"> </span>alpha<span class="w"> </span>certs<span class="w"> </span>renew<span class="w"> </span>apiserver-kubelet-client
kubeadm<span class="w"> </span>alpha<span class="w"> </span>certs<span class="w"> </span>renew<span class="w"> </span>front-proxy-client
</pre></div>
</div>
<p><em>Looking at the timestamps of the certificates, it is indicated, that apicerver, kubelet &amp; proxy-client have been
renewed. This can be confirmed, by executing parts of (1).</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@kubenode01:/etc/kubernetes$ ls -al ./ssl
total 56
drwxr-xr-x 2 kube root 4096 Mar 20 17:09 .
drwxr-xr-x 5 kube root 4096 Mar 20 17:08 ..
-rw-r--r-- 1 root root 1517 Mar 20 15:12 apiserver.crt
-rw------- 1 root root 1675 Mar 20 15:12 apiserver.key
-rw-r--r-- 1 root root 1099 Mar 20 15:13 apiserver-kubelet-client.crt
-rw------- 1 root root 1675 Mar 20 15:13 apiserver-kubelet-client.key
-rw-r--r-- 1 root root 1025 Sep 23 14:53 ca.crt
-rw------- 1 root root 1679 Sep 23 14:53 ca.key
-rw-r--r-- 1 root root 1038 Sep 23 14:53 front-proxy-ca.crt
-rw------- 1 root root 1679 Sep 23 14:53 front-proxy-ca.key
-rw-r--r-- 1 root root 1058 Mar 20 15:13 front-proxy-client.crt
-rw------- 1 root root 1675 Mar 20 15:13 front-proxy-client.key
-rw------- 1 root root 1679 Sep 23 14:53 sa.key
-rw------- 1 root root  451 Sep 23 14:53 sa.pub
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Based on those renewed certificates, generate new kubeconfig files</p></li>
</ol>
<p>The first command assumes it’s being executed on a master node. You may need to swap <code class="docutils literal notranslate"><span class="pre">masters</span></code> with <code class="docutils literal notranslate"><span class="pre">nodes</span></code> in
case you are on a different sort of machines.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm<span class="w"> </span>alpha<span class="w"> </span>kubeconfig<span class="w"> </span>user<span class="w"> </span>--org<span class="w"> </span>system:masters<span class="w"> </span>--client-name<span class="w"> </span>kubernetes-admin<span class="w">  </span>&gt;<span class="w"> </span>/etc/kubernetes/admin.conf
kubeadm<span class="w"> </span>alpha<span class="w"> </span>kubeconfig<span class="w"> </span>user<span class="w"> </span>--client-name<span class="w"> </span>system:kube-controller-manager<span class="w"> </span>&gt;<span class="w"> </span>/etc/kubernetes/controller-manager.conf
kubeadm<span class="w"> </span>alpha<span class="w"> </span>kubeconfig<span class="w"> </span>user<span class="w"> </span>--client-name<span class="w"> </span>system:kube-scheduler<span class="w"> </span>&gt;<span class="w"> </span>/etc/kubernetes/scheduler.conf
</pre></div>
</div>
<p><em>Again, check if ownership and permission for these files are the same
as all the others around them.</em></p>
<p>And, in case you are operating the cluster from the current node, you may want to replace the user’s kubeconfig.
Afterwards, compare the backup version with the new one, to see if any configuration (e.g. pre-configured <em>namespace</em>)
might need to be moved over, too.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mv<span class="w"> </span>~/.kube/config<span class="w"> </span>~/.kube/config.bkp
cp<span class="w"> </span>/etc/kubernetes/admin.conf<span class="w"> </span>~/.kube/config
chown<span class="w"> </span><span class="k">$(</span>id<span class="w"> </span>-u<span class="k">)</span>:<span class="k">$(</span>id<span class="w"> </span>-g<span class="k">)</span><span class="w"> </span>~/.kube/config
chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>~/.kube/config
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Now that certificates and configuration files are in place, the
control plane must be restarted. They typically run in containers, so
the easiest way to trigger a restart, is to kill the processes
running in there. Use (1) to verify, that the expiration dates indeed
have been changed.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>SIGHUP<span class="w"> </span><span class="k">$(</span>pidof<span class="w"> </span>kube-apiserver<span class="k">)</span>
<span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>SIGHUP<span class="w"> </span><span class="k">$(</span>pidof<span class="w"> </span>kube-controller-manager<span class="k">)</span>
<span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>SIGHUP<span class="w"> </span><span class="k">$(</span>pidof<span class="w"> </span>kube-scheduler<span class="k">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Make <em>kubelet</em> aware of the new certificate</p></li>
</ol>
<ol class="arabic simple">
<li><p>Drain the node</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl drain --delete-local-data --ignore-daemonsets $(hostname)
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Stop the kubelet process</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">kubelet</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Remove old certificates and configuration</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">kubelet</span><span class="o">/</span><span class="n">pki</span><span class="p">{,</span><span class="n">old</span><span class="p">}</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">kubelet</span><span class="o">/</span><span class="n">pki</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Generate new kubeconfig file for the kubelet</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubeadm alpha kubeconfig user --org system:nodes --client-name system:node:$(hostname) &gt; /etc/kubernetes/kubelet.conf
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Start kubelet again</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">kubelet</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>[Optional] Verify kubelet has recognized certificate rotation</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sleep</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">kubelet</span>
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li><p>Allow workload to be scheduled again on the node</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl uncordon $(hostname)
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li><p>Copy certificates over to all the other nodes</p></li>
</ol>
<p>Option A - you can ssh from one kubernetes node to another</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the ip or hostname:</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NODE2</span><span class="o">=</span>root@ip-or-hostname
<span class="nb">export</span><span class="w"> </span><span class="nv">NODE3</span><span class="o">=</span>...

scp<span class="w"> </span>./ssl/apiserver.*<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE2</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>
scp<span class="w"> </span>./ssl/apiserver.*<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE3</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>

scp<span class="w"> </span>./ssl/apiserver-kubelet-client.*<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE2</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>
scp<span class="w"> </span>./ssl/apiserver-kubelet-client.*<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE3</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>

scp<span class="w"> </span>./ssl/front-proxy-client.*<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE2</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>
scp<span class="w"> </span>./ssl/front-proxy-client.*<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE3</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>
</pre></div>
</div>
<p>Option B - copy via local administrator’s machine</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the ip or hostname:</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NODE1</span><span class="o">=</span>root@ip-or-hostname
<span class="nb">export</span><span class="w"> </span><span class="nv">NODE2</span><span class="o">=</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NODE3</span><span class="o">=</span>

scp<span class="w"> </span>-3<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/apiserver.*&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE2</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>
scp<span class="w"> </span>-3<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/apiserver.*&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE3</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>

scp<span class="w"> </span>-3<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/apiserver-kubelet-client.*&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE2</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>
scp<span class="w"> </span>-3<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/apiserver-kubelet-client.*&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE3</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>

scp<span class="w"> </span>-3<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/front-proxy-client.*&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE2</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>
scp<span class="w"> </span>-3<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE1</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/front-proxy-client.*&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NODE3</span><span class="si">}</span><span class="s2">:/etc/kubernetes/ssl/&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li><p>Continue again with (4) for each node that is left</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Certificate renewal" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../restart-machines/index.html" class="btn btn-neutral float-right" title="Restarting a machine in a Kubernetes cluster" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>