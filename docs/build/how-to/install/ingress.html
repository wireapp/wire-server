<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ingress traffic to wire-server (ingress-nginx-controller) &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Web app settings" href="web-app-settings.html" />
    <link rel="prev" title="Installing centralized logging dashboards using Kibana" href="logging.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../index.html">
        <img src="../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Installation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="planning.html">How to plan an installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="version-requirements.html">Version requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="dependencies.html">Dependencies on operator’s machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="kubernetes.html">How to install kubernetes (Demo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="helm.html">How to install wire-server using Helm (Demo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="prod-intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="ansible-VMs.html">How to install kubernetes and databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="aws-prod.html">How to configure AWS services</a></li>
<li class="toctree-l2"><a class="reference internal" href="helm-prod.html">How to install wire-server using Helm</a></li>
<li class="toctree-l2"><a class="reference internal" href="infrastructure-configuration.html">Infrastructure configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">How to monitor wire-server</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">How to see centralized logs for wire-server</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Ingress-controller (getting traffic in)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installing-in-a-cloud-like-environment">Installing in a cloud-like environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installing-on-bare-metal-without-dynamic-load-balancer-support">Installing on bare-metal without dynamic load balancer support</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-nodeport-not-the-default-with-externaltrafficpolicy-local-the-default">Using NodePort (not the default) with externalTrafficPolicy=Local (the default)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="web-app-settings.html">Web app settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="sft.html">Installing Conference Calling 2.0 (aka SFT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="restund.html">Installing Restund</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls.html">Configure TLS ciphers</a></li>
<li class="toctree-l2"><a class="reference internal" href="ansible-authentication.html">Managing authentication with ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="ansible-tinc.html">Using tinc</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html">Troubleshooting during installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="post-install.html">Verifying your installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../administrate/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../understand/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developers Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Installation</a></li>
      <li class="breadcrumb-item active">Ingress traffic to wire-server (ingress-nginx-controller)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/how-to/install/ingress.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ingress-traffic-to-wire-server-ingress-nginx-controller">
<h1>Ingress traffic to wire-server (ingress-nginx-controller)<a class="headerlink" href="#ingress-traffic-to-wire-server-ingress-nginx-controller" title="Permalink to this heading"></a></h1>
<p><em>at the time of writing (2023-03), this section assumes you use a kubernetes
version 1.23 or above (tested with 1.26)</em></p>
<section id="installing-in-a-cloud-like-environment">
<h2>Installing in a cloud-like environment<a class="headerlink" href="#installing-in-a-cloud-like-environment" title="Permalink to this heading"></a></h2>
<p>Install the ingress controller chart in your helmfile with the defaults, simply
like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># helmfile.yaml</span>
<span class="nt">repositories</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wire</span>
<span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://s3-eu-west-1.amazonaws.com/public.wire.com/charts&#39;</span>

<span class="nt">releases</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ingress-nginx-controller&#39;</span>
<span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;wire&#39;</span>
<span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;wire/ingress-nginx-controller&#39;</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;CHANGE_ME&#39;</span>

<span class="c1"># charts wire-server and nginx-ingress-services also need to be installed, see other</span>
<span class="c1"># documentation</span>
<span class="c1">#  - name: ...</span>
<span class="c1">#    chart: ...</span>
</pre></div>
</div>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">wire/ingress-nginx-controller</span></code> chart will create a <code class="docutils literal notranslate"><span class="pre">Deployment</span></code>
with services of type <code class="docutils literal notranslate"><span class="pre">LoadBalancer</span></code>, where your kubernetes installation needs
to support dynamic LoadBalancers. If this is not possible, read the next section.</p>
<p>By default three pods will come up and external traffic will be load balanced into these
three pods, which will also do TLS termination and forward traffic to upstream
services (<code class="docutils literal notranslate"><span class="pre">nginz</span></code> and others).</p>
<p>To inspect default TLS settings, see <a class="reference external" href="https://github.com/wireapp/wire-server/blob/develop/charts/ingress-nginx-controller/values.yaml">defaults in the latest code</a> and also see <a class="reference internal" href="tls.html#tls"><span class="std std-ref">Configure TLS ciphers</span></a>.</p>
</section>
<section id="installing-on-bare-metal-without-dynamic-load-balancer-support">
<h2>Installing on bare-metal without dynamic load balancer support<a class="headerlink" href="#installing-on-bare-metal-without-dynamic-load-balancer-support" title="Permalink to this heading"></a></h2>
<p>In case you cannot create a <code class="docutils literal notranslate"><span class="pre">kind:</span> <span class="pre">service</span></code> of <code class="docutils literal notranslate"><span class="pre">type:</span> <span class="pre">LoadBalancer</span></code>, then you
can fall back to manually ensure traffic reaches your installation:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># helmfile.yaml</span>
<span class="nt">releases</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ingress-nginx-controller&#39;</span>
<span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;wire&#39;</span>
<span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;wire/ingress-nginx-controller&#39;</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;CHANGE_ME&#39;</span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;./helm_vars/ingress-nginx-controller/values.yaml&#39;</span>
</pre></div>
</div>
<p>Create this file with the following override values:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># helm_vars/ingress-nginx-controller/values.yaml</span>
<span class="nt">ingress-nginx</span><span class="p">:</span>
<span class="w">  </span><span class="nt">controller</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<span class="w">    </span><span class="nt">service</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</pre></div>
</div>
<p>Then, on each of your kubernetes worker nodes, two ports are exposed: ports
31773 (https) and 31772 (http)</p>
<p>You should add a port-forwarding rule on the node or on the loadbalancer that
forwards ports 443 and 80 to these respective ports. Any traffic hitting the http port is simply getting a http 30x redirect to https.</p>
<p>Downsides of this approach: The NodePort approach always requires manual configuration of some external load balancer/firewall to round-robin between node IPs and is error-prone. It’s also a bit annoying to have to decide on some global ports that may not be used otherwise.</p>
<p>Most managed K8s clusters have support for LoadBalancers, you can also get this for your own clusters in hcloud etc. It’s even possible to do it for pure bare metal, without any “load balancer hardware”, by using BGP or some leadership election over who’s announcing the “load balancer ip” via ARP (https://metallb.universe.tf/configuration/_advanced_l2_configuration/).</p>
<section id="using-nodeport-not-the-default-with-externaltrafficpolicy-local-the-default">
<h3>Using NodePort (not the default) with externalTrafficPolicy=Local (the default)<a class="headerlink" href="#using-nodeport-not-the-default-with-externaltrafficpolicy-local-the-default" title="Permalink to this heading"></a></h3>
<p>Normally, NodePort will listen to traffic on all nodes, and uses kube-proxy
to redirect to the node that actually runs ingress-nginx-controller. However
one problem with this is that this traffic is NAT’ed. This means that nginx
will not have access to the source IP address from which the request
originated.  We want to have this source IP address for potentially logging
and rate-limiting based on it. By setting externalTrafficPolicy: local,
nodes will no longer forward requests to other nodes if they receive a
request that they themselves can not handle. Upside is that the traffic is
now not NAT’ed anymore, and we get access to the source IP address. Downside
is that you need to know beforehand which nodes run a certain pod. However,
with kubernetes a pod can be rescheduled to any node at any time so we can
not trust this.  We could do something with node affinities to decide apriori
on what set of nodes will be publicly reachable and make sure the nginx
controller pods are only ran on there but for now that sounds a bit overkill.
Instead, we just simply run the ingress controller on each node using a
daemonset. This means that any node in the cluster can receive requests and
redirect them to the correct service, whilst maintaining the source ip
address. The ingress controller is sort of taking over the role of what
kube-proxy was doing before.
More information:</p>
<ul class="simple">
<li><p>https://kubernetes.io/docs/tutorials/services/source-ip/#source-ip-for-services-with-typenodeport</p></li>
<li><p>https://kubernetes.github.io/ingress-nginx/deploy/baremetal/</p></li>
</ul>
<p>There are also downsides to setting <code class="docutils literal notranslate"><span class="pre">externalTrafficPolicy:</span> <span class="pre">Local</span></code>, please look at the <a class="reference external" href="https://www.asykim.com/blog/deep-dive-into-kubernetes-external-traffic-policies">following blog post</a>, which very clearly explains the upsides and
downsides of this setting</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="logging.html" class="btn btn-neutral float-left" title="Installing centralized logging dashboards using Kibana" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="web-app-settings.html" class="btn btn-neutral float-right" title="Web app settings" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>