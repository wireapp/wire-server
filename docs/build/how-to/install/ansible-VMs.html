<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Installing kubernetes and databases on VMs with ansible &mdash; Wire 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/wire.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Configuring AWS and wire-server (production) components" href="aws-prod.html" />
    <link rel="prev" title="Introduction" href="prod-intro.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href="../../index.html">
        <img src="../../_static/Wire_logo.svg" class="logo" alt="Logo"/>
    </a>

    <!--
            <div class="version">
                0.0.4
            </div> -->
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../security-responses/index.html">Security responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Installation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="planning.html">How to plan an installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="version-requirements.html">Version requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="dependencies.html">Dependencies on operator’s machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="kubernetes.html">How to install kubernetes (Demo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="helm.html">How to install wire-server using Helm (Demo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="prod-intro.html">Introduction</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to install kubernetes and databases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#assumptions">Assumptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preparing-to-run-ansible">Preparing to run ansible</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-ips-to-hosts-ini">Adding IPs to hosts.ini</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authentication">Authentication</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#running-ansible-to-install-software-on-your-machines">Running ansible to install software on your machines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installing-kubernetes">Installing kubernetes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cassandra">Cassandra</a></li>
<li class="toctree-l4"><a class="reference internal" href="#elasticsearch">ElasticSearch</a></li>
<li class="toctree-l4"><a class="reference internal" href="#minio">Minio</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restund">Restund</a></li>
<li class="toctree-l4"><a class="reference internal" href="#important-checks">IMPORTANT checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installing-helm-charts-prerequisites">Installing helm charts - prerequisites</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="aws-prod.html">How to configure AWS services</a></li>
<li class="toctree-l2"><a class="reference internal" href="helm-prod.html">How to install wire-server using Helm</a></li>
<li class="toctree-l2"><a class="reference internal" href="infrastructure-configuration.html">Infrastructure configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">How to monitor wire-server</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">How to see centralized logs for wire-server</a></li>
<li class="toctree-l2"><a class="reference internal" href="ingress.html">Ingress-controller (getting traffic in)</a></li>
<li class="toctree-l2"><a class="reference internal" href="web-app-settings.html">Web app settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="sft.html">Installing Conference Calling 2.0 (aka SFT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="restund.html">Installing Restund</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls.html">Configure TLS ciphers</a></li>
<li class="toctree-l2"><a class="reference internal" href="ansible-authentication.html">Managing authentication with ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="ansible-tinc.html">Using tinc</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html">Troubleshooting during installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="post-install.html">Verifying your installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../administrate/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../understand/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developers Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Wire</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Installation</a></li>
      <li class="breadcrumb-item active">Installing kubernetes and databases on VMs with ansible</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wireapp/wire-server/blob/develop/docs/src/how-to/install/ansible-VMs.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installing-kubernetes-and-databases-on-vms-with-ansible">
<span id="ansible-vms"></span><h1>Installing kubernetes and databases on VMs with ansible<a class="headerlink" href="#installing-kubernetes-and-databases-on-vms-with-ansible" title="Permalink to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>In a production environment, some parts of the wire-server
infrastructure (such as e.g. cassandra databases) are best configured
outside kubernetes. Additionally, kubernetes can be rapidly set up with
kubespray, via ansible. This section covers installing VMs with ansible.</p>
</section>
<section id="assumptions">
<h2>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>A bare-metal setup (no cloud provider)</p></li>
<li><p>All machines run ubuntu 18.04</p></li>
<li><p>All machines have static IP addresses</p></li>
<li><p>Time on all machines is being kept in sync</p></li>
<li><p>You have the following virtual machines:</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Amount</p></th>
<th class="head"><p>CPU Cores</p></th>
<th class="head"><p>Memory (GB)</p></th>
<th class="head"><p>Disk Space (GB)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Cassandra</p></td>
<td><p>3</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>80</p></td>
</tr>
<tr class="row-odd"><td><p>MinIO</p></td>
<td><p>3</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-even"><td><p>ElasticSearch</p></td>
<td><p>3</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>60</p></td>
</tr>
<tr class="row-odd"><td><p>Kubernetes³</p></td>
<td><p>3</p></td>
<td><p>6¹</p></td>
<td><p>8</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-even"><td><p>Restund⁴</p></td>
<td><p>2</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Per-Server Totals</strong></p></td>
<td><p>—</p></td>
<td><p>11 CPU Cores</p></td>
<td><p>18 GB Memory</p></td>
<td><p>590 GB Disk Space</p></td>
</tr>
<tr class="row-even"><td><p>Admin Host²</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
<td><p>4</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-odd"><td><p>Asset Host²</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
<td><p>4</p></td>
<td><p>100</p></td>
</tr>
<tr class="row-even"><td><p><strong>Per-Server Totals with
Admin and Asset Hosts</strong></p></td>
<td><p>—</p></td>
<td><p>13 CPU Cores</p></td>
<td><p>26 GB Memory</p></td>
<td><p>730 GB Disk Space</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>¹ Kubernetes hosts may need more ressources to support SFT (Conference Calling). See “Conference Calling Hardware Requirements” below.</p></li>
<li><p>² Admin and Asset Hosts can run on any one of the 3 servers, but that server must not allocate additional resources as indicated in the table above.</p></li>
<li><p>³ Etcd is run inside of Kubernetes, hence no specific resource allocation</p></li>
<li><p>⁴ Restund may be hosted on only 2 of the 3 servers, or all 3. Two nodes are enough to ensure high availability of Restund services</p></li>
</ul>
<p>General Hardware Requirements</p>
<ul class="simple">
<li><p>Minimum 3 physical servers required</p></li>
<li><p>Wire has a minimum requirement for a total of 16 Ubuntu 18.04 virtual machines across the 3 servers (in accordance with the table above)</p></li>
</ul>
<p>Conference Calling Hardware Requirements</p>
<ul class="simple">
<li><p>Kubernetes Hosts may need additional resources for SFT services. For concurrent SFT users (SFT = Selective Forwarding Turn-server, ie. Conference calling), we recommend an extra 3% of CPU allocation, evenly distributed across the nodes (i.e. 1% more CPU per kubernetes server). So for every 100 users plan on adding one CPU core on each Kubernetes node. The SFT component runs inside of Kubernetes, and does not require a separate virtual machine for operation.</p></li>
</ul>
<p>(It’s up to you how you create these machines - kvm on a bare metal
machine, VM on a cloud provider, real physical machines, etc.)</p>
</section>
<section id="preparing-to-run-ansible">
<h2>Preparing to run ansible<a class="headerlink" href="#preparing-to-run-ansible" title="Permalink to this heading"></a></h2>
<span class="target" id="adding-ips-to-hostsini"></span><section id="adding-ips-to-hosts-ini">
<h3>Adding IPs to hosts.ini<a class="headerlink" href="#adding-ips-to-hosts-ini" title="Permalink to this heading"></a></h3>
<p>Go to your checked-out wire-server-deploy/ansible folder:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">wire</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">deploy</span><span class="o">/</span><span class="n">ansible</span>
</pre></div>
</div>
<p>Copy the example hosts file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">hosts</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">ini</span> <span class="n">hosts</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Edit the hosts.ini, setting the permanent IPs of the hosts you are
setting up wire on.</p></li>
<li><p>On each of the lines declaring a database service node (
lines in the <code class="docutils literal notranslate"><span class="pre">[all]</span></code> section beginning with cassandra, elasticsearch,
or minio) replace the <code class="docutils literal notranslate"><span class="pre">ansible_host</span></code> values (<code class="docutils literal notranslate"><span class="pre">X.X.X.X</span></code>) with the
IPs of the nodes that you can connect to via SSH. these are the
‘internal’ addresses of the machines, not what a client will be
connecting to.</p></li>
<li><p>On each of the lines declaring a kubernetes node (lines in the <code class="docutils literal notranslate"><span class="pre">[all]</span></code>
section starting with ‘kubenode’) replace the <code class="docutils literal notranslate"><span class="pre">ip</span></code> values
(<code class="docutils literal notranslate"><span class="pre">Y.Y.Y.Y</span></code>) with the IPs which you wish kubernetes to provide
services to clients on, and replace the <code class="docutils literal notranslate"><span class="pre">ansible_host</span></code> values
(<code class="docutils literal notranslate"><span class="pre">X.X.X.X</span></code>) with the IPs of the nodes that you can connect to via
SSH. If the IP you want to provide services on is the same IP that
you use to connect, remove the <code class="docutils literal notranslate"><span class="pre">ip=Y.Y.Y.Y</span></code> completely.</p></li>
<li><p>On each of the lines declaring an <code class="docutils literal notranslate"><span class="pre">etcd</span></code> node (lines in the <code class="docutils literal notranslate"><span class="pre">[all]</span></code>
section starting with etcd), use the same values as you used on the
coresponding kubenode lines in the prior step.</p></li>
<li><p>If you are deploying Restund for voice/video services then on each of the
lines declaring a <code class="docutils literal notranslate"><span class="pre">restund</span></code> node (lines in the <code class="docutils literal notranslate"><span class="pre">[all]</span></code> section
beginning with restund), replace the <code class="docutils literal notranslate"><span class="pre">ansible_host</span></code> values (<code class="docutils literal notranslate"><span class="pre">X.X.X.X</span></code>)
with the IPs of the nodes that you can connect to via SSH.</p></li>
<li><p>Edit the minio variables in <code class="docutils literal notranslate"><span class="pre">[minio:vars]</span></code> (<code class="docutils literal notranslate"><span class="pre">prefix</span></code>, <code class="docutils literal notranslate"><span class="pre">domain</span></code> and <code class="docutils literal notranslate"><span class="pre">deeplink_title</span></code>)
by replacing <code class="docutils literal notranslate"><span class="pre">example.com</span></code> with your own domain.</p></li>
</ul>
<p>There are more settings in this file that we will set in later steps.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Some of these playbooks mess with the hostnames of their targets. You
MUST pick different hosts for playbooks that rename the host. If you
e.g. attempt to run Cassandra and k8s on the same 3 machines, the
hostnames will be overwritten by the second installation playbook,
breaking the first.</p>
<p>At the least, we know that the cassandra, kubernetes and restund playbooks are
guilty of hostname manipulation.</p>
</div>
</section>
<section id="authentication">
<h3>Authentication<a class="headerlink" href="#authentication" title="Permalink to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use ssh <em>keys</em>, and the user you login with is either <cite>root</cite> or can elevate to <cite>root</cite> without a password, you don’t need to do anything further to use ansible. If, however, you use password authentication for ssh access, and/or your login user needs a password to become root, see <a class="reference internal" href="ansible-authentication.html#ansible-authentication"><span class="std std-ref">Manage ansible authentication settings</span></a>.</p>
</div>
</section>
</section>
<section id="running-ansible-to-install-software-on-your-machines">
<h2>Running ansible to install software on your machines<a class="headerlink" href="#running-ansible-to-install-software-on-your-machines" title="Permalink to this heading"></a></h2>
<p>You can install kubernetes, cassandra, restund, etc in any order.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case you only have a single network interface with public IPs but wish to protect inter-database communication, you may use the <code class="docutils literal notranslate"><span class="pre">tinc.yml</span></code> playbook to create a private network interface. In this case, ensure tinc is setup BEFORE running any other playbook. See <a class="reference internal" href="ansible-tinc.html#tinc"><span class="std std-ref">tinc</span></a></p>
</div>
<section id="installing-kubernetes">
<h3>Installing kubernetes<a class="headerlink" href="#installing-kubernetes" title="Permalink to this heading"></a></h3>
<p>Kubernetes is installed via ansible.</p>
<p>To install kubernetes:</p>
<p>From <code class="docutils literal notranslate"><span class="pre">wire-server-deploy/ansible</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span><span class="o">.</span><span class="n">ini</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">vv</span>
</pre></div>
</div>
<p>When the playbook finishes correctly (which can take up to 20 minutes), you should have a folder <code class="docutils literal notranslate"><span class="pre">artifacts</span></code> containing a file <code class="docutils literal notranslate"><span class="pre">admin.conf</span></code>. Copy this file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">~/.</span><span class="n">kube</span>
<span class="n">cp</span> <span class="n">artifacts</span><span class="o">/</span><span class="n">admin</span><span class="o">.</span><span class="n">conf</span> <span class="o">~/.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
</pre></div>
</div>
<p>Make sure you can reach the server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">version</span>
</pre></div>
</div>
<p>should give output similar to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Client</span> <span class="n">Version</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">Info</span><span class="p">{</span><span class="n">Major</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">Minor</span><span class="p">:</span><span class="s2">&quot;19&quot;</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">:</span><span class="s2">&quot;v1.19.7&quot;</span><span class="p">,</span> <span class="n">GitCommit</span><span class="p">:</span><span class="s2">&quot;1dd5338295409edcfff11505e7bb246f0d325d15&quot;</span><span class="p">,</span> <span class="n">GitTreeState</span><span class="p">:</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">BuildDate</span><span class="p">:</span><span class="s2">&quot;2021-01-13T13:23:52Z&quot;</span><span class="p">,</span> <span class="n">GoVersion</span><span class="p">:</span><span class="s2">&quot;go1.15.5&quot;</span><span class="p">,</span> <span class="n">Compiler</span><span class="p">:</span><span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="n">Platform</span><span class="p">:</span><span class="s2">&quot;linux/amd64&quot;</span><span class="p">}</span>
<span class="n">Server</span> <span class="n">Version</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">Info</span><span class="p">{</span><span class="n">Major</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">Minor</span><span class="p">:</span><span class="s2">&quot;19&quot;</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">:</span><span class="s2">&quot;v1.19.7&quot;</span><span class="p">,</span> <span class="n">GitCommit</span><span class="p">:</span><span class="s2">&quot;1dd5338295409edcfff11505e7bb246f0d325d15&quot;</span><span class="p">,</span> <span class="n">GitTreeState</span><span class="p">:</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">BuildDate</span><span class="p">:</span><span class="s2">&quot;2021-01-13T13:15:20Z&quot;</span><span class="p">,</span> <span class="n">GoVersion</span><span class="p">:</span><span class="s2">&quot;go1.15.5&quot;</span><span class="p">,</span> <span class="n">Compiler</span><span class="p">:</span><span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="n">Platform</span><span class="p">:</span><span class="s2">&quot;linux/amd64&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="cassandra">
<h3>Cassandra<a class="headerlink" href="#cassandra" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>If you would like to change the name of the cluster, in your
‘hosts.ini’ file, in the <code class="docutils literal notranslate"><span class="pre">[cassandra:vars]</span></code> section, uncomment
the line that changes ‘cassandra_clustername’, and change default
to be the name you want the cluster to have.</p></li>
<li><p>If you want cassandra nodes to talk to each other on a specific
network interface, rather than the one you use to connect via SSH,
In your ‘hosts.ini’ file, in the <code class="docutils literal notranslate"><span class="pre">[all:vars]</span></code> section,
uncomment, and set ‘cassandra_network_interface’ to the name of
the ethernet interface you want cassandra nodes to talk to each
other on. For example:</p></li>
</ul>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[cassandra:vars]</span>
<span class="c1"># cassandra_clustername: default</span>

<span class="k">[all:vars]</span>
<span class="c1">## set to True if using AWS</span>
<span class="na">is_aws_environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">False</span>
<span class="c1">## Set the network interface name for cassandra to bind to if you have more than one network interface</span>
<span class="na">cassandra_network_interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">eth0</span>
</pre></div>
</div>
<p>(see
<a class="reference external" href="https://github.com/wireapp/ansible-cassandra/blob/master/defaults/main.yml">defaults/main.yml</a>
for a full list of variables to change if necessary)</p>
<ul class="simple">
<li><p>Use ansible to deploy Cassandra:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span><span class="o">.</span><span class="n">ini</span> <span class="n">cassandra</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">vv</span>
</pre></div>
</div>
</section>
<section id="elasticsearch">
<h3>ElasticSearch<a class="headerlink" href="#elasticsearch" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>In your ‘hosts.ini’ file, in the <code class="docutils literal notranslate"><span class="pre">[all:vars]</span></code> section, uncomment
and set ‘elasticsearch_network_interface’ to the name of the
interface you want elasticsearch nodes to talk to each other on.</p></li>
<li><p>If you are performing an offline install, or for some other reason
are using an APT mirror other than the default to retrieve
elasticsearch-oss packages from, you need to specify that mirror
by setting ‘es_apt_key’ and ‘es_apt_url’ in the <code class="docutils literal notranslate"><span class="pre">[all:vars]</span></code>
section of your hosts.ini file.</p></li>
</ul>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[all:vars]</span>
<span class="c1"># default first interface on ubuntu on kvm:</span>
<span class="na">elasticsearch_network_interface</span><span class="o">=</span><span class="s">ens3</span>

<span class="c1">## Set these in order to use an APT mirror other than the default.</span>
<span class="c1"># es_apt_key = &quot;https://&lt;mymirror&gt;/linux/ubuntu/gpg&quot;</span>
<span class="c1"># es_apt_url = &quot;deb [trusted=yes] https://&lt;mymirror&gt;/apt bionic stable&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Use ansible and deploy ElasticSearch:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span><span class="o">.</span><span class="n">ini</span> <span class="n">elasticsearch</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">vv</span>
</pre></div>
</div>
</section>
<section id="minio">
<h3>Minio<a class="headerlink" href="#minio" title="Permalink to this heading"></a></h3>
<p>Minio is used for asset storage, in the case that you are not
running on AWS infrastructure, or feel uncomfortable storing assets
in S3 in encrypted form. If you are using S3 instead of Minio, skip
this step.</p>
<ul class="simple">
<li><p>In your ‘hosts.ini’ file, in the <code class="docutils literal notranslate"><span class="pre">[all:vars]</span></code> section, make sure
you set the ‘minio_network_interface’ to the name of the interface
you want minio nodes to talk to each other on. The default from the
playbook is not going to be correct for your machine. For example:</p></li>
<li><p>In your ‘hosts.ini’ file, in the <code class="docutils literal notranslate"><span class="pre">[minio:vars]</span></code> section, ensure you
set minio_access_key and minio_secret key.</p></li>
<li><p>If you intend to use a <code class="docutils literal notranslate"><span class="pre">deep</span> <span class="pre">link</span></code> to configure your clients to
talk to the backend, you need to specify your domain (and optionally
your prefix), so that links to your deep link json file are generated
correctly. By configuring these values, you fill in the blanks of
<code class="docutils literal notranslate"><span class="pre">https://{{</span> <span class="pre">prefix</span> <span class="pre">}}assets.{{</span> <span class="pre">domain</span> <span class="pre">}}</span></code>.</p></li>
</ul>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[minio:vars]</span>
<span class="na">minio_access_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;REPLACE_THIS_WITH_THE_DESIRED_SECRET_KEY&quot;</span>
<span class="na">minio_secret_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;REPLACE_THIS_WITH_THE_DESIRED_SECRET_KEY&quot;</span>
<span class="c1"># if you want to use deep links for client configuration:</span>
<span class="c1">#minio_deeplink_prefix = &quot;&quot;</span>
<span class="c1">#minio_deeplink_domain = &quot;example.com&quot;</span>

<span class="k">[all:vars]</span>
<span class="c1"># Default first interface on ubuntu on kvm:</span>
<span class="na">minio_network_interface</span><span class="o">=</span><span class="s">ens3</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Use ansible, and deploy Minio:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span><span class="o">.</span><span class="n">ini</span> <span class="n">minio</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">vv</span>
</pre></div>
</div>
</section>
<section id="restund">
<h3>Restund<a class="headerlink" href="#restund" title="Permalink to this heading"></a></h3>
<p>For instructions on how to install Restund, see <a class="reference internal" href="restund.html#install-restund"><span class="std std-ref">this page</span></a>.</p>
</section>
<section id="important-checks">
<h3>IMPORTANT checks<a class="headerlink" href="#important-checks" title="Permalink to this heading"></a></h3>
<blockquote>
<div><p>After running the above playbooks, it is important to ensure that everything is setup correctly. Please have a look at the post install checks in the section <a class="reference internal" href="post-install.html#checks"><span class="std std-ref">Verifying your installation</span></a></p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span><span class="o">.</span><span class="n">ini</span> <span class="n">cassandra</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">ntp</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">vv</span>
</pre></div>
</div>
</section>
<section id="installing-helm-charts-prerequisites">
<h3>Installing helm charts - prerequisites<a class="headerlink" href="#installing-helm-charts-prerequisites" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">helm_external.yml</span></code> playbook is used to write or update the IPs of the
databases servers in the <code class="docutils literal notranslate"><span class="pre">values/&lt;database&gt;-external/values.yaml</span></code> files, and
thus make them available for helm and the <code class="docutils literal notranslate"><span class="pre">&lt;database&gt;-external</span></code> charts (e.g.
<code class="docutils literal notranslate"><span class="pre">cassandra-external</span></code>, <code class="docutils literal notranslate"><span class="pre">elasticsearch-external</span></code>, etc).</p>
<p>Due to limitations in the playbook, make sure that you have defined the
network interfaces for each of the database services in your hosts.ini,
even if they are running on the same interface that you connect to via SSH.
In your hosts.ini under <code class="docutils literal notranslate"><span class="pre">[all:vars]</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[all:vars]</span>
<span class="na">minio_network_interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">...</span>
<span class="na">cassandra_network_interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">...</span>
<span class="na">elasticsearch_network_interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">...</span>
<span class="c1"># if you&#39;re using redis external...</span>
<span class="na">redis_network_interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">...</span>
</pre></div>
</div>
<p>Now run the helm_external.yml playbook, to populate network values for helm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span><span class="o">.</span><span class="n">ini</span> <span class="o">-</span><span class="n">vv</span> <span class="o">--</span><span class="n">diff</span> <span class="n">helm_external</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>You can now can install the helm charts.</p>
<section id="next-steps-for-high-available-production-installation">
<h4>Next steps for high-available production installation<a class="headerlink" href="#next-steps-for-high-available-production-installation" title="Permalink to this heading"></a></h4>
<p>Your next step will be <a class="reference internal" href="helm-prod.html#helm-prod"><span class="std std-ref">Installing wire-server (production) components using Helm</span></a></p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="prod-intro.html" class="btn btn-neutral float-left" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="aws-prod.html" class="btn btn-neutral float-right" title="Configuring AWS and wire-server (production) components" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 - 2023, Wire Swiss GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>