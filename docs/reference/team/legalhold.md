# Legal hold

_Author: Tiago Loureiro_

---

Legal hold introduces a new type of device, named _legal hold device_, for the sake of satisfying corporate compliance rules without sacrificing end to end encryption with full transparency.

A _legal hold device_ is a device bound to a team user account but managed outside of the user's control - this is managed by the Legal hold service. The management/operation of said Legal hold service is of the responsibility of the team.

This Backend service makes this type of device available for clients that are visually distinguishable, for full transparency, with a clear, constant indication on the UI. There can be only one such device per user account and they can only be added to the user's device list with the user's consent and confirmed with a password prompt (if they have one - there can be exceptions such as SSO users).

A team admin may ask members of the team to be put under [legal hold](https://en.wikipedia.org/wiki/Legal_hold). Once a person is prompted, they should then verify that the presented signature matches the one generated by the legalhold service to avoid any potential [MITM attack](https://en.wikipedia.org/wiki/Man-in-the-middle_attack).

Conceptually, there are the following actors in this use case:
 * A team admin - someone who requests legal hold for a specific user
 * A team member - the user who will be put under legal hold
 * Backend - serves as intermediary between team members/admin and the Legal hold Service
 * Legal hold service - stores users' Legal hold devices on customers' premises
 * Legal hold device - a user's device that is managed by customers

Once a user accepts the legal hold request, then a device is added to that user's account. This device, also known as legal hold device, is managed by the Legal hold service - only team admins can remove that device from a user's account.

Note that every user talking to someone under legal hold (including, of course, the _self_ user) is made aware by means of displaying a red dot on the user's profile.

## API and flows

Legal hold flow (client perspective)

Request (by admin) for a user to be put under legalhold
```
POST /teams/{tid}/legalhold/{uid}
```
```
201 Created
```

Approval by the user
```
PUT /teams/{tid}/legalhold/{uid}/approve
{
  "password": <user's password> # optional if the user has no set password
}
```
```
200 OK
```

Deletion by an admin
```
DELETE /teams/{tid}/legalhold/{uid}
{
  "password": <admin's password> # optional if the admin has no set password
}
```
```
200 OK
```

Get Legal hold status for team members

```
GET /team/{tid}/members
```
```
200 OK
...
{
    "members": [{
        "user": member used id,
        ...
        "legalhold_status": "disabled" | "enabled", <-- new field
        ...
    }
}
```

![LHFlow](https://user-images.githubusercontent.com/1105323/61390098-6bf34800-a8ba-11e9-8ba7-e0759b22a773.png)
<details>
title: Legal Hold Flow (client perspective)
=: Activation

Admin Panel -> Backend: Activate LH for Alice

Backend -> LegalHold Service: Request to create Cryptobox for Alice (does NOT include scoped token)

LegalHold Service --> Backend: Respond with Public Key etc. for Device

Backend -> Admin Panel: LH for Alice is PENDING
Backend --> Alice's Client: (Async) Request Approval for LH (includes device fingerprint)

Alice's Client -> Backend: Alice APPROVES LH

Backend -> LegalHold Service: Send scoped access_token
Backend -> Backend: Add Compliance Device to Alice
Backend -> Admin Panel: LH for Alice is ACTIVE

=: Deactivation

Admin Panel -> Backend: Deactivate LH for Alice
Backend -> Backend: Remove Compliance Device from Alice; revoke access token.
</details>

## Events

New legalhold request event:
```
{ "type": "user.legalhold-request"
, "id": UserID of the one for whom LH is being requested
, "last_prekey": Last-prekey of the legal hold device
, "client": {"id": Client ID of the legalhold device}
}
```
New legalhold enabled event:
```
{ "type": "user.legalhold-enable"
, "id": UserID for whom LH was enabled
}
```
New legalhold disabled event:
```
{ "type": "user.legalhold-disable"
, "id": UserID for whom LH was disabled
}
```

These events are sent to the user, all team members (including admins) and connections.
