Refactor user provisioning in spar; more integration tests
